<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Hexo</title>

  <!-- keywords -->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="杜鹏之家">
<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/11/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="杜鹏之家">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="mr.杜">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.ico">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  

  
<script src="//cdn.bootcss.com/require.js/2.3.2/require.min.js"></script>

  
<script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>


  
<meta name="generator" content="Hexo 6.2.0"></head>
<body>
  <div id="container">
    <div id="particles-js"></div>
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
				<img lazy-src="https://img1.baidu.com/it/u=412709218,617594518&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=504&amp;h=500" class="js-avatar">
			
		</a>

		<hgroup>
			<h1 class="header-author"><a href="/">mr.杜</a></h1>
		</hgroup>

		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">Home</a></li>
				        
							<li><a href="/archives">Archives</a></li>
				        
						</ul>
					</nav>
					<nav class="half-header-menu">
						<a class="hide">Home</a>
						<a>Tags</a>
						<a>Links</a>
						<a>About</a>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
						<!-- music -->
						
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Event-Loop/" style="font-size: 10px;">Event Loop</a> <a href="/tags/Graphviz/" style="font-size: 10px;">Graphviz</a> <a href="/tags/Mock/" style="font-size: 10px;">Mock</a> <a href="/tags/Promise/" style="font-size: 10px;">Promise</a> <a href="/tags/RESTful/" style="font-size: 10px;">RESTful</a> <a href="/tags/React/" style="font-size: 19.29px;">React</a> <a href="/tags/Redux/" style="font-size: 11.43px;">Redux</a> <a href="/tags/async-await/" style="font-size: 10px;">async/await</a> <a href="/tags/css/" style="font-size: 13.57px;">css</a> <a href="/tags/echart/" style="font-size: 10px;">echart</a> <a href="/tags/es6/" style="font-size: 16.43px;">es6</a> <a href="/tags/eslint/" style="font-size: 10px;">eslint</a> <a href="/tags/git/" style="font-size: 15.71px;">git</a> <a href="/tags/glup/" style="font-size: 10.71px;">glup</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/html/" style="font-size: 14.29px;">html</a> <a href="/tags/http/" style="font-size: 17.14px;">http</a> <a href="/tags/javascript/" style="font-size: 18.57px;">javascript</a> <a href="/tags/mongodb/" style="font-size: 10px;">mongodb</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/nginx/" style="font-size: 10.71px;">nginx</a> <a href="/tags/nodejs/" style="font-size: 12.86px;">nodejs</a> <a href="/tags/python/" style="font-size: 10.71px;">python</a> <a href="/tags/qiankun/" style="font-size: 10px;">qiankun</a> <a href="/tags/react/" style="font-size: 10px;">react</a> <a href="/tags/serveless/" style="font-size: 10px;">serveless</a> <a href="/tags/typescript/" style="font-size: 12.14px;">typescript</a> <a href="/tags/vs-code/" style="font-size: 11.43px;">vs code</a> <a href="/tags/vue/" style="font-size: 20px;">vue</a> <a href="/tags/vue3/" style="font-size: 10px;">vue3</a> <a href="/tags/webpack/" style="font-size: 17.86px;">webpack</a> <a href="/tags/xml/" style="font-size: 10px;">xml</a> <a href="/tags/%E4%BC%98%E5%8C%96/" style="font-size: 13.57px;">优化</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 10.71px;">前端</a> <a href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/" style="font-size: 15px;">小程序</a> <a href="/tags/%E6%8A%93%E5%8C%85/" style="font-size: 10px;">抓包</a> <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 10px;">操作系统</a> <a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 10px;">正则表达式</a> <a href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/" style="font-size: 12.86px;">浏览器</a> <a href="/tags/%E7%A7%BB%E5%8A%A8%E7%AB%AF/" style="font-size: 10.71px;">移动端</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 10px;">算法</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 13.57px;">设计模式</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://github.com/">github</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">I&#39;m a developer.</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="https://img1.baidu.com/it/u=412709218,617594518&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=504&amp;h=500" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author"></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">Home</a></li>
		        
					<li><a href="/archives">Archives</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-nodejs/express" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/06/07/nodejs/express/" class="article-date">
  	<time datetime="2019-06-06T18:16:34.000Z" itemprop="datePublished">2019-06-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/07/nodejs/express/">
        node-express框架总结
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h2><blockquote>
<p>官网 <a target="_blank" rel="noopener" href="http://expressjs.com/zh-cn/">http://expressjs.com/zh-cn/</a></p>
</blockquote>
<blockquote>
<p><code>Express</code>是目前最流行的基于Node.js的Web开发框架，可以快速地搭建一个完整功能的网站</p>
</blockquote>
<p><strong>环境搭建</strong></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://www.expressjs.com.cn/starter/generator.html">http://www.expressjs.com.cn/starter/generator.html</a></p>
</blockquote>
<blockquote>
<p>通过应用生成器工具 <code>express-generator</code>可以快速创建一个应用的骨架</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install express-generator -g</span><br></pre></td></tr></table></figure>

<h2 id="二、运行原理"><a href="#二、运行原理" class="headerlink" title="二、运行原理"></a>二、运行原理</h2><p><strong>底层：http模块</strong></p>
<blockquote>
<p>Express框架建立在node.js内置的http模块上。http模块生成服务器的原始代码如下</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var http = require(&quot;http&quot;);</span><br><span class="line"></span><br><span class="line">var app = http.createServer(function(request, response) &#123;</span><br><span class="line">  response.writeHead(200, &#123;&quot;Content-Type&quot;: &quot;text/plain&quot;&#125;);</span><br><span class="line">  response.end(&quot;Hello world!&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(3000, &quot;localhost&quot;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Express框架的核心是对http模块的再包装。上面的代码用Express改写如下</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var express = require(&#x27;express&#x27;);</span><br><span class="line">var app = express();</span><br><span class="line"></span><br><span class="line">app.get(&#x27;/&#x27;, function (req, res) &#123;</span><br><span class="line">  res.send(&#x27;Hello world!&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(3000);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Express框架等于在http模块之上，加了一个中间层</p>
</blockquote>
<p><strong>什么是中间件</strong></p>
<blockquote>
<ul>
<li>简单说，中间件（middleware）就是处理HTTP请求的函数。它最大的特点就是，一个中间件处理完，再传递给下一个中间件。App实例在运行过程中，会调用一系列的中间件</li>
<li>每个中间件可以从App实例，接收三个参数，依次为request对象（代表HTTP请求）、response对象（代表HTTP回应），next回调函数（代表下一个中间件）。每个中间件都可以对HTTP请求（request对象）进行加工，并且决定是否调用next方法，将request对象再传给下一个中间件。</li>
</ul>
</blockquote>
<ul>
<li>一个不进行任何操作、只传递<code>request</code>对象的中间件，就是下面这样</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function uselessMiddleware(req, res, next) &#123;</span><br><span class="line">  next();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>上面代码的next就是下一个中间件。如果它带有参数，则代表抛出一个错误，参数为错误文本</li>
<li>抛出错误以后，后面的中间件将不再执行，直到发现一个错误处理函数为止</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function uselessMiddleware(req, res, next) &#123;</span><br><span class="line">  next(&#x27;出错了！&#x27;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="三、use方法"><a href="#三、use方法" class="headerlink" title="三、use方法"></a>三、use方法</h2><blockquote>
<p>use是express注册中间件的方法，它返回一个函数。下面是一个连续调用两个中间件的例子</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">var express = require(&quot;express&quot;);</span><br><span class="line">var http = require(&quot;http&quot;);</span><br><span class="line"></span><br><span class="line">var app = express();</span><br><span class="line"></span><br><span class="line">app.use(function(request, response, next) &#123;</span><br><span class="line">  console.log(&quot;In comes a &quot; + request.method + &quot; to &quot; + request.url);</span><br><span class="line">  next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(function(request, response) &#123;</span><br><span class="line">  response.writeHead(200, &#123; &quot;Content-Type&quot;: &quot;text/plain&quot; &#125;);</span><br><span class="line">  response.end(&quot;Hello world!\n&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">http.createServer(app).listen(1337);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上面代码使用app.use方法，注册了两个中间件。收到HTTP请求后，先调用第一个中间件，在控制台输出一行信息，然后通过next方法，将执行权传给第二个中间件，输出HTTP回应。由于第二个中间件没有调用next方法，所以request对象就不再向后传递了</p>
</blockquote>
<ul>
<li>use方法内部可以对访问路径进行判断，据此就能实现简单的路由，根据不同的请求网址，返回不同的网页内容</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">var express = require(&quot;express&quot;);</span><br><span class="line">var http = require(&quot;http&quot;);</span><br><span class="line"></span><br><span class="line">var app = express();</span><br><span class="line"></span><br><span class="line">app.use(function(request, response, next) &#123;</span><br><span class="line">  if (request.url == &quot;/&quot;) &#123;</span><br><span class="line">    response.writeHead(200, &#123; &quot;Content-Type&quot;: &quot;text/plain&quot; &#125;);</span><br><span class="line">    response.end(&quot;Welcome to the homepage!\n&quot;);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    next();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(function(request, response, next) &#123;</span><br><span class="line">  if (request.url == &quot;/about&quot;) &#123;</span><br><span class="line">    response.writeHead(200, &#123; &quot;Content-Type&quot;: &quot;text/plain&quot; &#125;);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    next();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(function(request, response) &#123;</span><br><span class="line">  response.writeHead(404, &#123; &quot;Content-Type&quot;: &quot;text/plain&quot; &#125;);</span><br><span class="line">  response.end(&quot;404 error!\n&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">http.createServer(app).listen(1337);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上面代码通过<code>request.url</code>属性，判断请求的网址，从而返回不同的内容。注意，<code>app.use</code>方法一共登记了三个中间件，只要请求路径匹配，就不会将执行权交给下一个中间件。因此，最后一个中间件会返回<code>404</code>错误，即前面的中间件都没匹配请求路径，找不到所要请求的资源</p>
</blockquote>
<ul>
<li>除了在回调函数内部判断请求的网址，<code>use</code>方法也允许将请求网址写在第一个参数。这代表，只有请求路径匹配这个参数，后面的中间件才会生效。无疑，这样写更加清晰和方便</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 只对根目录的请求，调用某个中间件</span><br><span class="line">app.use(&#x27;/path&#x27;, someMiddleware);</span><br></pre></td></tr></table></figure>

<ul>
<li>因此，上面的代码可以写成下面的样子</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ar express = require(&quot;express&quot;);</span><br><span class="line">var http = require(&quot;http&quot;);</span><br><span class="line"></span><br><span class="line">var app = express();</span><br><span class="line"></span><br><span class="line">app.use(&quot;/home&quot;, function(request, response, next) &#123;</span><br><span class="line">  response.writeHead(200, &#123; &quot;Content-Type&quot;: &quot;text/plain&quot; &#125;);</span><br><span class="line">  response.end(&quot;Welcome to the homepage!\n&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(&quot;/about&quot;, function(request, response, next) &#123;</span><br><span class="line">  response.writeHead(200, &#123; &quot;Content-Type&quot;: &quot;text/plain&quot; &#125;);</span><br><span class="line">  response.end(&quot;Welcome to the about page!\n&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(function(request, response) &#123;</span><br><span class="line">  response.writeHead(404, &#123; &quot;Content-Type&quot;: &quot;text/plain&quot; &#125;);</span><br><span class="line">  response.end(&quot;404 error!\n&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">http.createServer(app).listen(1337)</span><br></pre></td></tr></table></figure>

<h2 id="四、Express的方法"><a href="#四、Express的方法" class="headerlink" title="四、Express的方法"></a>四、Express的方法</h2><p><strong>all方法和HTTP动词方法</strong></p>
<blockquote>
<p>针对不同的请求，Express提供了use方法的一些别名。比如，上面代码也可以用别名的形式来写</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">var express = require(&quot;express&quot;);</span><br><span class="line">var http = require(&quot;http&quot;);</span><br><span class="line">var app = express();</span><br><span class="line"></span><br><span class="line">app.all(&quot;*&quot;, function(request, response, next) &#123;</span><br><span class="line">  response.writeHead(200, &#123; &quot;Content-Type&quot;: &quot;text/plain&quot; &#125;);</span><br><span class="line">  next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(&quot;/&quot;, function(request, response) &#123;</span><br><span class="line">  response.end(&quot;Welcome to the homepage!&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(&quot;/about&quot;, function(request, response) &#123;</span><br><span class="line">  response.end(&quot;Welcome to the about page!&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(&quot;*&quot;, function(request, response) &#123;</span><br><span class="line">  response.end(&quot;404!&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">http.createServer(app).listen(1337);</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>上面代码的all方法表示，所有请求都必须通过该中间件，参数中的“*”表示对所有路径有效。get方法则是只有GET动词的HTTP请求通过该中间件，它的第一个参数是请求的路径。由于get方法的回调函数没有调用next方法，所以只要有一个中间件被调用了，后面的中间件就不会再被调用了</li>
<li>除了get方法以外，Express还提供post、put、delete方法，即HTTP动词都是Express的方法</li>
</ul>
</blockquote>
<ul>
<li>除了get方法以外，Express还提供post、put、delete方法，即HTTP动词都是Express的方法</li>
<li>这些方法的第一个参数，都是请求的路径。除了绝对匹配以外，Express允许模式匹配</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.get(&quot;/hello/:who&quot;, function(req, res) &#123;</span><br><span class="line">  res.end(&quot;Hello, &quot; + req.params.who + &quot;.&quot;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="五、set方法"><a href="#五、set方法" class="headerlink" title="五、set方法"></a>五、set方法</h2><blockquote>
<p>set方法用于指定变量的值</p>
</blockquote>
<ul>
<li><p>使用set方法，为系统变量“views”和“view engine”指定值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.set(&quot;views&quot;, __dirname + &quot;/views&quot;);</span><br><span class="line"></span><br><span class="line">app.set(&quot;view engine&quot;, &quot;jade&quot;);</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="六、response对象"><a href="#六、response对象" class="headerlink" title="六、response对象"></a>六、response对象</h2><p><strong>（1）response.redirect方法</strong></p>
<blockquote>
<p>response.redirect方法允许网址的重定向</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">response.redirect(&quot;/hello/anime&quot;);</span><br><span class="line">response.redirect(&quot;http://www.example.com&quot;);</span><br><span class="line">response.redirect(301, &quot;http://www.example.com&quot;);</span><br></pre></td></tr></table></figure>

<p><strong>（2）response.sendFile方法</strong></p>
<blockquote>
<p>response.sendFile方法用于发送文件</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response.sendFile(&quot;/path/to/anime.mp4&quot;);</span><br></pre></td></tr></table></figure>

<p><strong>（3）response.render方法</strong></p>
<blockquote>
<p>response.render方法用于渲染网页模板。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//  使用render方法，将message变量传入index模板，渲染成HTML网页</span><br><span class="line">app.get(&quot;/&quot;, function(request, response) &#123;</span><br><span class="line">  response.render(&quot;index&quot;, &#123; message: &quot;Hello World&quot; &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="七、requst对象"><a href="#七、requst对象" class="headerlink" title="七、requst对象"></a>七、requst对象</h2><p><strong>（1）request.ip</strong></p>
<blockquote>
<p>request.ip属性用于获得HTTP请求的IP地址</p>
</blockquote>
<p><strong>（2）request.files</strong></p>
<blockquote>
<p>request.files用于获取上传的文件</p>
</blockquote>
<h2 id="八、搭建HTTPs服务器"><a href="#八、搭建HTTPs服务器" class="headerlink" title="八、搭建HTTPs服务器"></a>八、搭建HTTPs服务器</h2><blockquote>
<p>使用Express搭建HTTPs加密服务器，也很简单</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">var fs = require(&#x27;fs&#x27;);</span><br><span class="line">var options = &#123;</span><br><span class="line">  key: fs.readFileSync(&#x27;E:/ssl/myserver.key&#x27;),</span><br><span class="line">  cert: fs.readFileSync(&#x27;E:/ssl/myserver.crt&#x27;),</span><br><span class="line">  passphrase: &#x27;1234&#x27;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">var https = require(&#x27;https&#x27;);</span><br><span class="line">var express = require(&#x27;express&#x27;);</span><br><span class="line">var app = express();</span><br><span class="line"></span><br><span class="line">app.get(&#x27;/&#x27;, function(req, res)&#123;</span><br><span class="line">  res.send(&#x27;Hello World Expressjs&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">var server = https.createServer(options, app);</span><br><span class="line">server.listen(8084);</span><br><span class="line">console.log(&#x27;Server is running on port 8084&#x27;);</span><br></pre></td></tr></table></figure>

<h2 id="九、静态网页模板"><a href="#九、静态网页模板" class="headerlink" title="九、静态网页模板"></a>九、静态网页模板</h2><blockquote>
<ul>
<li>在项目目录之中，建立一个子目录views，用于存放网页模板</li>
<li>假定这个项目有三个路径：根路径（&#x2F;）、自我介绍（&#x2F;about）和文章（&#x2F;article）。那么，app.js可以这样写</li>
</ul>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// 向服务器发送信息的方法，从send变成了sendfile，后者专门用于发送文件</span><br><span class="line">var express = require(&#x27;express&#x27;);</span><br><span class="line">var app = express();</span><br><span class="line"> </span><br><span class="line">app.get(&#x27;/&#x27;, function(req, res) &#123;</span><br><span class="line">   res.sendfile(&#x27;./views/index.html&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">app.get(&#x27;/about&#x27;, function(req, res) &#123;</span><br><span class="line">   res.sendfile(&#x27;./views/about.html&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">app.get(&#x27;/article&#x27;, function(req, res) &#123;</span><br><span class="line">   res.sendfile(&#x27;./views/article.html&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">app.listen(3000);</span><br></pre></td></tr></table></figure>

<h2 id="十、动态网页模板"><a href="#十、动态网页模板" class="headerlink" title="十、动态网页模板"></a>十、动态网页模板</h2><p><strong>安装模板引擎</strong></p>
<blockquote>
<p>Express支持多种模板引擎，这里采用Handlebars模板引擎的服务器端版本hbs模板引擎</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hbs --save-dev</span><br></pre></td></tr></table></figure>

<ul>
<li>安装模板引擎之后，就要改写app.js</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// app.js文件</span><br><span class="line"></span><br><span class="line">var express = require(&#x27;express&#x27;);</span><br><span class="line">var app = express();</span><br><span class="line"></span><br><span class="line">// 加载hbs模块</span><br><span class="line">var hbs = require(&#x27;hbs&#x27;);</span><br><span class="line"></span><br><span class="line">// 指定模板文件的后缀名为html</span><br><span class="line">app.set(&#x27;view engine&#x27;, &#x27;html&#x27;);</span><br><span class="line"></span><br><span class="line">// 运行hbs模块</span><br><span class="line">app.engine(&#x27;html&#x27;, hbs.__express);</span><br><span class="line"></span><br><span class="line">app.get(&#x27;/&#x27;, function (req, res)&#123;</span><br><span class="line">	res.render(&#x27;index&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(&#x27;/about&#x27;, function(req, res) &#123;</span><br><span class="line">	res.render(&#x27;about&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(&#x27;/article&#x27;, function(req, res) &#123;</span><br><span class="line">	res.render(&#x27;article&#x27;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上面代码改用render方法，对网页模板进行渲染。render方法的参数就是模板的文件名，默认放在子目录views之中，后缀名已经在前面指定为html，这里可以省略。所以，res.render(‘index’) 就是指，把子目录views下面的index.html文件，交给模板引擎hbs渲染</p>
</blockquote>
<h2 id="十一、新建数据脚本"><a href="#十一、新建数据脚本" class="headerlink" title="十一、新建数据脚本"></a>十一、新建数据脚本</h2><blockquote>
<ul>
<li>渲染是指将数据代入模板的过程。实际运用中，数据都是保存在数据库之中的，这里为了简化问题，假定数据保存在一个脚本文件中</li>
<li>在项目目录中，新建一个文件blog.js，用于存放数据。blog.js的写法符合CommonJS规范，使得它可以被require语句加载</li>
</ul>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// blog.js文件</span><br><span class="line"></span><br><span class="line">var entries = [</span><br><span class="line">	&#123;&quot;id&quot;:1, &quot;title&quot;:&quot;第一篇&quot;, &quot;body&quot;:&quot;正文&quot;, &quot;published&quot;:&quot;6/2/2013&quot;&#125;,</span><br><span class="line">	&#123;&quot;id&quot;:2, &quot;title&quot;:&quot;第二篇&quot;, &quot;body&quot;:&quot;正文&quot;, &quot;published&quot;:&quot;6/3/2013&quot;&#125;,</span><br><span class="line">	&#123;&quot;id&quot;:3, &quot;title&quot;:&quot;第三篇&quot;, &quot;body&quot;:&quot;正文&quot;, &quot;published&quot;:&quot;6/4/2013&quot;&#125;,</span><br><span class="line">	&#123;&quot;id&quot;:4, &quot;title&quot;:&quot;第四篇&quot;, &quot;body&quot;:&quot;正文&quot;, &quot;published&quot;:&quot;6/5/2013&quot;&#125;,</span><br><span class="line">	&#123;&quot;id&quot;:5, &quot;title&quot;:&quot;第五篇&quot;, &quot;body&quot;:&quot;正文&quot;, &quot;published&quot;:&quot;6/10/2013&quot;&#125;,</span><br><span class="line">	&#123;&quot;id&quot;:6, &quot;title&quot;:&quot;第六篇&quot;, &quot;body&quot;:&quot;正文&quot;, &quot;published&quot;:&quot;6/12/2013&quot;&#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">exports.getBlogEntries = function ()&#123;</span><br><span class="line">   return entries;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">exports.getBlogEntry = function (id)&#123;</span><br><span class="line">   for(var i=0; i &lt; entries.length; i++)&#123;</span><br><span class="line">      if(entries[i].id == id) return entries[i];</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="十二、新建网页模板"><a href="#十二、新建网页模板" class="headerlink" title="十二、新建网页模板"></a>十二、新建网页模板</h2><blockquote>
<p>接着，新建模板文件<code>index.html</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- views/index.html文件 --&gt;</span><br><span class="line"></span><br><span class="line">&lt;h1&gt;文章列表&lt;/h1&gt;</span><br><span class="line"> </span><br><span class="line">&#123;&#123;#each entries&#125;&#125;</span><br><span class="line">   &lt;p&gt;</span><br><span class="line">      &lt;a href=&quot;/article/&#123;&#123;id&#125;&#125;&quot;&gt;&#123;&#123;title&#125;&#125;&lt;/a&gt;&lt;br/&gt;</span><br><span class="line">      Published: &#123;&#123;published&#125;&#125;</span><br><span class="line">   &lt;/p&gt;</span><br><span class="line">&#123;&#123;/each&#125;&#125;</span><br><span class="line">&lt;!-- views/about.html文件 --&gt;</span><br><span class="line"></span><br><span class="line">&lt;h1&gt;自我介绍&lt;/h1&gt;</span><br><span class="line"> </span><br><span class="line">&lt;p&gt;正文&lt;/p&gt;</span><br><span class="line">&lt;!-- views/article.html文件 --&gt;</span><br><span class="line"></span><br><span class="line">&lt;h1&gt;&#123;&#123;blog.title&#125;&#125;&lt;/h1&gt;</span><br><span class="line">Published: &#123;&#123;blog.published&#125;&#125;</span><br><span class="line"> </span><br><span class="line">&lt;p/&gt;</span><br><span class="line"> </span><br><span class="line">&#123;&#123;blog.body&#125;&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以看到，上面三个模板文件都只有网页主体。因为网页布局是共享的，所以布局的部分可以单独新建一个文件<code>layout.html</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- views/layout.html文件 --&gt;</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line"> </span><br><span class="line">&lt;head&gt;</span><br><span class="line">   &lt;title&gt;&#123;&#123;title&#125;&#125;&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"> </span><br><span class="line">&lt;body&gt;</span><br><span class="line"> </span><br><span class="line">	&#123;&#123;&#123;body&#125;&#125;&#125;</span><br><span class="line"> </span><br><span class="line">   &lt;footer&gt;</span><br><span class="line">      &lt;p&gt;</span><br><span class="line">         &lt;a href=&quot;/&quot;&gt;首页&lt;/a&gt; - &lt;a href=&quot;/about&quot;&gt;自我介绍&lt;/a&gt;</span><br><span class="line">      &lt;/p&gt;</span><br><span class="line">   &lt;/footer&gt;</span><br><span class="line">    </span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h2 id="十三、渲染模板"><a href="#十三、渲染模板" class="headerlink" title="十三、渲染模板"></a>十三、渲染模板</h2><blockquote>
<p>最后，改写app.js文件</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">// app.js文件</span><br><span class="line"></span><br><span class="line">var express = require(&#x27;express&#x27;);</span><br><span class="line">var app = express();</span><br><span class="line"> </span><br><span class="line">var hbs = require(&#x27;hbs&#x27;);</span><br><span class="line"></span><br><span class="line">// 加载数据模块</span><br><span class="line">var blogEngine = require(&#x27;./blog&#x27;);</span><br><span class="line"> </span><br><span class="line">app.set(&#x27;view engine&#x27;, &#x27;html&#x27;);</span><br><span class="line">app.engine(&#x27;html&#x27;, hbs.__express);</span><br><span class="line">app.use(express.bodyParser());</span><br><span class="line"> </span><br><span class="line">app.get(&#x27;/&#x27;, function(req, res) &#123;</span><br><span class="line">   res.render(&#x27;index&#x27;,&#123;title:&quot;最近文章&quot;, entries:blogEngine.getBlogEntries()&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">app.get(&#x27;/about&#x27;, function(req, res) &#123;</span><br><span class="line">   res.render(&#x27;about&#x27;, &#123;title:&quot;自我介绍&quot;&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">app.get(&#x27;/article/:id&#x27;, function(req, res) &#123;</span><br><span class="line">   var entry = blogEngine.getBlogEntry(req.params.id);</span><br><span class="line">   res.render(&#x27;article&#x27;,&#123;title:entry.title, blog:entry&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">app.listen(3000);</span><br></pre></td></tr></table></figure>

<ul>
<li>上面代码中的render方法，现在加入了第二个参数，表示模板变量绑定的数据</li>
</ul>
<h2 id="十四、指定静态文件目录"><a href="#十四、指定静态文件目录" class="headerlink" title="十四、指定静态文件目录"></a>十四、指定静态文件目录</h2><blockquote>
<p>模板文件默认存放在views子目录。这时，如果要在网页中加载静态文件（比如样式表、图片等），就需要另外指定一个存放静态文件的目录</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.use(express.static(&#x27;public&#x27;));</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上面代码在文件app.js之中，指定静态文件存放的目录是public。于是，当浏览器发出非HTML文件请求时，服务器端就到public目录寻找这个文件。比如，浏览器发出如下的样式表请求：</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;link href=&quot;/bootstrap/css/bootstrap.css&quot; rel=&quot;stylesheet&quot;&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>服务器端就到<code>public/bootstrap/css/</code>目录中寻找<code>bootstrap.css</code>文件</li>
</ul>
<h2 id="十五、Express-Router用法"><a href="#十五、Express-Router用法" class="headerlink" title="十五、Express.Router用法"></a>十五、Express.Router用法</h2><blockquote>
<p>从<code>Express 4.0</code>开始，路由器功能成了一个单独的组件<code>Express.Router</code>。它好像小型的<code>express</code>应用程序一样，有自己的<code>use</code>、<code>get</code>、<code>param</code>和<code>route</code>方法</p>
</blockquote>
<p><strong>基本用法</strong></p>
<blockquote>
<p>首先，Express.Router是一个构造函数，调用后返回一个路由器实例。然后，使用该实例的HTTP动词方法，为不同的访问路径，指定回调函数；最后，挂载到某个路径。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">var router = express.Router();</span><br><span class="line"></span><br><span class="line">router.get(&#x27;/&#x27;, function(req, res) &#123;</span><br><span class="line">  res.send(&#x27;首页&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(&#x27;/about&#x27;, function(req, res) &#123;</span><br><span class="line">  res.send(&#x27;关于&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(&#x27;/&#x27;, router);</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>上面代码先定义了两个访问路径，然后将它们挂载到根目录</li>
<li>这种路由器可以自由挂载的做法，为程序带来了更大的灵活性，既可以定义多个路由器实例，也可以为将同一个路由器实例挂载到多个路径。</li>
</ul>
</blockquote>
<h2 id="十六、router-route方法"><a href="#十六、router-route方法" class="headerlink" title="十六、router.route方法"></a>十六、router.route方法</h2><blockquote>
<p>router实例对象的route方法，可以接受访问路径作为参数</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">var router = express.Router();</span><br><span class="line"></span><br><span class="line">router.route(&#x27;/api&#x27;)</span><br><span class="line">	.post(function(req, res) &#123;</span><br><span class="line">		// ...</span><br><span class="line">	&#125;)</span><br><span class="line">	.get(function(req, res) &#123;</span><br><span class="line">		Bear.find(function(err, bears) &#123;</span><br><span class="line">			if (err) res.send(err);</span><br><span class="line">			res.json(bears);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">app.use(&#x27;/&#x27;, router);</span><br></pre></td></tr></table></figure>

<h2 id="十七、router中间件"><a href="#十七、router中间件" class="headerlink" title="十七、router中间件"></a>十七、router中间件</h2><blockquote>
<p>use方法为router对象指定中间件，即在数据正式发给用户之前，对数据进行处理。下面就是一个中间件的例子</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">router.use(function(req, res, next) &#123;</span><br><span class="line">	console.log(req.method, req.url);</span><br><span class="line">	next();	</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>上面代码中，回调函数的next参数，表示接受其他中间件的调用。函数体中的next()，表示将数据传递给下一个中间件</li>
<li>注意，中间件的放置顺序很重要，等同于执行顺序。而且，中间件必须放在HTTP动词方法之前，否则不会执行</li>
</ul>
<h2 id="十八、对路径参数的处理"><a href="#十八、对路径参数的处理" class="headerlink" title="十八、对路径参数的处理"></a>十八、对路径参数的处理</h2><blockquote>
<p>router对象的param方法用于路径参数的处理，可以</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">router.param(&#x27;name&#x27;, function(req, res, next, name) &#123;</span><br><span class="line">	// 对name进行验证或其他处理……</span><br><span class="line">	console.log(name);</span><br><span class="line">	req.name = name;</span><br><span class="line">	next();	</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(&#x27;/hello/:name&#x27;, function(req, res) &#123;</span><br><span class="line">	res.send(&#x27;hello &#x27; + req.name + &#x27;!&#x27;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上面代码中，get方法为访问路径指定了name参数，param方法则是对name参数进行处理。注意，param方法必须放在HTTP动词方法之前</p>
</blockquote>
<h2 id="十九、app-route"><a href="#十九、app-route" class="headerlink" title="十九、app.route"></a>十九、app.route</h2><blockquote>
<ul>
<li>假定app是Express的实例对象，Express 4.0为该对象提供了一个route属性。app.route实际上是express.Router()的缩写形式，直接挂载到根路径</li>
<li>因此，对同一个路径指定get和post方法的回调函数，可以写成链式形式</li>
</ul>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">app.route(&#x27;/login&#x27;)</span><br><span class="line">	.get(function(req, res) &#123;</span><br><span class="line">		res.send(&#x27;this is the login form&#x27;);</span><br><span class="line">	&#125;)</span><br><span class="line">	.post(function(req, res) &#123;</span><br><span class="line">		console.log(&#x27;processing&#x27;);</span><br><span class="line">		res.send(&#x27;processing the login form!&#x27;);</span><br><span class="line">	&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="二十、上传文件"><a href="#二十、上传文件" class="headerlink" title="二十、上传文件"></a>二十、上传文件</h2><ul>
<li>首先，在网页插入上传文件的表单</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=&quot;/pictures/upload&quot; method=&quot;POST&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class="line">  Select an image to upload:</span><br><span class="line">  &lt;input type=&quot;file&quot; name=&quot;image&quot;&gt;</span><br><span class="line">  &lt;input type=&quot;submit&quot; value=&quot;Upload Image&quot;&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>然后，服务器脚本建立指向&#x2F;upload目录的路由。这时可以安装multer模块，它提供了上传文件的许多功能</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">var express = require(&#x27;express&#x27;);</span><br><span class="line">var router = express.Router();</span><br><span class="line">var multer = require(&#x27;multer&#x27;);</span><br><span class="line"></span><br><span class="line">var uploading = multer(&#123;</span><br><span class="line">  dest: __dirname + &#x27;../public/uploads/&#x27;,</span><br><span class="line">  // 设定限制，每次最多上传1个文件，文件大小不超过1MB</span><br><span class="line">  limits: &#123;fileSize: 1000000, files:1&#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.post(&#x27;/upload&#x27;, uploading, function(req, res) &#123;</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">module.exports = router</span><br></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nodejs/" rel="tag">nodejs</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a><a class="article-category-link" href="/categories/%E5%90%8E%E7%AB%AF/%E6%A1%86%E6%9E%B6/">框架</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-nodejs/nodejs-websocker与socket.io的区别" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/05/26/nodejs/nodejs-websocker%E4%B8%8Esocket.io%E7%9A%84%E5%8C%BA%E5%88%AB/" class="article-date">
  	<time datetime="2019-05-26T05:16:35.000Z" itemprop="datePublished">2019-05-26</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/26/nodejs/nodejs-websocker%E4%B8%8Esocket.io%E7%9A%84%E5%8C%BA%E5%88%AB/">
        nodejs-websocker与socket.io的区别
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="第一部分-WebSocket"><a href="#第一部分-WebSocket" class="headerlink" title="第一部分 WebSocket"></a>第一部分 WebSocket</h1><h2 id="一、WebSocket-解决了什么问题"><a href="#一、WebSocket-解决了什么问题" class="headerlink" title="一、WebSocket 解决了什么问题"></a>一、WebSocket 解决了什么问题</h2><ul>
<li>客户端(浏览器)和服务器端进行通信，只能由客户端发起<code>ajax</code>请求，才能进行通信，服务器端无法主动向客户端推送信息</li>
<li>当出现类似体育赛事、聊天室、实时位置之类的场景时，客户端要获取服务器端的变化，就只能通过轮询(定时请求)来了解服务器端有没有新的信息变化</li>
</ul>
<p>轮询效率低，非常浪费资源(需要不断发送请求，不停链接服务器)</p>
<blockquote>
<p><code>WebSocket</code>的出现，让服务器端可以主动向服务器端发送信息，使得浏览器具备了实时双向通信的能力,这就是<code>WebSocket</code>解决的问题</p>
</blockquote>
<p><strong>一个超简单例子</strong></p>
<blockquote>
<p>新建一个<code>html</code>文件，将本栗子找个地方跑一下试试，即可轻松入门<code>WebSocket</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">function socketConnect(url) &#123;</span><br><span class="line">    // 客户端与服务器进行连接</span><br><span class="line">    let ws = new WebSocket(url); // 返回`WebSocket`对象，赋值给变量ws</span><br><span class="line">    // 连接成功回调</span><br><span class="line">    ws.onopen = e =&gt; &#123;</span><br><span class="line">        console.log(&#x27;连接成功&#x27;, e)</span><br><span class="line">        ws.send(&#x27;我发送消息给服务端&#x27;); // 客户端与服务器端通信</span><br><span class="line">    &#125;</span><br><span class="line">    // 监听服务器端返回的信息</span><br><span class="line">    ws.onmessage = e =&gt; &#123;</span><br><span class="line">        console.log(&#x27;服务器端返回：&#x27;, e.data)</span><br><span class="line">        // do something</span><br><span class="line">    &#125;</span><br><span class="line">    return ws; // 返回websocket对象</span><br><span class="line">&#125;</span><br><span class="line">let wsValue = socketConnect(&#x27;ws://121.40.165.18:8800&#x27;); // websocket对象</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上述栗子中<code>WebSocket</code>的接口地址出自：<code>WebSocket</code> 在线测试，在开发的时候也可以用于测试后端给的地址是否可用</p>
</blockquote>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/389.png" alt="img"></p>
<h2 id="二、webSocket的class类"><a href="#二、webSocket的class类" class="headerlink" title="二、webSocket的class类"></a>二、webSocket的class类</h2><blockquote>
<p>当项目中很多地方使用<code>WebSocket</code>，把它封成一个<code>class</code>类，是更好的选择</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">class WebSocketClass &#123;</span><br><span class="line">    /**</span><br><span class="line">     * @description: 初始化实例属性，保存参数</span><br><span class="line">     * @param &#123;String&#125; url ws的接口</span><br><span class="line">     * @param &#123;Function&#125; msgCallback 服务器信息的回调传数据给函数</span><br><span class="line">     * @param &#123;String&#125; name 可选值 用于区分ws，用于debugger</span><br><span class="line">     */</span><br><span class="line">    constructor(url, msgCallback, name = &#x27;default&#x27;) &#123;</span><br><span class="line">        this.url = url;</span><br><span class="line">        this.msgCallback = msgCallback;</span><br><span class="line">        this.name = name;</span><br><span class="line">        this.ws = null;  // websocket对象</span><br><span class="line">        this.status = null; // websocket是否关闭</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * @description: 初始化 连接websocket或重连webSocket时调用</span><br><span class="line">     * @param &#123;*&#125; 可选值 要传的数据</span><br><span class="line">     */</span><br><span class="line">    connect(data) &#123;</span><br><span class="line">        // 新建 WebSocket 实例</span><br><span class="line">        this.ws = new WebSocket(this.url);</span><br><span class="line">        this.ws.onopen = e =&gt; &#123;</span><br><span class="line">            // 连接ws成功回调</span><br><span class="line">            this.status = &#x27;open&#x27;;</span><br><span class="line">            console.log(`$&#123;this.name&#125;连接成功`, e)</span><br><span class="line">            // this.heartCheck();</span><br><span class="line">            if (data !== undefined) &#123;</span><br><span class="line">                // 有要传的数据,就发给后端</span><br><span class="line">                return this.ws.send(data);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // 监听服务器端返回的信息</span><br><span class="line">        this.ws.onmessage = e =&gt; &#123;</span><br><span class="line">            // 把数据传给回调函数，并执行回调</span><br><span class="line">            // if (e.data === &#x27;pong&#x27;) &#123;</span><br><span class="line">            //     this.pingPong = &#x27;pong&#x27;; // 服务器端返回pong,修改pingPong的状态</span><br><span class="line">            // &#125;</span><br><span class="line">            return this.msgCallback(e.data);</span><br><span class="line">        &#125;</span><br><span class="line">        // ws关闭回调</span><br><span class="line">        this.ws.onclose = e =&gt; &#123;</span><br><span class="line">            this.closeHandle(e); // 判断是否关闭</span><br><span class="line">        &#125;</span><br><span class="line">        // ws出错回调</span><br><span class="line">        this.onerror = e =&gt; &#123;</span><br><span class="line">            this.closeHandle(e); // 判断是否关闭</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // heartCheck() &#123;</span><br><span class="line">    //     // 心跳机制的时间可以自己与后端约定</span><br><span class="line">    //     this.pingPong = &#x27;ping&#x27;; // ws的心跳机制状态值</span><br><span class="line">    //     this.pingInterval = setInterval(() =&gt; &#123;</span><br><span class="line">    //         if (this.ws.readyState === 1) &#123;</span><br><span class="line">    //             // 检查ws为链接状态 才可发送</span><br><span class="line">    //             this.ws.send(&#x27;ping&#x27;); // 客户端发送ping</span><br><span class="line">    //         &#125;</span><br><span class="line">    //     &#125;, 10000)</span><br><span class="line">    //     this.pongInterval = setInterval(() =&gt; &#123;</span><br><span class="line">    //         this.pingPong = false;</span><br><span class="line">    //         if (this.pingPong === &#x27;ping&#x27;) &#123;</span><br><span class="line">    //             this.closeHandle(&#x27;pingPong没有改变为pong&#x27;); // 没有返回pong 重启webSocket</span><br><span class="line">    //         &#125;</span><br><span class="line">    //         // 重置为ping 若下一次 ping 发送失败 或者pong返回失败(pingPong不会改成pong)，将重启</span><br><span class="line">    //         console.log(&#x27;返回pong&#x27;)</span><br><span class="line">    //         this.pingPong = &#x27;ping&#x27;</span><br><span class="line">    //     &#125;, 20000)</span><br><span class="line">    // &#125;</span><br><span class="line">    // 发送信息给服务器</span><br><span class="line">    sendHandle(data) &#123;</span><br><span class="line">        console.log(`$&#123;this.name&#125;发送消息给服务器:`, data)</span><br><span class="line">        return this.ws.send(data);</span><br><span class="line">    &#125;</span><br><span class="line">    closeHandle(e = &#x27;err&#x27;) &#123;</span><br><span class="line">        // 因为webSocket并不稳定，规定只能手动关闭(调closeMyself方法)，否则就重连</span><br><span class="line">        if (this.status !== &#x27;close&#x27;) &#123;</span><br><span class="line">            console.log(`$&#123;this.name&#125;断开，重连websocket`, e)</span><br><span class="line">            // if (this.pingInterval !== undefined &amp;&amp; this.pongInterval !== undefined) &#123;</span><br><span class="line">            //     // 清除定时器</span><br><span class="line">            //     clearInterval(this.pingInterval);</span><br><span class="line">            //     clearInterval(this.pongInterval);</span><br><span class="line">            // &#125;</span><br><span class="line">            this.connect(); // 重连</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            console.log(`$&#123;this.name&#125;websocket手动关闭`)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // 手动关闭WebSocket</span><br><span class="line">    closeMyself() &#123;</span><br><span class="line">        console.log(`关闭$&#123;this.name&#125;`)</span><br><span class="line">        this.status = &#x27;close&#x27;;</span><br><span class="line">        return this.ws.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">function someFn(data) &#123;</span><br><span class="line">    console.log(&#x27;接收服务器消息的回调：&#x27;, data);</span><br><span class="line">&#125;</span><br><span class="line">// const wsValue = new WebSocketClass(&#x27;ws://121.40.165.18:8800&#x27;, someFn, &#x27;wsName&#x27;); // 这个链接一天只能发送消息50次</span><br><span class="line">const wsValue = new WebSocketClass(&#x27;wss://echo.websocket.org&#x27;, someFn, &#x27;wsName&#x27;); // 阮一峰老师教程链接</span><br><span class="line">wsValue.connect(&#x27;立即与服务器通信&#x27;); // 连接服务器</span><br><span class="line">// setTimeout(() =&gt; &#123;</span><br><span class="line">//     wsValue.sendHandle(&#x27;传消息给服务器&#x27;)</span><br><span class="line">// &#125;, 1000);</span><br><span class="line">// setTimeout(() =&gt; &#123;</span><br><span class="line">//     wsValue.closeMyself(); // 关闭ws</span><br><span class="line">// &#125;, 10000)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以把<code>class</code>放在一个js文件里面,<code>export</code>出去，然后在需要用的地方再<code>import</code>进来，把参数传进去就可以用了</p>
</blockquote>
<h2 id="三、WebSocket不稳定"><a href="#三、WebSocket不稳定" class="headerlink" title="三、WebSocket不稳定"></a>三、WebSocket不稳定</h2><blockquote>
<p><code>WebSocket</code>并不稳定，在使用一段时间后，可能会断开连接，貌似至今没有一个为何会断开连接的公论，所以我们需要让<code>WebSocket</code>保持连接状态，这里推荐两种方法</p>
</blockquote>
<h3 id="3-1-WebSocket设置变量，判断是否手动关闭连接"><a href="#3-1-WebSocket设置变量，判断是否手动关闭连接" class="headerlink" title="3.1 WebSocket设置变量，判断是否手动关闭连接"></a>3.1 WebSocket设置变量，判断是否手动关闭连接</h3><blockquote>
<p><code>class</code>类中就是用的这种方式:设置一个变量，在<code>webSocket</code>关闭&#x2F;报错的回调中，判断是不是手动关闭的，如果不是的话，就重新连接，这样做的优缺点如下</p>
</blockquote>
<ul>
<li>优点：请求较少(相对于心跳连接)，易设置。</li>
<li>缺点：可能会导致丢失数据,在断开重连的这段时间中，恰好双方正在通信</li>
</ul>
<h3 id="3-2-WebSocket心跳机制"><a href="#3-2-WebSocket心跳机制" class="headerlink" title="3.2 WebSocket心跳机制"></a>3.2 WebSocket心跳机制</h3><blockquote>
<p>因为第一种方案的缺点，并且可能会有其他一些未知情况导致断开连接而没有触发Error或Close事件。这样就导致实际连接已经断开了，而客户端和服务端却不知道，还在傻傻的等着消息来</p>
</blockquote>
<ul>
<li>想出了一种叫做心跳机制的解决方法：</li>
<li>客户端就像心跳一样每隔固定的时间发送一次ping，来告诉服务器，我还活着，而服务器也会返回pong，来告诉客户端，服务器还活着。</li>
<li>具体的实现方法，在上面<code>class</code>的注释中，将其打开，即可看到效果</li>
</ul>
<h2 id="四、关于WebSocket"><a href="#四、关于WebSocket" class="headerlink" title="四、关于WebSocket"></a>四、关于WebSocket</h2><h3 id="4-1-WebSocket的当前状态-WebSocket-readyState"><a href="#4-1-WebSocket的当前状态-WebSocket-readyState" class="headerlink" title="4.1 WebSocket的当前状态:WebSocket.readyState"></a>4.1 WebSocket的当前状态:<code>WebSocket.readyState</code></h3><p><strong>下面是WebSocket.readyState的四个值(四种状态)：</strong></p>
<ul>
<li><code>0</code>: 表示正在连接</li>
<li><code>1</code>: 表示连接成功，可以通信了</li>
<li><code>2</code>: 表示连接正在关闭</li>
<li><code>3</code>: 表示连接已经关闭，或者打开连接失败</li>
</ul>
<blockquote>
<p>我们可以利用当前状态来做一些事情，比如上面栗子中当<code>WebSocket</code>链接成功后，才允许客户端发<code>送ping</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (this.ws.readyState === 1) &#123;</span><br><span class="line">    // 检查ws为链接状态 才可发送</span><br><span class="line">    this.ws.send(&#x27;ping&#x27;); // 客户端发送ping</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-WebSocket还可以发送-x2F-接收-二进制数据"><a href="#4-2-WebSocket还可以发送-x2F-接收-二进制数据" class="headerlink" title="4.2 WebSocket还可以发送&#x2F;接收 二进制数据"></a>4.2 <code>WebSocket</code>还可以发送&#x2F;接收 二进制数据</h3><blockquote>
<p>二进制数据包括：<code>blob</code>对象和<code>Arraybuffer</code>对象，所以我们需要分开来处理</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> // 接收数据</span><br><span class="line">ws.onmessage = function(event)&#123;</span><br><span class="line">    if(event.data instanceof ArrayBuffer)&#123;</span><br><span class="line">        // 判断 ArrayBuffer 对象</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(event.data instanceof Blob)&#123;</span><br><span class="line">        // 判断 Blob 对象</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 发送 Blob 对象的例子</span><br><span class="line">let file = document.querySelector(&#x27;input[type=&quot;file&quot;]&#x27;).files[0];</span><br><span class="line">ws.send(file);</span><br><span class="line"></span><br><span class="line">// 发送 ArrayBuffer 对象的例子</span><br><span class="line">var img = canvas_context.getImageData(0, 0, 400, 320);</span><br><span class="line">var binary = new Uint8Array(img.data.length);</span><br><span class="line">for (var i = 0; i &lt; img.data.length; i++) &#123;</span><br><span class="line">    binary[i] = img.data[i];</span><br><span class="line">&#125;</span><br><span class="line">ws.send(binary.buffer);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果你要发送的二进制数据很大的话，如何判断发送完毕：</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">webSocket.bufferedAmount属性，表示还有多少字节的二进制数据没有发送出去：</span><br><span class="line"></span><br><span class="line">var data = new ArrayBuffer(10000000);</span><br><span class="line">socket.send(data);</span><br><span class="line">if (socket.bufferedAmount === 0) &#123;</span><br><span class="line">    // 发送完毕</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    // 发送还没结束</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="五、WebSocket的优点"><a href="#五、WebSocket的优点" class="headerlink" title="五、WebSocket的优点"></a>五、WebSocket的优点</h2><ul>
<li>双向通信</li>
<li>数据格式比较轻量，性能开销小，通信高效<ul>
<li>协议控制的数据包头部较小，而<code>HTTP</code>协议每次通信都需要携带完整的头部</li>
</ul>
</li>
<li>更好的二进制支持</li>
<li>没有同源限制，客户端可以与任意服务器通信</li>
<li>与 <code>HTTP</code> 协议有着良好的兼容性。默认端口也是<code>80</code>和<code>443</code>，并且握手阶段采用 <code>HTTP</code> 协议，因此握手时不容易屏蔽，能通过各种 <code>HTTP</code> 代理服务器</li>
</ul>
<h1 id="第二部分-socket-io"><a href="#第二部分-socket-io" class="headerlink" title="第二部分 socket.io"></a>第二部分 <code>socket.io</code></h1><h2 id="一、原生Node与socket-io通信"><a href="#一、原生Node与socket-io通信" class="headerlink" title="一、原生Node与socket.io通信"></a>一、原生Node与socket.io通信</h2><blockquote>
<p>原生<code>nodejs</code>结合<code>Socket.io</code>实现服务器和客户端的相互通信</p>
</blockquote>
<blockquote>
<p>官方文档 <a target="_blank" rel="noopener" href="https://socket.io/">https://socket.io</a></p>
</blockquote>
<h3 id="1-1-搭建服务"><a href="#1-1-搭建服务" class="headerlink" title="1.1 搭建服务"></a>1.1 搭建服务</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"># 新建目录</span><br><span class="line">mkdir socket &amp;&amp; cd socket</span><br><span class="line"></span><br><span class="line"># 生成package.json</span><br><span class="line">npm init -y</span><br><span class="line"></span><br><span class="line"># 安装socket</span><br><span class="line">npm install socket.io</span><br><span class="line">// app.js</span><br><span class="line"></span><br><span class="line">var http = require(&quot;http&quot;);</span><br><span class="line"></span><br><span class="line">var server = http.createServer(function(req,res)&#123;</span><br><span class="line">    if(req.url == &quot;/&quot;)&#123; //显示首页</span><br><span class="line">        fs.readFile(&quot;./index.html&quot;,function(err,data)&#123; </span><br><span class="line">            res.end(data);</span><br><span class="line">        &#125;); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">var io = require(&#x27;socket.io&#x27;)(server);</span><br><span class="line"></span><br><span class="line">//监听连接事件 </span><br><span class="line">io.on(&quot;connection&quot;,function(socket)&#123;</span><br><span class="line">    console.log(&quot;1 个客户端连接了&quot;); </span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(3000,&quot;127.0.0.1&quot;,function()&#123;</span><br><span class="line">    console.log(&#x27;app run at 127.0.0.1:3000&#x27;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 写完这句话之后，你就会发现，http://127.0.0.1:3000/socket.io/socket.io.js 就是一个 js 文件 的地址了</span><br></pre></td></tr></table></figure>

<h3 id="1-2-新建页面"><a href="#1-2-新建页面" class="headerlink" title="1.2 新建页面"></a>1.2 新建页面</h3><blockquote>
<p>现在需要制作一个<code>index</code>页面，这个页面中，必须引用秘密<code>js</code>文件。调用<code>io</code>函数，取得<code>socket</code> 对象</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt; &lt;html lang=&quot;en&quot;&gt; &lt;head&gt;</span><br><span class="line">&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">&lt;title&gt;Document&lt;/title&gt; &lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;h1&gt;我是 index 页面，我引用了秘密 script 文件&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;/socket.io/socket.io.js&quot;&gt;&lt;/script&gt; &lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">    var socket = io(); </span><br><span class="line">    console.log(socket)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt; </span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>至此，服务器和客户端都有 <code>socket</code> 对象了。服务器的 <code>socket</code> 对象:</p>
</blockquote>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socket对象</span><br></pre></td></tr></table></figure>
</blockquote>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/390.png" alt="img"><br><img src="https://poetries1.gitee.io/img-repo/2019/10/391.png" alt="img"></p>
<h3 id="1-3-服务器端通过emit广播，通过on接收广播"><a href="#1-3-服务器端通过emit广播，通过on接收广播" class="headerlink" title="1.3 服务器端通过emit广播，通过on接收广播"></a>1.3 服务器端通过emit广播，通过on接收广播</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">// app.js</span><br><span class="line"></span><br><span class="line">var http = require(&quot;http&quot;);</span><br><span class="line"></span><br><span class="line">var server = http.createServer(function(req,res)&#123;</span><br><span class="line">    if(req.url == &quot;/&quot;)&#123; //显示首页</span><br><span class="line">        fs.readFile(&quot;./index.html&quot;,function(err,data)&#123; </span><br><span class="line">            res.end(data);</span><br><span class="line">        &#125;); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">var io = require(&#x27;socket.io&#x27;)(server);</span><br><span class="line"></span><br><span class="line">//监听连接事件 </span><br><span class="line">io.on(&#x27;connection&#x27;,function(socket) &#123;</span><br><span class="line">    console.log(&#x27;和服务器建立连接了&#x27;);</span><br><span class="line">    </span><br><span class="line">    socket.on(&#x27;to-server&#x27;,function(data) &#123;</span><br><span class="line">    </span><br><span class="line">        // 接收客户端传过来的数据</span><br><span class="line">        console.log(&#x27;客户端说:&#x27; + data);</span><br><span class="line">        </span><br><span class="line">        // 向客户端发送数据</span><br><span class="line">        // socket 只给当前发送消息给服务端的客户端发送消息</span><br><span class="line">        socket.emit(&#x27;to-client&#x27;,&#x27;我是服务器返回的数据&#x27;);</span><br><span class="line">        </span><br><span class="line">    &#125;) </span><br><span class="line">    socket.on(&#x27;disconnect&#x27;,function() &#123;</span><br><span class="line">        console.log(&#x27;断开连接了&#x27;);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(3000,&quot;127.0.0.1&quot;,function()&#123;</span><br><span class="line">    console.log(&#x27;app run at 127.0.0.1:3000&#x27;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><img src="https://poetries1.gitee.io/img-repo/2019/10/392.png" alt="img"></p>
<blockquote>
<p>每一个连接上来的用户，都有一个 <code>socket</code>。由于我们的 <code>emit</code> 语句，是 <code>socket.emit()</code>发 出的，所以指的是向这个客户端发出语句。<br>广播，就是给所有当前连接的用户发送信息:</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">var io = require(&#x27;socket.io&#x27;)(server);</span><br><span class="line"></span><br><span class="line">io.on(&#x27;connection&#x27;,function(socket) &#123;</span><br><span class="line"></span><br><span class="line">    console.log(&#x27;和服务器建立连接了&#x27;)</span><br><span class="line">    </span><br><span class="line">    socket.on(&#x27;to-server&#x27;,function(data) &#123;</span><br><span class="line">    </span><br><span class="line">        console.log(&#x27;客户端说:&#x27; + data);</span><br><span class="line">        </span><br><span class="line">        // io 给所有建立连接的客户端发送数据，不管是哪个客户端发送消息，都会对所有客户端进行广播一次</span><br><span class="line">        io.emit(&#x27;to-client&#x27;,&#x27;我是服务器返回的数据&#x27;);</span><br><span class="line">    &#125;) </span><br><span class="line">    socket.on(&#x27;disconnect&#x27;,function() &#123;</span><br><span class="line">        console.log(&#x27;断开连接了&#x27;);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><img src="https://poetries1.gitee.io/img-repo/2019/10/393.png" alt="img"><br><img src="https://poetries1.gitee.io/img-repo/2019/10/394.png" alt="img"></p>
<ul>
<li><code>io.emit()</code>可以实现聊天室消息群发</li>
<li><code>socket.emit()</code>可以实现聊天机器人，一对一发送</li>
</ul>
<h3 id="1-4-客户端端通过emit广播，通过on接收广播"><a href="#1-4-客户端端通过emit广播，通过on接收广播" class="headerlink" title="1.4 客户端端通过emit广播，通过on接收广播"></a>1.4 客户端端通过emit广播，通过on接收广播</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">// index.html</span><br><span class="line">&lt;!DOCTYPE html&gt; </span><br><span class="line">&lt;html lang=&quot;en&quot;&gt; </span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;socket demo&lt;/title&gt; </span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;h1&gt;我是 index 页面，我引用了秘密 script 文件&lt;/h1&gt;</span><br><span class="line">&lt;button id=&quot;btn&quot;&gt;给服务端发送数据&lt;/button&gt;</span><br><span class="line"></span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;/socket.io/socket.io.js&quot;&gt;&lt;/script&gt; &lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line"></span><br><span class="line">    // 连接的地址http://localhost:3000 后台提供</span><br><span class="line">    var socket = io.connect(&#x27;http://localhost:3000&#x27;);</span><br><span class="line"></span><br><span class="line">    // 客户端建立连接</span><br><span class="line">    socket.on(&#x27;connect&#x27;,function() &#123;</span><br><span class="line">        console.log(&#x27;客户端和服务端建立连接了&#x27;);</span><br><span class="line">    &#125;) </span><br><span class="line"></span><br><span class="line">    socket.on(&#x27;disconnect&#x27;,function() &#123;</span><br><span class="line">        console.log(&#x27;客户端和服务端断开连接了&#x27;);</span><br><span class="line">    &#125;) </span><br><span class="line"></span><br><span class="line">    // 客户端给服务端发送数据后，监听服务端返回的数据</span><br><span class="line">    socket.on(&#x27;to-client&#x27;,function(data) &#123;</span><br><span class="line">        console.log(&#x27;客户端说:&#x27; + data);</span><br><span class="line">    &#125;) </span><br><span class="line"></span><br><span class="line">    var btn = document.getElementById(&#x27;btn&#x27;);</span><br><span class="line"></span><br><span class="line">    btn.onclick = function() &#123;</span><br><span class="line">        socket.emit(&#x27;to-server&#x27;,&#x27;我是客户端的数据&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt; </span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h2 id="二、聊天室、智能机器人实现原理"><a href="#二、聊天室、智能机器人实现原理" class="headerlink" title="二、聊天室、智能机器人实现原理"></a>二、聊天室、智能机器人实现原理</h2><h3 id="2-1-express简单例子"><a href="#2-1-express简单例子" class="headerlink" title="2.1 express简单例子"></a>2.1 express简单例子</h3><blockquote>
<p><code>Express</code> 结合 <code>Socket.io</code> 实现服务器和客户 端的相互通信、聊天室、智能机器人实现 原理</p>
</blockquote>
<blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.expressjs.com.cn/starter/generator.html">express文档</a></li>
<li><a target="_blank" rel="noopener" href="https://socket.io/docs">socket.io文档</a></li>
</ul>
</blockquote>
<p><strong>1. Server (app.js)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">var app = require(&#x27;express&#x27;)();</span><br><span class="line">var server = require(&#x27;http&#x27;).Server(app);</span><br><span class="line">var io = require(&#x27;socket.io&#x27;)(server);</span><br><span class="line"></span><br><span class="line">server.listen(80);</span><br><span class="line">// WARNING: app.listen(80) will NOT work here!</span><br><span class="line"></span><br><span class="line">app.get(&#x27;/&#x27;, function (req, res) &#123;</span><br><span class="line">  res.sendFile(__dirname + &#x27;/index.html&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">io.on(&#x27;connection&#x27;, function (socket) &#123;</span><br><span class="line">  socket.emit(&#x27;news&#x27;, &#123; hello: &#x27;world&#x27; &#125;);</span><br><span class="line">  socket.on(&#x27;my other event&#x27;, function (data) &#123;</span><br><span class="line">    console.log(data);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>2. Client (index.html)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=&quot;/socket.io/socket.io.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">  var socket = io.connect(&#x27;http://localhost&#x27;);</span><br><span class="line">  socket.on(&#x27;news&#x27;, function (data) &#123;</span><br><span class="line">    console.log(data);</span><br><span class="line">    socket.emit(&#x27;my other event&#x27;, &#123; my: &#x27;data&#x27; &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-express实现智能机器人"><a href="#2-2-express实现智能机器人" class="headerlink" title="2.2 express实现智能机器人"></a>2.2 express实现智能机器人</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--views/index.ejx--&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;title&gt;&lt;/title&gt;</span><br><span class="line"></span><br><span class="line">    &lt;script src=&quot;/jquery-1.11.3.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">    &lt;script src=&quot;/socket.io/socket.io.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;input type=&quot;text&quot; id=&quot;msg&quot;/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;br/&gt;</span><br><span class="line">    &lt;br/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;button id=&quot;send&quot;&gt;发送&lt;/button&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">$(function()&#123;</span><br><span class="line"></span><br><span class="line">    var socket = io.connect(&#x27;http://127.0.0.1:8000&#x27;);</span><br><span class="line"></span><br><span class="line">    //群聊功能--聊天室</span><br><span class="line">    $(&#x27;#send&#x27;).click(function()&#123;</span><br><span class="line">        var msg=$(&#x27;#msg&#x27;).val();</span><br><span class="line"></span><br><span class="line">        socket.emit(&#x27;message&#x27;,msg);  /*客户端给服务器发送数据*/</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line">    //接受服务器返回的数据</span><br><span class="line">    socket.on(&#x27;servermessage&#x27;,function(data)&#123;</span><br><span class="line"></span><br><span class="line">        console.log(data)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">// app.js</span><br><span class="line"></span><br><span class="line">var express=require(&#x27;express&#x27;);</span><br><span class="line"></span><br><span class="line">var app=express();</span><br><span class="line"></span><br><span class="line">/*第一步*/</span><br><span class="line">var server = require(&#x27;http&#x27;).Server(app);</span><br><span class="line">var io = require(&#x27;socket.io&#x27;)(server);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.set(&#x27;view engine&#x27;,&#x27;ejs&#x27;);</span><br><span class="line">app.use(express.static(&#x27;public&#x27;));</span><br><span class="line"></span><br><span class="line">app.get(&#x27;/&#x27;,function(req,res)&#123;</span><br><span class="line">    //res.send(&#x27;首页&#x27;);</span><br><span class="line">    res.render(&#x27;index&#x27;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(&#x27;/news&#x27;,function(req,res)&#123;</span><br><span class="line">    res.send(&#x27;news&#x27;);</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">//2.监听端口</span><br><span class="line">server.listen(8000,&#x27;127.0.0.1&#x27;);   /*改ip*/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//3、写socket的代码</span><br><span class="line"></span><br><span class="line">io.on(&#x27;connection&#x27;, function (socket) &#123;</span><br><span class="line">  console.log(&#x27;建立链接&#x27;)</span><br><span class="line"></span><br><span class="line">    socket.on(&#x27;message&#x27;,function(data)&#123;</span><br><span class="line"></span><br><span class="line">        console.log(data);</span><br><span class="line"></span><br><span class="line">        //io.emit  广播 --- 聊天室</span><br><span class="line">        //socket.emit  谁给我发的信息我回返回给谁 --- 智能机器人</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //io.emit(&#x27;servermessage&#x27;,data);   /*服务器给客户端发送数据*/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        if(data==1)&#123;</span><br><span class="line"></span><br><span class="line">            var msg=&#x27;您当前的话费有2元&#x27;</span><br><span class="line">        &#125;else if(data==2)&#123;</span><br><span class="line">            var msg=&#x27;您当前的流量有200M&#x27;</span><br><span class="line"></span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            var msg=&#x27;请输入正确的信息&#x27;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        socket.emit(&#x27;servermessage&#x27;,msg);</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/poetries/socket.io-demo/tree/master/express-socket-chat">完整代码</a></p>
</blockquote>
<h3 id="2-3-express结合socket-io及数据库实现智能机器人"><a href="#2-3-express结合socket-io及数据库实现智能机器人" class="headerlink" title="2.3 express结合socket.io及数据库实现智能机器人"></a>2.3 express结合<code>socket.io</code>及数据库实现智能机器人</h3><blockquote>
<p>跨域也可以访问<code>socket.io</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line">// app.js</span><br><span class="line"></span><br><span class="line">var express=require(&#x27;express&#x27;);</span><br><span class="line"></span><br><span class="line">var app=express();</span><br><span class="line"></span><br><span class="line">var DB=require(&#x27;./module/db.js&#x27;);</span><br><span class="line"></span><br><span class="line">/*第一步*/</span><br><span class="line">var server = require(&#x27;http&#x27;).Server(app);</span><br><span class="line">var io = require(&#x27;socket.io&#x27;)(server);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.set(&#x27;view engine&#x27;,&#x27;ejs&#x27;);</span><br><span class="line">app.use(express.static(&#x27;public&#x27;));</span><br><span class="line"></span><br><span class="line">app.get(&#x27;/&#x27;,function(req,res)&#123;</span><br><span class="line">    //res.send(&#x27;首页&#x27;);</span><br><span class="line">    res.render(&#x27;index&#x27;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(&#x27;/news&#x27;,function(req,res)&#123;</span><br><span class="line">    res.send(&#x27;news&#x27;);</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">//2.监听端口</span><br><span class="line">server.listen(8000,&#x27;127.0.0.1&#x27;, function () &#123;</span><br><span class="line">    console.log(&#x27;app run at 127.0.0.1:8000&#x27;)</span><br><span class="line">&#125;);   /*改ip*/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//3、写socket的代码</span><br><span class="line"></span><br><span class="line">io.on(&#x27;connection&#x27;, function (socket) &#123;</span><br><span class="line">    console.log(&#x27;建立链接&#x27;)</span><br><span class="line"></span><br><span class="line">    socket.on(&#x27;message&#x27;,function(data)&#123;</span><br><span class="line"></span><br><span class="line">        console.log(data)</span><br><span class="line">        //socket.emit(&#x27;servermessage&#x27;,msg);</span><br><span class="line"></span><br><span class="line">        var msg=data.msg||&#x27;&#x27;;  /*获取客户端的数据*/</span><br><span class="line"></span><br><span class="line">        //去服务器查询数据</span><br><span class="line"></span><br><span class="line">        DB.find(&#x27;article&#x27;,&#123;&#x27;title&#x27;:&#123;$regex:new RegExp(msg)&#125;&#125;,&#123;&#x27;title&#x27;:1&#125;,function(err,data)&#123;</span><br><span class="line"></span><br><span class="line">            console.log(data);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            socket.emit(&#x27;servermessage&#x27;,&#123;</span><br><span class="line">                result:data</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;);</span><br><span class="line">&lt;!DOCTYPE&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;&lt;/title&gt;</span><br><span class="line">    &lt;script</span><br><span class="line">  src=&quot;https://code.jquery.com/jquery-3.3.1.min.js&quot;</span><br><span class="line">  integrity=&quot;sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=&quot;</span><br><span class="line">  crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">    &lt;script src=&quot;/socket.io/socket.io.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;style&gt;</span><br><span class="line"></span><br><span class="line">        .box&#123;</span><br><span class="line">            width: 300px;</span><br><span class="line">            height: 400px;</span><br><span class="line">            margin: 0 auto;</span><br><span class="line">            border: 1px solid #666;</span><br><span class="line">            margin-top:20px;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        .list&#123;</span><br><span class="line">            width: 300px;</span><br><span class="line">            height: 360px;</span><br><span class="line">            overflow-y: auto;</span><br><span class="line">        &#125;</span><br><span class="line">        .message&#123;</span><br><span class="line">            height: 40px;</span><br><span class="line">            line-height: 44px;</span><br><span class="line">            display: flex;</span><br><span class="line">        &#125;</span><br><span class="line">        .message input&#123;</span><br><span class="line"></span><br><span class="line">            border: 1px solid #666;</span><br><span class="line">        &#125;</span><br><span class="line">        .message input[type=&#x27;text&#x27;]&#123;</span><br><span class="line">            flex: 1;</span><br><span class="line">            height: 38px;</span><br><span class="line">        &#125;</span><br><span class="line">        .message input[type=&#x27;button&#x27;]&#123;</span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 40px;</span><br><span class="line">            border: 1px solid #666;</span><br><span class="line">        &#125;</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">    &lt;div class=&quot;box&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;list&quot;&gt;</span><br><span class="line">            &lt;div id=&quot;list&quot;&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;footer&quot; id=&quot;footer&quot;&gt;</span><br><span class="line"></span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;div class=&quot;message&quot;&gt;</span><br><span class="line">            &lt;input type=&quot;text&quot; id=&quot;msg&quot; /&gt;</span><br><span class="line">            &lt;input type=&quot;button&quot; id=&quot;send&quot; value=&quot;发送&quot;/&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    $(function()&#123;</span><br><span class="line"></span><br><span class="line">        var socket = io.connect(&#x27;http://127.0.0.1:8000&#x27;);</span><br><span class="line"></span><br><span class="line">        socket.on(&#x27;servermessage&#x27;,function(data)&#123;</span><br><span class="line"></span><br><span class="line">            if(data.result.length)</span><br><span class="line"></span><br><span class="line">            &#123;</span><br><span class="line">                var str=&#x27;&lt;ul&gt;&#x27;;</span><br><span class="line">                for(var i=0;i&lt;data.result.length;i++)&#123;</span><br><span class="line"></span><br><span class="line">                    str+=&#x27;&lt;li&gt;&#x27;+data.result[i].title+&#x27;&lt;/li&gt;&#x27;;</span><br><span class="line">                &#125;</span><br><span class="line">                str+=&#x27;&lt;/ul&gt;&#x27;;</span><br><span class="line">            &#125;else&#123;</span><br><span class="line"></span><br><span class="line">                var str=&#x27;&lt;p&gt;没有找到您要的数据，请联系人工客服&lt;/p&gt;&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">            $(&#x27;#list&#x27;).append(str);</span><br><span class="line">            $(&#x27;#footer&#x27;).get(0).scrollIntoView();</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        var username=&#x27;zhangsan&#x27;+Math.floor(Math.random()*10);</span><br><span class="line"></span><br><span class="line">        //群聊功能--聊天室</span><br><span class="line">        $(&#x27;#send&#x27;).click(function()&#123;</span><br><span class="line">            var msg=$(&#x27;#msg&#x27;).val();</span><br><span class="line">            socket.emit(&#x27;message&#x27;,&#123;</span><br><span class="line">                &#x27;username&#x27;:username,</span><br><span class="line">                &#x27;msg&#x27;:msg</span><br><span class="line">            &#125;);</span><br><span class="line">            $(&#x27;#list&#x27;).append(`&lt;p&gt;&lt;strong&gt;$&#123;username&#125;:&lt;/strong&gt;  $&#123;msg&#125;&lt;/p&gt;`);</span><br><span class="line"></span><br><span class="line">            $(&#x27;#msg&#x27;).val();</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/poetries/socket.io-demo/tree/master/express-socket-chat-use-db">完整代码</a></p>
</blockquote>
<h2 id="三、Koa中Socket-io的使用"><a href="#三、Koa中Socket-io的使用" class="headerlink" title="三、Koa中Socket.io的使用"></a>三、Koa中Socket.io的使用</h2><p><strong>1. 服务端配置</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 1 安装</span><br><span class="line">cnpm i -S koa-socket</span><br><span class="line">// app.js</span><br><span class="line"></span><br><span class="line">// 2 引入</span><br><span class="line">const IO = require( &#x27;koa-socket&#x27; )</span><br><span class="line"></span><br><span class="line">// 3 实例化</span><br><span class="line">const io = new IO()</span><br><span class="line"></span><br><span class="line">io.attach( app )</span><br><span class="line"></span><br><span class="line">// 4 配置服务端</span><br><span class="line"></span><br><span class="line">app._io.on( &#x27;connection&#x27;, socket =&gt; &#123;</span><br><span class="line"></span><br><span class="line">console.log(&#x27;建立连接了&#x27;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>2. 客户端代码</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=&quot;http://localhost:3000/socket.io/socket.io.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">   var socket=io.connect(&#x27;http://localhost:3000/&#x27;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/poetries/socket.io-demo/tree/master/koa-socket.io">完整代码</a></p>
</blockquote>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nodejs/" rel="tag">nodejs</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-nodejs/node-基础篇" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/05/14/nodejs/node-%E5%9F%BA%E7%A1%80%E7%AF%87/" class="article-date">
  	<time datetime="2019-05-14T14:21:25.000Z" itemprop="datePublished">2019-05-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/14/nodejs/node-%E5%9F%BA%E7%A1%80%E7%AF%87/">
        node-基础总结
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="一、nodejs介绍"><a href="#一、nodejs介绍" class="headerlink" title="一、nodejs介绍"></a>一、nodejs介绍</h1><h2 id="1-1-简介"><a href="#1-1-简介" class="headerlink" title="1.1 简介"></a>1.1 简介</h2><ul>
<li><code>nodejs</code>是一个<code>JavaScript</code>运行环境。它让 <code>JavaScript</code> 可以开发后端程序，实现几乎其他后端语言实现的所有功能</li>
<li><code>Nodejs</code> 是基于 <code>V8</code> 引擎，<code>V8</code> 是 <code>Google</code> 发布的开源 <code>JavaScript</code> 引擎，本身就是用于 <code>Chrome</code> 浏览器 的 <code>JS</code> 解释部分， <code>V8</code> 搬到了服务器上，用于做服务器的软件</li>
<li>短短几年的时间，Node 取得了巨大的成功。在企业界，Node 的应用也越来越广泛，2016 年 nodeJS 官方的调查报告。2016 年全球有 350 万开发者使用 nodeJS,相比去年保持了 100%的增长率。像 Yahoo、 Microsoft 这样的大公司，有好多应用已经迁移到 Node 了。国内的阿里巴巴、网易、腾讯、新浪、百度等 公司的很多线上产品也纷纷改用 Node 开发，并取得了很好的效果。据统计很多 A 轮、 B 轮的创业公司更 喜欢使用 NodeJs 开发。</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://nodejs.org/static/documents/2016-survey-report.pdf">https://nodejs.org/static/documents/2016-survey-report.pdf</a></p>
</blockquote>
<h2 id="1-2-NodeJs-的优势"><a href="#1-2-NodeJs-的优势" class="headerlink" title="1.2 NodeJs 的优势"></a>1.2 NodeJs 的优势</h2><p><strong>1. NodeJs 语法完全是 js 语法，只要你懂 JS 基础就可以学会 Nodejs 后端开发</strong></p>
<blockquote>
<p>Node 打破了过去 JavaScript 只能在浏览器中运行的局面。前后端编程环境统一，可以大大降低开发成本</p>
</blockquote>
<p><strong>2. NodeJs 超强的高并发能力</strong></p>
<ul>
<li><code>Node.js</code> 的首要目标是提供一种简单的、用于创建高性能服务器及可在该服务器中运行的各种应用程 序的开发工具</li>
<li>首先让我们来看一下现在的服务器端语言中存在着什么问题。<br>在 <code>Java</code>、<code>PHP</code> 或者<code>.net</code> 等服务器端语言中，会为每一个客户端连接创建一个新的线程。而每个线程需要耗费大约 <code>2MB</code> 内存<br>理论上，一个 <code>8GB</code> 内存的服务器可以同时连接的最大用户数为 <code>4000</code> 个左右<br>。要让 <code>Web</code> 应用程序支持更多的用户，就 需要增加服务器的数量，而 <code>Web</code> 应用程序的硬件成本当然就上升了</li>
<li><code>Node.js</code> 不为每个客户连接创建一个新的线程，而仅仅使用一个线程。当有用户连接了，就触发一个 内部事件，通过非阻塞 <code>I/O</code>、事件驱动机制，让 <code>Node.js</code> 程序宏观上也是并行的。使用 <code>Node.js</code>，一个 <code>8GB</code> 内存的服务器，可以同时处理超过 <code>4 万</code>用户的连接</li>
</ul>
<p><strong>3. 实现高性能服务器</strong></p>
<ul>
<li>严格地说，<code>Node.js</code> 是一个用于开发各种 Web 服务器的开发工具。在 <code>Node.js</code> 服务器中，运行的是高性能 <code>V8 JavaScript</code> 脚本语言，该语言是一种可以运行在服务器端的 <code>JavaScript</code> 脚本语言</li>
<li>那么，什么是 <code>V8 JavaScript</code> 脚本语言呢?该语言是一种被 <code>V8 JavaScript</code> 引擎所解析并执行的脚本语言。<code>V8 JavaScript</code> 引擎是由 <code>Google</code> 公司使用 C++语言开发的一种高性能 <code>JavaScript</code> 引擎，该引擎并不局限于在浏览 器中运行。<code>Node.js</code> 将其转用在了服务器中，并且为其提供了许多附加的具有各种不同用途的 <code>API</code>。例如， 在一个服务器中，经常需要处理各种二进制数据。在 <code>JavaScript</code> 脚本语言中，只具有非常有限的对二进制数 据的处理能力，而 <code>Node.js</code> 所提供的 <code>Buffer</code> 类则提供了丰富的对二进制数据的处理能力</li>
<li>另外，在 <code>V8 JavaScript</code>引擎内部使用一种全新的编译技术。这意味着开发者编写的高端的 <code>JavaScript</code> 脚本代码与开发者编写的低端的C语言具有非常相近的执行效率，这也是<code>Node.js</code>服务器可以提供的一个重要特性</li>
</ul>
<p><strong>4. 开发周期短、开发成本低、学习成本低。</strong></p>
<ul>
<li><code>Node.js</code> 自身哲学，是花最小的硬件成本，追求更高的并发，更高的处理性能。</li>
<li>特点:<code>Node.js uses an event-driven, non-blocking I/O model that makes it lightweight and efficient.</code></li>
</ul>
<h2 id="1-3-NodeJs-适合做什么"><a href="#1-3-NodeJs-适合做什么" class="headerlink" title="1.3 NodeJs 适合做什么"></a>1.3 NodeJs 适合做什么</h2><blockquote>
<p>在短短几年多的时间里，<code>Node</code> 变得非常热门，使用者也非常多。这些使用者对于 <code>Node</code> 的各自倚重点也各部相同，经过整理,主要有下几类</p>
</blockquote>
<p><strong>1. 前后端编程语言环境统一</strong></p>
<blockquote>
<p>这类重点的代表是雅虎。雅虎开放了 <code>Cocktai</code> 框架，利用 自己深厚的前端沉淀，将 <code>YUI3</code> 这个前端框架的能力借助 <code>Node</code> 延伸到服务器端，使得使用 者摆脱了日常工作中一边写 <code>JavaScript</code> —边写 <code>PHP</code> 所帯来的上下文交换负担</p>
</blockquote>
<p><strong>2. Node 带来的高性能 I&#x2F;0 用于实时应用</strong></p>
<blockquote>
<p><code>Voxer</code> 将 <code>Node</code> 应用在实时语音上。国内腾讯的 朋友网将 Node 应用在长连接中，以提供实时功能，花瓣网、蘑菇街等公司通过 <code>socket.io</code> 实 现实时通知的功能。</p>
</blockquote>
<p><strong>3. 并行 I&#x2F;0 使得使用者可以更高效地利用分布式环境</strong></p>
<blockquote>
<p>阿里巴巴 eBay 是这方面的典型。 阿里巴巴的 NodeFox 和 eBay 的 ql.io 都是借用 Node 并行 I&#x2F;O 的能力，更高效地使用已有的 数据</p>
</blockquote>
<p><strong>4. 并行 I&#x2F;O •有效利用稳定接口提升 Web 渲染能力</strong></p>
<blockquote>
<p>雪球财经和 Linkedln 的移动版网站均 是这种案例，撇弃 同步等待式的顺序请求，大胆采用并行丨&#x2F;〇，加速数据的获取进而提升 Web 的渲染速度</p>
</blockquote>
<p><strong>5. 云计算平台提供 Node 支持</strong></p>
<blockquote>
<p>微软将 Node 引入 Azure 的开发中，阿里云、百度均纷纷 在云服务器上提供 Node 应用托管服务，Joyent 更是云计算中提供 Node 支持的代表。这类 平台看重 JavaScript 带来的开发上的优势，以及低资源占用、高性能的特点</p>
</blockquote>
<p><strong>6. 游戏开发领域</strong></p>
<blockquote>
<p>游戏领域对实时和并发有很高的要求，网易开源了 pomelo 实时框架， 可以应用在游戏和高实时应用中</p>
</blockquote>
<p><strong>7. 工具类应用</strong></p>
<blockquote>
<p>过去依赖 <code>java</code> 或其他语言构建的前端工具类应用，纷纷被一些前端工程 师用 <code>Node</code> 重写，用前端熟悉的语言为前端构建熟悉的工具</p>
</blockquote>
<h1 id="二、HTTP模块、URL模块-supervisor工具"><a href="#二、HTTP模块、URL模块-supervisor工具" class="headerlink" title="二、HTTP模块、URL模块 supervisor工具"></a>二、HTTP模块、URL模块 supervisor工具</h1><blockquote>
<p>用 <code>Node.js</code> 时，我们不仅仅在实现一个应用，同时还实现了整个 <code>HTTP</code> 服务器</p>
</blockquote>
<h2 id="2-1-创建一个简单的程序"><a href="#2-1-创建一个简单的程序" class="headerlink" title="2.1 创建一个简单的程序"></a>2.1 创建一个简单的程序</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">var http = require(&#x27;http&#x27;);</span><br><span class="line"></span><br><span class="line">http.createServer(function(request, response) &#123;</span><br><span class="line">    // 发送 HTTP 头部</span><br><span class="line">    // HTTP 状态值: 200 : OK</span><br><span class="line">    //设置 HTTP 头部，状态码是 200，文件类型是 html，字符集是 utf8 response.writeHead(200,&#123;&quot;Content-Type&quot;:&quot;text/html;charset=UTF-8&quot;&#125;);</span><br><span class="line">    // 发送响应数据 &quot;Hello World&quot;</span><br><span class="line">    res.end(&quot;哈哈哈哈，我买了一个 iPhone&quot; + (1 + 2 + 3) + &quot;s&quot;);</span><br><span class="line">&#125;).listen(8888);</span><br><span class="line">// 终端打印如下信息</span><br><span class="line">console.log(&#x27;Server running at http://127.0.0.1:8888/&#x27;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>你会发现，我们本地写一个 <code>js</code>，打死都不能直接拖入浏览器运行，但是有了 <code>node</code>，我 们任何一个 <code>js</code> 文件，都可以通过 <code>node</code> 来运行。也就是说，<code>node</code> 就是一个 <code>js</code> 的执行环境</p>
</blockquote>
<h2 id="2-2-HTTP-模块、URL模块"><a href="#2-2-HTTP-模块、URL模块" class="headerlink" title="2.2 HTTP 模块、URL模块"></a>2.2 HTTP 模块、URL模块</h2><blockquote>
<p><code>Node.js</code> 中，将很多的功能，划分为了一个个 <code>module</code>(模块)。 <code>Node.js</code> 中的很多功能都 是通过模块实现</p>
</blockquote>
<h3 id="2-2-1、HTTP-模块的使用"><a href="#2-2-1、HTTP-模块的使用" class="headerlink" title="2.2.1、HTTP 模块的使用"></a>2.2.1、HTTP 模块的使用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//引用模块</span><br><span class="line">var http = require(&quot;http&quot;);</span><br><span class="line">//创建一个服务器，回调函数表示接收到请求之后做的事情</span><br><span class="line">var server = http.createServer(function(req, res) &#123; //req 参数表示请求，res 表示响应</span><br><span class="line">    console.log(&quot;服务器接收到了请求&quot; + req.url);</span><br><span class="line">    res.end(); // End 方法使 Web 服务器停止处理脚本并返回当前结果</span><br><span class="line">&#125;);</span><br><span class="line">//监听端口</span><br><span class="line">server.listen(3000, &quot;127.0.0.1&quot;);</span><br></pre></td></tr></table></figure>

<p><strong>设置一个响应头</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res.writeHead(200,&#123;&quot;Content-Type&quot;:&quot;text/html;charset=UTF8&quot;&#125;);</span><br></pre></td></tr></table></figure>

<p><img src="https://poetries1.gitee.io/img-repo/2019/10/356.png" alt="img"></p>
<ul>
<li>我们现在来看一下 <code>req</code> 里面能够使用的东西</li>
<li>最关键的就是 <code>req.url</code> 属性，表示用户的请求 <code>URL</code> 地址。所有的路由设计，都是通过 <code>req.url</code> 来实现的。</li>
<li>我们比较关心的不是拿到 <code>URL</code>，而是识别这个 <code>URL</code></li>
<li>识别 <code>URL</code>，用到了下面的 <code>URL</code> 模块</li>
</ul>
<h3 id="2-2-2、URL-模块的使用"><a href="#2-2-2、URL-模块的使用" class="headerlink" title="2.2.2、URL 模块的使用"></a>2.2.2、URL 模块的使用</h3><ul>
<li><code>url.parse()</code> 解析<code>URL</code></li>
<li><code>url.format(urlObject)</code> 是上面 <code>url.parse()</code> 操作的逆向操作</li>
<li><code>url.resolve(from, to)</code> 添加或者替换地址</li>
</ul>
<p><strong>1. url.parse()</strong></p>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/357.png" alt="img"></p>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/358.png" alt="img"></p>
<p><strong>2. url.format()</strong></p>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/359.png" alt="img"></p>
<p><strong>3. url.resolve()</strong></p>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/360.png" alt="img"></p>
<h2 id="2-3-Nodejs-自启动工具-supervisor"><a href="#2-3-Nodejs-自启动工具-supervisor" class="headerlink" title="2.3 Nodejs 自启动工具 supervisor"></a>2.3 Nodejs 自启动工具 supervisor</h2><blockquote>
<p><code>supervisor</code> 会不停的 <code>watch</code> 你应用下面的所有文件，发现有文件被修改，就重新载入程序文件这样就实现了部署，修改了程序文件后马上就能看到变更后的结果。麻麻再也不用担心我的重启 <code>nodejs</code> 了</p>
</blockquote>
<p><strong>首先安装 supervisor</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g supervisor</span><br></pre></td></tr></table></figure>

<p><strong>使用 supervisor 代替 node 命令启动应用</strong></p>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/361.png" alt="img"></p>
<h1 id="三、CommonJs-和-Nodejs-模块"><a href="#三、CommonJs-和-Nodejs-模块" class="headerlink" title="三、CommonJs 和 Nodejs 模块"></a>三、CommonJs 和 Nodejs 模块</h1><h2 id="3-1-什么是-CommonJs"><a href="#3-1-什么是-CommonJs" class="headerlink" title="3.1 什么是 CommonJs"></a>3.1 什么是 CommonJs</h2><blockquote>
<p><code>JavaScript</code> 是一个强大面向对象语言，它有很多快速高效的解释器。然而， <code>JavaScript</code> 标准定义的 <code>API</code> 是为了构建基于浏览器的应用程序。并没有制定一个用于更广泛的应用程序 的标准库。<br>,而不只是停留在小脚本程序 的阶段。用 <code>CommonJS API</code> 编写出的应用，不仅可以利用 <code>JavaScript</code>开发客户端应用，而且还可以编写以下应 用</p>
</blockquote>
<ul>
<li>服务器端 <code>JavaScript</code> 应用程序。(<code>nodejs</code>)</li>
<li>命令行工具</li>
<li>桌面图形界面应用程序</li>
</ul>
<blockquote>
<p><code>CommonJS</code> 就是模块化的标准，<code>nodejs</code> 就是 <code>CommonJS</code>(模块化)的实现</p>
</blockquote>
<h2 id="3-2-Nodejs-中的模块化"><a href="#3-2-Nodejs-中的模块化" class="headerlink" title="3.2 Nodejs 中的模块化"></a>3.2 Nodejs 中的模块化</h2><blockquote>
<p><code>Node</code> 应用由模块组成，采用 <code>CommonJS</code> 模块规范</p>
</blockquote>
<h3 id="3-2-1-在-Node-中，模块分为两类"><a href="#3-2-1-在-Node-中，模块分为两类" class="headerlink" title="3.2.1 在 Node 中，模块分为两类"></a>3.2.1 在 Node 中，模块分为两类</h3><ul>
<li>一类是 <code>Node</code> 提供的模块,称为核心模块;另一类是用户编写的模块，称为文件模块</li>
</ul>
<blockquote>
<ul>
<li>核心模块部分在 <code>Node</code> 源代码的编译过程中，编译进了二进制执行文件。在 <code>Node</code> 进程启动时，部分核心模块就被直接加载进内存中，所以这部分核心模块引入时，文件定位和 编译执行这两个步骤可以省略掉，并且在路径分析中优先判断，所以它的加载速度是最快的。 如:<code>HTTP</code> 模块 、<code>URL</code> 模块、<code>Fs</code> 模块都是 <code>nodejs</code> 内置的核心模块，可以直接引入使用</li>
<li>文件模块则是在运行时动态加载，需要完整的路径分析、文件定位、编译执行过程、速度相比核心模块稍微慢一些，但是用的非常多。这些模块需要我们自己定义。接下来我 们看一下 <code>nodejs</code> 中的自定义模块。</li>
</ul>
</blockquote>
<h3 id="3-2-2-CommonJS-Nodejs-中自定义模块的规定"><a href="#3-2-2-CommonJS-Nodejs-中自定义模块的规定" class="headerlink" title="3.2.2 CommonJS(Nodejs)中自定义模块的规定"></a>3.2.2 CommonJS(Nodejs)中自定义模块的规定</h3><ol>
<li>我们可以把公共的功能抽离成为一个单独的 <code>js</code> 文件作为一个模块，默认情况下面这 个模块里面的方法或者属性，外面是没法访问的。如果要让外部可以访问模块里面的方法或 者属性，就必须在模块里面通过 <code>exports</code> 或者 <code>module.exports</code> 暴露属性或者方法</li>
<li>在需要使用这些模块的文件中，通过 <code>require</code> 的方式引入这个模块。这个时候就可以 使用模块里面暴露的属性和方法</li>
</ol>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/362.png" alt="img"></p>
<h3 id="3-2-3-定义使用模块"><a href="#3-2-3-定义使用模块" class="headerlink" title="3.2.3 定义使用模块"></a>3.2.3 定义使用模块</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// 定义一个 tools.js 的模块 //模块定义</span><br><span class="line">var tools = &#123;</span><br><span class="line">    sayHello: function() &#123;</span><br><span class="line">        return &#x27;hello NodeJS&#x27;;</span><br><span class="line">    &#125;,</span><br><span class="line">    add: function(x, y) &#123;</span><br><span class="line">        return x + y;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">// 模块接口的暴露</span><br><span class="line">// module.exports = tools; exports.sayHello = tools.sayHello; exports.add = tools.add;</span><br><span class="line">var http = require(&#x27;http&#x27;);</span><br><span class="line">// 引入自定义的 tools.js 模块</span><br><span class="line">var tools = require(&#x27;./tools&#x27;);</span><br><span class="line"></span><br><span class="line">tools.sa yHello(); //使用模块</span><br></pre></td></tr></table></figure>

<h1 id="四、NPM第三方模块和package"><a href="#四、NPM第三方模块和package" class="headerlink" title="四、NPM第三方模块和package"></a>四、NPM第三方模块和package</h1><h2 id="4-1-包与-NPM"><a href="#4-1-包与-NPM" class="headerlink" title="4.1 包与 NPM"></a>4.1 包与 NPM</h2><h3 id="4-1-1-包"><a href="#4-1-1-包" class="headerlink" title="4.1.1 包"></a>4.1.1 包</h3><blockquote>
<p><code>Nodejs</code> 中除了它自己提供的核心模块外，我们可以自定义模块，也可以使用 第三方的模块。<code>Nodejs</code>中第三方模块由包组成，可以通过包来对一组具有相互依 赖关系的模块进行统一管理</p>
</blockquote>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/363.png" alt="img"></p>
<p><strong>完全符合 CommonJs 规范的包目录一般包含如下这些文件</strong></p>
<ul>
<li><code>package.json</code> :包描述文件</li>
<li><code>bin</code> :用于存放可执行二进制文件的目录</li>
<li><code>lib</code> :用于存放 <code>JavaScript</code> 代码的目录</li>
<li><code>doc</code> :用于存放文档的目录</li>
</ul>
<blockquote>
<p>在 <code>NodeJs</code> 中通过 <code>NPM</code> 命令来下载第三方的模块(包)</p>
</blockquote>
<h3 id="4-1-2-NPM-介绍"><a href="#4-1-2-NPM-介绍" class="headerlink" title="4.1.2 NPM 介绍"></a>4.1.2 NPM 介绍</h3><ul>
<li>npm 是世界上最大的开放源代码的生态系统。我们可以通过 npm 下载各种各样的包，<br>这些源代码(包)我们可以在 <a target="_blank" rel="noopener" href="https://www.npmjs.com/">https://www.npmjs.com</a> 找到</li>
</ul>
<blockquote>
<p><code>npm</code> 是随同 <code>NodeJS</code> 一起安装的包管理工具，能解决 <code>NodeJS</code> 代码部署上的很多问题，常见的使用场景有 以下几种</p>
</blockquote>
<ul>
<li>允许用户从 <code>NPM</code> 服务器下载别人编写的第三方包到本地使用</li>
<li>允许用户从 <code>NPM</code> 服务器下载并安装别人编写的命令行程序(工具)到本地使用</li>
<li>允许用户将自己编写的包或命令行程序上传到 <code>NPM</code> 服务器供别人使用</li>
</ul>
<p><strong>NPM 命令详解</strong></p>
<ul>
<li><code>npm -v</code> 查看 <code>npm</code> 版本</li>
<li><code>npm install</code> 使用 <code>npm</code> 命令安装模块</li>
<li><code>npm uninstall moudleName</code> 卸载模块</li>
<li><code>npm list</code> 查看当前目录下已安装的 <code>node</code> 包</li>
<li><code>npm info jquery</code> 查看 <code>jquery</code> 的版本</li>
<li>指定版本安装 <code>npm install jquery@1.8.0</code></li>
</ul>
<h2 id="4-2-package-json"><a href="#4-2-package-json" class="headerlink" title="4.2 package.json"></a>4.2 package.json</h2><blockquote>
<p><code>package.json</code> 定义了这个项目所需要的各种模块,以及项目的配置信息(比如名称、<br>版本、许可证等元数据)</p>
</blockquote>
<p><strong>1. 创建 package.json</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm init</span><br><span class="line">npm init –yes</span><br></pre></td></tr></table></figure>

<p><strong>2. 安装模块并把模块写入 package.json(依赖)</strong></p>
<ul>
<li><code>npm install babel-cli --save-dev</code></li>
<li><code>npm install 模块 --save</code></li>
</ul>
<p><strong>3. dependencies 与 devDependencies 之间的区别</strong></p>
<ul>
<li>使用 <code>npm install node_module –save</code> 自动更新 <code>dependencies</code> 字段值;</li>
<li>使用 <code>npm install node_module –save-dev</code> 自动更新 <code>devDependencies</code> 字段值</li>
<li><code>dependencies</code> 配置当前程序所依赖的其他</li>
<li><code>devDependencies</code> 配置当前程序所依赖的其他包，只会下载模块，而不下载这些模块的测试 和文档框架</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&quot;dependencies&quot;: &#123;</span><br><span class="line">    &quot;ejs&quot;: &quot;^2.3.4&quot;,</span><br><span class="line">    &quot;express&quot;: &quot;^4.13.3&quot;,</span><br><span class="line">    &quot;formidable&quot;: &quot;^1.0.17&quot;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>^</code>表示第一位版本号不变，后面两位取最新的</li>
<li><code>~</code>表示前两位不变，最后一个取最新</li>
<li><code>*</code>表示全部取最新</li>
</ul>
<h2 id="4-3-安装淘宝镜像"><a href="#4-3-安装淘宝镜像" class="headerlink" title="4.3 安装淘宝镜像"></a>4.3 安装淘宝镜像</h2><ul>
<li><a target="_blank" rel="noopener" href="http://www.npmjs.org/">http://www.npmjs.org</a> npm 包官网</li>
<li><a target="_blank" rel="noopener" href="https://npm.taobao.org/">https://npm.taobao.org/</a> 淘宝 npm 镜像官网</li>
</ul>
<blockquote>
<p>淘宝 <code>NPM</code> 镜像是一个完整 <code>npmjs.org</code> 镜像，你可以用此代替官方版本(只读)，同步频 率目前为 10 分钟 一次以保证尽量与官方服务同步</p>
</blockquote>
<p>我们可以使用我们定制的 <code>cnpm</code> (<code>gzip</code> 压缩支持) 命令行工具代替默认的 <code>npm</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g cnpm --registry=https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure>

<h1 id="五、fs模块"><a href="#五、fs模块" class="headerlink" title="五、fs模块"></a>五、fs模块</h1><h2 id="5-1-fs-stat-检测是文件还是目录"><a href="#5-1-fs-stat-检测是文件还是目录" class="headerlink" title="5.1 fs.stat 检测是文件还是目录"></a>5.1 fs.stat 检测是文件还是目录</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">const fs = require(&#x27;fs&#x27;)</span><br><span class="line"></span><br><span class="line">fs.stat(&#x27;hello.js&#x27;, (error, stats) = &gt;&#123;</span><br><span class="line">    if (error) &#123;</span><br><span class="line">        console.log(error)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        console.log(stats) </span><br><span class="line">        </span><br><span class="line">        console.log(`文件: $ &#123;</span><br><span class="line">            stats.isFile()</span><br><span class="line">        &#125;`) </span><br><span class="line">        </span><br><span class="line">        console.log(`目录: $ &#123;</span><br><span class="line">            stats.isDirectory()</span><br><span class="line">        &#125;`)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="5-2-fs-mkdir-创建目录"><a href="#5-2-fs-mkdir-创建目录" class="headerlink" title="5.2 fs.mkdir 创建目录"></a>5.2 fs.mkdir 创建目录</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">const fs = require(&#x27;fs&#x27;) </span><br><span class="line"></span><br><span class="line">fs.mkdir(&#x27;logs&#x27;, (error) = &gt;&#123;</span><br><span class="line">    if (error) &#123;</span><br><span class="line">        console.log(error)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        console.log(&#x27;成功创 建目录:logs&#x27;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="5-3-fs-writeFile-创建写入文件"><a href="#5-3-fs-writeFile-创建写入文件" class="headerlink" title="5.3 fs.writeFile 创建写入文件"></a>5.3 fs.writeFile 创建写入文件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fs.writeFile(&#x27;logs/hello.log&#x27;, &#x27;您好 ~ \n&#x27;, (error) = &gt;&#123;</span><br><span class="line">    if (error) &#123;</span><br><span class="line">        console.log(error)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        console.log(&#x27;成功写 入文件&#x27;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="5-4-fs-appendFile-追加文件"><a href="#5-4-fs-appendFile-追加文件" class="headerlink" title="5.4 fs.appendFile 追加文件"></a>5.4 fs.appendFile 追加文件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fs.appendFile(&#x27;logs/hello.log&#x27;, &#x27;hello ~ \n&#x27;, (error) = &gt;&#123;</span><br><span class="line">    if (error) &#123;</span><br><span class="line">        console.log(error)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        console.log(&#x27;成功写 入文件&#x27;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="5-5-fs-readFile-读取文件"><a href="#5-5-fs-readFile-读取文件" class="headerlink" title="5.5 fs.readFile 读取文件"></a>5.5 fs.readFile 读取文件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">const fs = require(&#x27;fs&#x27;) </span><br><span class="line"></span><br><span class="line">fs.readFile(&#x27;logs/hello.log&#x27;, &#x27;utf8&#x27;, (error, data) = &gt;&#123;</span><br><span class="line">    if (error) &#123;</span><br><span class="line">        console.log(error)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        console.log(data)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="5-6-fs-readdir-读取目录"><a href="#5-6-fs-readdir-读取目录" class="headerlink" title="5.6 fs.readdir 读取目录"></a>5.6 fs.readdir 读取目录</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">const fs = require(&#x27;fs&#x27;) </span><br><span class="line"></span><br><span class="line">fs.readdir(&#x27;logs&#x27;, (error, files) = &gt;&#123;</span><br><span class="line">    if (error) &#123;</span><br><span class="line">        console.log(error)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        console.log(files)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="5-7-fs-rename-重命名"><a href="#5-7-fs-rename-重命名" class="headerlink" title="5.7 fs.rename 重命名"></a>5.7 fs.rename 重命名</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">const fs = require(&#x27;fs&#x27;) </span><br><span class="line"></span><br><span class="line">fs.rename(&#x27;js/hello.log&#x27;, &#x27;js/greeting.log&#x27;, (error) = &gt;&#123;</span><br><span class="line">    if (error) &#123;</span><br><span class="line">        console.log(error)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        console.log(&#x27; 重命名成功&#x27;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="5-8-fs-rmdir-删除目录"><a href="#5-8-fs-rmdir-删除目录" class="headerlink" title="5.8 fs.rmdir 删除目录"></a>5.8 fs.rmdir 删除目录</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fs.rmdir(&#x27;logs&#x27;, (error) = &gt;&#123;</span><br><span class="line">    if (error) &#123;</span><br><span class="line">        console.log(error)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        console.log(&#x27;成功的删除了目录:logs&#x27;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="5-9-fs-unlink-删除文件"><a href="#5-9-fs-unlink-删除文件" class="headerlink" title="5.9 fs.unlink 删除文件"></a>5.9 fs.unlink 删除文件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">fs.unlink(`logs / $ &#123;</span><br><span class="line">    file</span><br><span class="line">&#125;`, (error) = &gt;&#123;</span><br><span class="line">    if (error) &#123;</span><br><span class="line">        console.log(error)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        console.log(`成功的删除了文件: $ &#123;</span><br><span class="line">            file</span><br><span class="line">        &#125;`)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="5-10-fs-createReadStream-从文件流中读取数据"><a href="#5-10-fs-createReadStream-从文件流中读取数据" class="headerlink" title="5.10 fs.createReadStream 从文件流中读取数据"></a>5.10 fs.createReadStream 从文件流中读取数据</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">const fs = require(&#x27;fs&#x27;) </span><br><span class="line"></span><br><span class="line">var fileReadStream = fs.createReadStream(&#x27;data.json&#x27;) </span><br><span class="line">let count = 0;</span><br><span class="line">var str = &#x27;&#x27;;</span><br><span class="line"></span><br><span class="line">fileReadStream.on(&#x27;data&#x27;, (chunk) = &gt;&#123;</span><br><span class="line">    console.log(`$ &#123;++count</span><br><span class="line">    &#125;接收到: $ &#123;</span><br><span class="line">        chunk.length</span><br><span class="line">    &#125;`);</span><br><span class="line">    str += chunk</span><br><span class="line">&#125;) </span><br><span class="line"></span><br><span class="line">fileReadStream.on(&#x27;end&#x27;, () = &gt;&#123;</span><br><span class="line">    console.log(&#x27;--- 结束 ---&#x27;);</span><br><span class="line">    console.log(coun t);</span><br><span class="line">    console.log(str);</span><br><span class="line">&#125;) </span><br><span class="line"></span><br><span class="line">fileReadStream.on(&#x27;error&#x27;, (error) = &gt;&#123;</span><br><span class="line">    console.log(error)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="5-11-fs-createWriteStream-写入文件"><a href="#5-11-fs-createWriteStream-写入文件" class="headerlink" title="5.11 fs.createWriteStream 写入文件"></a>5.11 fs.createWriteStream 写入文件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">var fs = require(&quot;fs&quot;);</span><br><span class="line">var data = &#x27;我是从数据库获取的数据，我要保存起来&#x27;;</span><br><span class="line">// 创建一个可以写入的流，写入到文件 output.txt 中</span><br><span class="line">var writerStream = fs.createWriteStream(&#x27;output.txt&#x27;); // 使用 utf8 编码写入数据</span><br><span class="line"></span><br><span class="line">writerStream.write(data, &#x27;UTF8&#x27;); // 标记文件末尾</span><br><span class="line">writerStream.end();</span><br><span class="line">// 处理流事件 --&gt; finish 事件</span><br><span class="line">writerStream.on(&#x27;finish&#x27;,</span><br><span class="line">function() &#123;</span><br><span class="line">    /*finish - 所有数据已被写入到底层系统时触发。*/</span><br><span class="line">    console.log(&quot;写入完 成。&quot;);</span><br><span class="line">&#125;);</span><br><span class="line">writerStream.on(&#x27;error&#x27;,</span><br><span class="line">function(err) &#123;</span><br><span class="line">    console.log(err.stack);</span><br><span class="line">&#125;);</span><br><span class="line">console.log(&quot;程序执 行完毕&quot;);</span><br></pre></td></tr></table></figure>

<h2 id="5-12-管道流"><a href="#5-12-管道流" class="headerlink" title="5.12 管道流"></a>5.12 管道流</h2><blockquote>
<p>管道提供了一个输出流到输入流的机制。通常我们用于从一个流中获取数据并将数据传递到另外一个流中。</p>
</blockquote>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/364.png" alt="img"></p>
<blockquote>
<p>如上面的图片所示，我们把文件比作装水的桶，而水就是文件里的内容 ，我们用一根管子(pipe )连接两个桶使得水从一个桶流入另一个桶，这样就慢慢的实现了大文件的复制过程。</p>
</blockquote>
<p>以下实例我们通过读取一个文件内容并将内容写入到另外一个文件中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">var fs = require(&quot;fs&quot;);</span><br><span class="line">// 创建一个可读流</span><br><span class="line">var readerStream = fs.createReadStream(&#x27;input.txt&#x27;); // 创建一个可写流</span><br><span class="line">var writerStream = fs.createWriteStream(&#x27;output.txt&#x27;);</span><br><span class="line"></span><br><span class="line">// 管道读写操作</span><br><span class="line">// 读取 input.txt 文件内容，并将内容写入到 output.txt 文件中 </span><br><span class="line">readerStream.pipe(writerStream);</span><br><span class="line">console.log(&quot;程 序执行完毕&quot;);</span><br></pre></td></tr></table></figure>

<h1 id="六、创建一个-WEB-服务器"><a href="#六、创建一个-WEB-服务器" class="headerlink" title="六、创建一个 WEB 服务器"></a>六、创建一个 WEB 服务器</h1><blockquote>
<p>利用HTTP模块 URl模块 PATH模块 FS 模块创建一个 WEB 服务器</p>
</blockquote>
<p><strong>1. Node.js 创建的第一个应用</strong></p>
<blockquote>
<p>引入 http 模块</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var http = require(&quot;http&quot;);</span><br></pre></td></tr></table></figure>

<p><strong>2. 创建服务器</strong></p>
<blockquote>
<p>接下来我们使用 <code>http.createServer()</code> 方法创建服务器，并使用 <code>listen</code> 方法绑定 <code>8888</code> 端口。 函数通过 <code>request</code>, <code>response</code> 参数来接收和响应数据</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">//1.引入 http 模块</span><br><span class="line">var http=require(&#x27;http&#x27;);</span><br><span class="line"></span><br><span class="line">//2.用 http 模块创建服务</span><br><span class="line">http.createServer(fun ction(req, res) &#123;</span><br><span class="line">    // 发送 HTTP 头部</span><br><span class="line">    // HTTP 状态值: 200 : OK</span><br><span class="line">    //设置 HTTP 头部，状态码是 200，文件类型是 html，字符集是 utf-8</span><br><span class="line">    res.writeHead(200, &#123;</span><br><span class="line">        &quot;Content-Type&quot;: &quot;text/html;charset=&#x27;utf-8&#x27;&quot;</span><br><span class="line">    &#125;);</span><br><span class="line">    res.write(&#x27;你好 nodejs&#x27;);</span><br><span class="line">    res.write(&#x27;我是第一个 nodejs 程序&#x27;);</span><br><span class="line">    res.end();</span><br><span class="line">    /*结束响应*/</span><br><span class="line">&#125;).listen(8001);</span><br></pre></td></tr></table></figure>

<p><strong>3. WEB 服务器介绍</strong></p>
<blockquote>
<p>Web 服务器一般指网站服务器，是指驻留于因特网上某种类型计算机的程序，可以向浏览 器等 Web 客户端提供文档，也可以放置网站文件，让全世界浏览;可以放置数据文件，让 全世界下载。目前最主流的三个 Web 服务器是 Apache Nginx IIS。</p>
</blockquote>
<h1 id="七、Nodejs-的非阻塞-I-x2F-O、异步、事件驱动"><a href="#七、Nodejs-的非阻塞-I-x2F-O、异步、事件驱动" class="headerlink" title="七、Nodejs 的非阻塞 I&#x2F;O、异步、事件驱动"></a>七、Nodejs 的非阻塞 I&#x2F;O、异步、事件驱动</h1><h2 id="7-1-Nodejs的单线程-非阻塞I-x2F-O事件驱动"><a href="#7-1-Nodejs的单线程-非阻塞I-x2F-O事件驱动" class="headerlink" title="7.1 Nodejs的单线程 非阻塞I&#x2F;O事件驱动"></a>7.1 Nodejs的单线程 非阻塞I&#x2F;O事件驱动</h2><ul>
<li>在 Java、PHP 或者.net 等服务器端语言中，会为每一个客户端连接创建一个新的线程。 而每个线程需要耗费大约 2MB 内存。也就是说，理论上，一个 8GB 内存的服务器可以同时 连接的最大用户数为 4000 个左右。要让 Web 应用程序支持更多的用户，就需要增加服务器 的数量，而 Web 应用程序的硬件成本当然就上升了</li>
<li>Node.js 不为每个客户连接创建一个新的线程，而仅仅使用一个线程。当有用户连接了， 就触发一个内部事件，通过非阻塞 I&#x2F;O、事件驱动机制，让 Node.js 程序宏观上也是并行的。 使用 Node.js，一个 8GB 内存的服务器，可以同时处理超过 4 万用户的连接。</li>
</ul>
<h2 id="7-2-Nodejs-回调处理异步"><a href="#7-2-Nodejs-回调处理异步" class="headerlink" title="7.2 Nodejs 回调处理异步"></a>7.2 Nodejs 回调处理异步</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">//错误的写法:</span><br><span class="line">function getData()&#123; </span><br><span class="line">    //模拟请求数据 </span><br><span class="line">    var result=&#x27;&#x27;;</span><br><span class="line">    setTimeout(functio n ()&#123; </span><br><span class="line">        result=&#x27;这是请求到的 数据&#x27;</span><br><span class="line">    &#125;,200);</span><br><span class="line">    </span><br><span class="line">    return result; </span><br><span class="line">&#125;</span><br><span class="line">console .log(getData());/*异步导致请求不到数据*/</span><br><span class="line">//正确的处理异步:</span><br><span class="line">function getData(callback) &#123; //模拟请求数据</span><br><span class="line">    var result = &#x27;&#x27;;</span><br><span class="line">    setTimeout(function() &#123;</span><br><span class="line">        result = &#x27;这是请求到的 数据&#x27;;</span><br><span class="line">        callback(result);</span><br><span class="line">    &#125;,</span><br><span class="line">    200);</span><br><span class="line">&#125;</span><br><span class="line">getData(function(data) &#123;</span><br><span class="line">    console.log(data);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="7-3-Nodejs-events-模块处理异步"><a href="#7-3-Nodejs-events-模块处理异步" class="headerlink" title="7.3 Nodejs events 模块处理异步"></a>7.3 Nodejs events 模块处理异步</h2><blockquote>
<p><code>Node.js</code> 有多个内置的事件，我们可以通过引入 <code>events</code> 模块，并通过实例化 <code>EventEmitter</code> 类来绑定和监听事件。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 引入 events 模块</span><br><span class="line">var events = require(&#x27;events&#x27;);</span><br><span class="line">var Even tEmitter =new event s .EventEmitter() ; /*实例化事件对象*/</span><br><span class="line">EventEmitter.on(&#x27;toparent&#x27;,function()&#123; console.log(&#x27;接收到了广播事件&#x27;);</span><br><span class="line">&#125;)</span><br><span class="line">setTimeout(function ()&#123;</span><br><span class="line">    console.log(&#x27;广播&#x27;);</span><br><span class="line">    EventEmitter.emit(&#x27;toparent&#x27; ); /*发送广播*/ </span><br><span class="line">&#125;,1000)</span><br></pre></td></tr></table></figure>

<h1 id="八、静态文件托管-GET-POST路由EJS模板引擎"><a href="#八、静态文件托管-GET-POST路由EJS模板引擎" class="headerlink" title="八、静态文件托管 GET POST路由EJS模板引擎"></a>八、静态文件托管 GET POST路由EJS模板引擎</h1><h2 id="8-1-路由"><a href="#8-1-路由" class="headerlink" title="8.1 路由"></a>8.1 路由</h2><blockquote>
<p>路由指的就是针对不同请求的 URL，处理不同的业务逻辑。</p>
</blockquote>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/365.png" alt="img"></p>
<h2 id="8-2-初识-EJS-模块引擎"><a href="#8-2-初识-EJS-模块引擎" class="headerlink" title="8.2 初识 EJS 模块引擎"></a>8.2 初识 EJS 模块引擎</h2><blockquote>
<p>我们学的 EJS 是后台模板，可以把我们数据库和文件读取的数据显示到 Html 页面上面。它 是一个第三方模块，需要通过 npm 安装</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install ejs –save / cnpm install ejs --save</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Nodejs 中使用:</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ejs.renderFile(filename, data, options, function(err, str)&#123;</span><br><span class="line">// str =&gt; Rendered HTML string</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>EJS 常用标签</strong></p>
<ul>
<li><code>&lt;%%&gt;</code>流程控制标签</li>
<li><code>&lt;%=%&gt;</code>输出标签(原文输出HTML标签)</li>
<li><code>&lt;%-%&gt;</code>输出标签(HTML会被浏览器解析)</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=&quot;&lt;%= url %&gt;&quot;&gt;&lt;img src=&quot;&lt;%= imageURL %&gt;&quot; alt=&quot;&quot;&gt;&lt;/a&gt;&lt;ul&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"> &lt;head&gt;&lt;/head&gt;</span><br><span class="line"> &lt;body&gt;</span><br><span class="line">  &lt;ul&gt;</span><br><span class="line">    &amp;lt;% for(var i = 0 ; i &amp;lt; news.length ; i++)&#123; %&amp;gt; </span><br><span class="line">   &lt;li&gt;&amp;lt;%= news[i] %&amp;gt;&lt;/li&gt; &amp;lt;% &#125; %&amp;gt; </span><br><span class="line">  &lt;/ul&gt;</span><br><span class="line"> &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h2 id="8-3-Get、Post"><a href="#8-3-Get、Post" class="headerlink" title="8.3 Get、Post"></a>8.3 Get、Post</h2><ul>
<li>超文本传输协议(HTTP)的设计目的是保证客户端机器与服务器之间的通信</li>
<li>在客户端和服务器之间进行请求-响应时，两种最常被用到的方法是:GET 和 POST<ul>
<li>GET - 从指定的资源请求数据。(一般用于获取数据)</li>
<li>POST - 向指定的资源提交要被处理的数据。(一般用于提交数据)</li>
</ul>
</li>
</ul>
<p><strong>获取 GET 传值:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var urlinfo=url.parse(req.url,true); </span><br><span class="line">urlinfo.query();</span><br></pre></td></tr></table></figure>

<p><strong>获取 POST 传值:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">var postData = &#x27;&#x27;; </span><br><span class="line"></span><br><span class="line">// 数据块接收中</span><br><span class="line">req.on(&#x27;data&#x27;,</span><br><span class="line">function(postDataChunk) &#123;</span><br><span class="line">    postData += postDataChunk;</span><br><span class="line">&#125;);</span><br><span class="line">// 数据接收完毕，执行回调函数</span><br><span class="line">req.on(&#x27;end&#x27;,</span><br><span class="line">function() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        postData = JSON.parse(postData);</span><br><span class="line">    &#125; catch(e) &#123;&#125;</span><br><span class="line">    req.query = postData;</span><br><span class="line">    console.log(q uerystring.parse(postData));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h1 id="九、MongoDb-数据库介绍、安装、使用"><a href="#九、MongoDb-数据库介绍、安装、使用" class="headerlink" title="九、MongoDb 数据库介绍、安装、使用"></a>九、MongoDb 数据库介绍、安装、使用</h1><h2 id="9-1-数据库和文件的主要区别"><a href="#9-1-数据库和文件的主要区别" class="headerlink" title="9.1 数据库和文件的主要区别"></a>9.1 数据库和文件的主要区别</h2><ul>
<li>数据库有数据库表、行和列的概念，让我们存储操作数据更方便</li>
<li>数据库提供了非常方便的接口，可以让 <code>nodejs</code>、<code>php</code> <code>java</code> <code>.net</code> 很方便的实现增加修改删除功能</li>
</ul>
<h2 id="9-2-NoSql-介绍"><a href="#9-2-NoSql-介绍" class="headerlink" title="9.2 NoSql 介绍"></a>9.2 NoSql 介绍</h2><h3 id="9-2-1-NoSQL-介绍"><a href="#9-2-1-NoSQL-介绍" class="headerlink" title="9.2.1 NoSQL 介绍"></a>9.2.1 NoSQL 介绍</h3><ul>
<li>由于互联网的迅速发展，云计算与 Web2.0。这样大量的交互给数据库提出了更高的性能要<br>求，传统的数据库(本文泛指 SQL 数据库)，即关系数据库虽然具备良好的事物管理，<br>但在 处理大量数据 的应用 时很难 在性能 上满足 设计要 求。NoSQL 就是主要为了解决当下大量高并发高要求的数据 库应用 需求，关系数 据库 具有严 格的参 照性，一致性 ，可用 性，原子性 ，隔离 性等特 点</li>
<li>因此会产生一些例如表连接等操作，这样会大大降低系统的性能。而在当前很多应用场景下对性能的要求 远远强 于传统 数据库 关注的 点，<code>NoSQL</code>就是为了解决大规模数据与多样数 据种类 等问题，尤其是其中大数据的相关问题。</li>
<li><code>NoSQL</code>(<code>NoSQL = Not Only SQL</code> )，意即“不仅仅是 SQL”，它指的是非关系型的数据库，是以 <code>key-value</code><br>形式存储，和传统的关系型数据库不一样，不一定遵循传统数据库的一些基本要求，比如说遵循SQL 标准ACID 属性、表结构等等。<code>NoSQL</code> 最早被提出是在 20 世纪 80 年代，在当时更多是强调的是与关系数据库区 别对待 ，最近这些年被提及的更多是强调协助解决大数据等相关问题。<code>NoSQL</code> 在大数据时代有自己的意义</li>
</ul>
<h3 id="9-2-2-NoSQL-应用情况介绍"><a href="#9-2-2-NoSQL-应用情况介绍" class="headerlink" title="9.2.2 NoSQL 应用情况介绍"></a>9.2.2 NoSQL 应用情况介绍</h3><blockquote>
<p>国内的互联网蓬勃发展，不仅涌现出 BAT(百度，阿里巴巴，腾讯)之类的巨头，也带动了整个互联 网行业的发展，大量的创业型公司如春笋般的涌出，在国家层面也提出了“互联网+”和“万众创业”的口 号。更多传统的行业也开始拥抱互联网。但是无论是做所谓的生态平台还是 传统业务的转型，涉及到的业务是多种多样的。这个时候企业架构师对于应用系统的核心——数据库管理 不仅有传统的 SQL 选项也有了 NoSQL这种适合特定场景需求的选项</p>
</blockquote>
<p><strong>NoSQL 数据库在以下的这几种情况下比较适用</strong></p>
<ul>
<li>数据模型比较简单</li>
<li>需要灵活性更强的 IT 系统</li>
<li>对数据库性能要求较高</li>
<li>不需要高度的数据一致性</li>
<li>对于给定 key，比较容易映射复杂值的环境</li>
</ul>
<p><strong>NoSQL 发展现状</strong></p>
<ul>
<li>国外: Google 的 BigTable 和 Amazon 的 Dynamo 使用的就是 NoSQL 型数据库。</li>
<li>国内:百度、阿里、腾讯、新浪微博、视觉中国、优酷运营数据分析、飞信空间、豆瓣社区等</li>
</ul>
<h2 id="9-3-什么时候建议使用-NoSql"><a href="#9-3-什么时候建议使用-NoSql" class="headerlink" title="9.3 什么时候建议使用 NoSql"></a>9.3 什么时候建议使用 NoSql</h2><ul>
<li>对数据库高并发读写的需求</li>
<li>对海量数据的高效率存储和访问的需求</li>
<li>对数据库的高可扩展性和高可用性的需求</li>
</ul>
<h2 id="9-4-NoSql-和传统数据库简单对比"><a href="#9-4-NoSql-和传统数据库简单对比" class="headerlink" title="9.4 NoSql 和传统数据库简单对比"></a>9.4 NoSql 和传统数据库简单对比</h2><ul>
<li>非结构型数据库。没有行、列的概念。用 JSON 来存储数据。</li>
<li>集合就相当于“表 ”，文档就相当于“行”。</li>
</ul>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/366.png" alt="img"></p>
<h2 id="9-5-NoSql-种类"><a href="#9-5-NoSql-种类" class="headerlink" title="9.5 NoSql 种类"></a>9.5 NoSql 种类</h2><p><img src="https://poetries1.gitee.io/img-repo/2019/10/367.png" alt="img"></p>
<h2 id="9-6-MongoDb-介绍"><a href="#9-6-MongoDb-介绍" class="headerlink" title="9.6 MongoDb 介绍"></a>9.6 MongoDb 介绍</h2><blockquote>
<p>MongoDB 是一个介于关系数据库和非关系数据库之间的产品，是非关系数据库当中功能最丰富，最像 关系数据库的。他支持的数据结构非常松散，是类似 json 的 bson 格式，因此可以存储比较复杂的数据类 型。Mongo 最大的特点是他支持的查询语言非常强大，其语法有点类似于面向对象的查询语言，几乎可以 实现类似关系数据库单表查询的绝大部分功能，而且还支持对数据建立索引。它的特点是高 性能 、易部署 、 易使用 ，存储数据非常 方便</p>
</blockquote>
<h2 id="9-7-MongoDb-安装"><a href="#9-7-MongoDb-安装" class="headerlink" title="9.7 MongoDb 安装"></a>9.7 MongoDb 安装</h2><ul>
<li>官网:<a target="_blank" rel="noopener" href="https://www.mongodb.com/">https://www.mongodb.com/</a></li>
<li>手册:<a target="_blank" rel="noopener" href="https://docs.mongodb.org/manual/">https://docs.mongodb.org/manual/</a></li>
</ul>
<p><strong>1. 双击 MongoDB 软件下一步下一步安装</strong></p>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/368.png" alt="img"></p>
<p><strong>2. 安装完成配置环境变量 C:\Program Files\MongoDB\Server\3.0\bin 加入到系统的path 环境变量中</strong></p>
<p><strong>3. 打开 cmd 输入 :mongo命令看看是否成功。如果出来下图说明 mongodb配置成功。</strong></p>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/369.png" alt="img"></p>
<h2 id="9-8-使用-MongoDb"><a href="#9-8-使用-MongoDb" class="headerlink" title="9.8 使用 MongoDb"></a>9.8 使用 MongoDb</h2><ol>
<li>新建一个存放数据库的文件夹，注意:不能有中文和空格，建议不要放在 C 盘</li>
<li>启动 MongoDb 服务</li>
</ol>
<blockquote>
<p>服务端:<code>mongod</code> 开启数据库服务 <code>mongod --dbpath C:\mongodb</code></p>
</blockquote>
<p><strong>开启 MongoDb 服务命令:</strong></p>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/370.png" alt="img"></p>
<ul>
<li><code>--dbpath</code> 就是选择数据库文档所在的文件夹</li>
<li>也就是说，<code>mongoDB</code> 中，真的有物理文件，对应一个个数据库。U 盘可以拷走。</li>
<li>注意:一定要保持，开机这个 CMD 不能动了，不能关，不能 <code>ctrl+c</code>。 一旦这个 <code>cmd</code> 有问题了，数据库就自动关闭了</li>
</ul>
<ol>
<li>客户端输入 <code>mongo</code> 命令连接服务端</li>
</ol>
<blockquote>
<p>客户端:<code>mongo</code> 使用数据库</p>
</blockquote>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/371.png" alt="img"></p>
<blockquote>
<p>客户端:<code>mongo</code> 使用数据库 <code>ip</code> 地址:端口号</p>
</blockquote>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/372.png" alt="img"></p>
<h1 id="十、MongoDB-数据库创建删除、表（集合）创建删除、数据增删改查"><a href="#十、MongoDB-数据库创建删除、表（集合）创建删除、数据增删改查" class="headerlink" title="十、MongoDB 数据库创建删除、表（集合）创建删除、数据增删改查"></a>十、MongoDB 数据库创建删除、表（集合）创建删除、数据增删改查</h1><h2 id="10-1-数据库使用"><a href="#10-1-数据库使用" class="headerlink" title="10.1 数据库使用"></a>10.1 数据库使用</h2><blockquote>
<p>开启 <code>mongodb</code> 服务:要管理数据库，必须先开启服务，开启服务使用 <code>mongod --dbpath c:\mongodb</code></p>
</blockquote>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/373.png" alt="img"></p>
<blockquote>
<p>管理 <code>mongodb</code> 数据库:<code>mongo</code> (一定要在新的 <code>cmd</code> 中输入)</p>
</blockquote>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/374.png" alt="img"></p>
<blockquote>
<p>查看所有数据库列 表</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show dbs</span><br></pre></td></tr></table></figure>

<h2 id="10-2-创建数据库"><a href="#10-2-创建数据库" class="headerlink" title="10.2 创建数据库"></a>10.2 创建数据库</h2><p><img src="https://poetries1.gitee.io/img-repo/2019/10/375.png" alt="img"></p>
<p><strong>使用数据库、创建 数据库</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use student</span><br></pre></td></tr></table></figure>

<ul>
<li>如果真的想把这个数据库创建成功，那么必须插入一个数据</li>
<li>数据库中不能直接插入数据，只能往集合(collectio ns)中插入数 据。不需要专门创建集合，只需要写点语法插入数据就会创建集合:</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.student.insert(&#123;“name”:”x iaom ing”&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>db.student 系统发现 student 是一个陌生的集合名字，所以就自动创建了集合</li>
</ul>
<p><strong>显示当前的数据集合(mysql 中叫表)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show collections</span><br></pre></td></tr></table></figure>

<p><strong>删除数据库，删除当前所在的数据库</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.dropDatabase();</span><br></pre></td></tr></table></figure>

<p><strong>删除集合，删除指定的集合删除表</strong></p>
<blockquote>
<p>删除集合</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.COLLECTION_NAME.drop()</span><br><span class="line"></span><br><span class="line">db.user.drop()</span><br></pre></td></tr></table></figure>

<h2 id="10-3-插入-增加-数据"><a href="#10-3-插入-增加-数据" class="headerlink" title="10.3 插入(增加)数据"></a>10.3 插入(增加)数据</h2><blockquote>
<p>插入数据，随着数据的插入，数据库创建成功了，集合也创建成功了。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.表名.insert(&#123;&quot;name&quot;:&quot;zhangsan&quot;&#125;);</span><br><span class="line"></span><br><span class="line">student 集合名称(表)</span><br></pre></td></tr></table></figure>

<h2 id="10-4-查找数据"><a href="#10-4-查找数据" class="headerlink" title="10.4 查找数据"></a>10.4 查找数据</h2><p><strong>1. 查询所有记 录</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.userInfo.find();</span><br></pre></td></tr></table></figure>

<blockquote>
<p>相当于:<code>select* from userInfo;</code></p>
</blockquote>
<p><strong>2. 查询去掉后 的当前聚集集合中的某列的重复数据</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.userInfo.distinct(&quot;name&quot;);</span><br></pre></td></tr></table></figure>

<ul>
<li>会过滤掉 <code>name</code> 中的相同数据</li>
<li>相当于:<code>select distict name from userInfo;</code></li>
</ul>
<p><strong>3. 查询 age &#x3D; 22 的记录</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.userInfo.find(&#123;&quot;age&quot;: 22&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>相当于: <code>select * from userInfo where age = 22;</code></p>
</blockquote>
<p><strong>4. 查询 age &gt; 22 的记录</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.userInfo.find(&#123;age: &#123;$gt: 22&#125;&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>相当于:<code>select * from userInfo where age &gt;22;</code></p>
</blockquote>
<p><strong>5. 查询 age &lt; 22 的记录</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.userInfo.find(&#123;age: &#123;$lt: 22&#125;&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>相当于:<code>select * from userInfo where age &lt;22;</code></p>
</blockquote>
<p><strong>6. 查询 age &gt;&#x3D; 25 的记录</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.userInfo.find(&#123;age: &#123;$gte: 25&#125;&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>相当于:<code>select * from userInfo where age &gt;= 25;</code></p>
</blockquote>
<p><strong>7. 查询 age &lt;&#x3D; 25 的记录</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.userInfo.find(&#123;age: &#123;$lte: 25&#125;&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>8. 查询 age &gt;&#x3D; 23 并且 age &lt;&#x3D; 26</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.userInfo.find(&#123;age: &#123;$gte: 23, $lte: 26&#125;&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>9. 查询name中包含 mongo的数据,模糊查询用于搜索</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.userInfo.find(&#123;name: /mongo/&#125;);</span><br><span class="line">//相当于%%</span><br><span class="line">select * from userInfo where name like ‘%mongo%’;</span><br></pre></td></tr></table></figure>

<p><strong>10. 查询 name 中以 mongo 开头的</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.userInfo.find(&#123;name: /^mongo/&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from userInfo where name like ‘mongo%’;</span><br></pre></td></tr></table></figure>
</blockquote>
<p><strong>11. 查询指定列 name、age 数据</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.userInfo.find(&#123;&#125;, &#123;name: 1, age: 1&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>相当于:<code>select name, age from userInfo;</code></p>
</blockquote>
<blockquote>
<p>当然 <code>name</code> 也可以用 <code>true</code> 或 <code>false</code>,当用 <code>ture</code> 的情况下河 <code>name:1</code> 效果一样，如果用 <code>false</code> 就 是排除 <code>name</code>，显示 <code>name</code> 以外的列信息</p>
</blockquote>
<p><strong>12. 查询指定列 name、age 数据, age &gt; 25</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.userInfo.find(&#123;age: &#123;$gt: 25&#125;&#125;, &#123;name: 1, age: 1&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>相当于:<code>select name, age from userInfo where age &gt;25;</code></p>
</blockquote>
<p><strong>13. 按照年龄排序 1 升序 -1 降序</strong></p>
<ul>
<li>升序:<code>db.userInfo.find().sort(&#123;age: 1&#125;);</code></li>
<li>降序:<code>db.userInfo.find().sort(&#123;age: -1&#125;);</code></li>
</ul>
<p><strong>14. 查询 name &#x3D; zhangsan, age &#x3D; 22 的数据</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.userInfo.find(&#123;name: &#x27;zhangsan&#x27;, age: 22&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>相当于:<code>select * from userInfo where name = ‘zhangsan’ and age = ‘22’;</code></p>
</blockquote>
<p><strong>15. 查询前 5 条数据</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.userInfo.find().limit(5 );</span><br></pre></td></tr></table></figure>

<blockquote>
<p>相当于:<code>selecttop 5 * from userInfo;</code></p>
</blockquote>
<p><strong>16. 查询 10 条以后的数据</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.userInfo.find().skip(10);</span><br><span class="line">// 相当于:</span><br><span class="line">select * from userInfo where id not in ( </span><br><span class="line">    selecttop 10 * from userInfo</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><strong>17. 查询在 5-10 之间的数据</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.userInfo.find().limit (10).skip(5);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可用于分页，<code>limit</code> 是 <code>pageSize</code>，<code>skip</code> 是第几页<code>*pageSize</code></p>
</blockquote>
<p><strong>18. or与 查询</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.userInfo.find(&#123;$or: [&#123;age: 22&#125;, &#123;age: 25&#125;]&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>相当于:<code>select * from userInfo where age = 22 or age = 25;</code></p>
</blockquote>
<p><strong>19. findOne 查询第一条数据</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.userInfo.findOne( );</span><br></pre></td></tr></table></figure>

<blockquote>
<p>相当于:<code>selecttop 1 * from userInfo;</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.userInfo.find().limit(1 );</span><br></pre></td></tr></table></figure>

<p><strong>20. 查询某 个结果集的记录条数 统计数量</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.userInfo.find(&#123;age: &#123;$gte: 25&#125;&#125;).count();</span><br></pre></td></tr></table></figure>

<blockquote>
<p>相当于:<code>select count(*) from userInfo where age &gt;= 20;</code></p>
</blockquote>
<blockquote>
<p>如果要返回限制之后的记录数量，要使用 <code>count(true)</code>或者 <code>count</code>(非 <code>0</code>)</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.users.find().skip(1 0).limit(5).count(true);</span><br></pre></td></tr></table></figure>

<h2 id="10-5-修改数据"><a href="#10-5-修改数据" class="headerlink" title="10.5 修改数据"></a>10.5 修改数据</h2><blockquote>
<p>修改里面还有查询条件。你要该谁，要告诉 <code>mongo</code></p>
</blockquote>
<p><strong>查找名字叫做小明的，把年龄更改为 16 岁</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.student.update(&#123;&quot;name&quot;:&quot;小明&quot;&#125;,&#123;$set:&#123;&quot;ag e&quot;:16&#125;&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>查找数学成绩是 70，把年龄更改为 33 岁:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.student.update(&#123;&quot;sc ore.shuxue&quot;:70&#125;,&#123;$set:&#123;&quot;ag e&quot;:33&#125;&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>更改所有匹配项目</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.student.update(&#123;&quot;sex&quot;:&quot;男&quot;&#125;,&#123;$set:&#123;&quot;age&quot;:33&#125;&#125;,&#123;multi: true&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>完整替换，不出现$set 关键字了: 注意</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.student.update(&#123;&quot;name&quot;:&quot;小明&quot;&#125;,&#123;&quot;name&quot;:&quot;大明&quot;,&quot;age&quot;:16&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.users.update(&#123;name: &#x27;Lisi&#x27;&#125;, &#123;$inc: &#123;age: 50&#125;&#125;, false, true);` 相当于:`update users set age = age + 50 where name = ‘Lisi’;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.users.update(&#123;name: &#x27;Lisi&#x27;&#125;, &#123;$inc: &#123;age: 50&#125;, $set: &#123;name: &#x27;hoho&#x27;&#125;&#125;, false, true);` 相当于: `update users set age = age + 50, name = ‘hoho’ where name = ‘Lisi’;</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="10-6-删除数据"><a href="#10-6-删除数据" class="headerlink" title="10.6 删除数据"></a>10.6 删除数据</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.collectionsNames.remove( &#123; &quot;borough&quot;: &quot;Manhattan&quot; &#125; )</span><br><span class="line"></span><br><span class="line">db.users.remove(&#123;age: 132&#125;);</span><br><span class="line"></span><br><span class="line">db.restaurants.remove( &#123; &quot;borough&quot;: &quot;Queens&quot; &#125;, &#123; justOne: true &#125; )</span><br></pre></td></tr></table></figure>

<h1 id="十一、MongoDB-索引-explain-分析查询速度"><a href="#十一、MongoDB-索引-explain-分析查询速度" class="headerlink" title="十一、MongoDB 索引 explain 分析查询速度"></a>十一、MongoDB 索引 explain 分析查询速度</h1><h2 id="11-1-索引基础"><a href="#11-1-索引基础" class="headerlink" title="11.1 索引基础"></a>11.1 索引基础</h2><blockquote>
<p>索引是对数据库表中一列或多列的值进行排序的一种结构，可以让我们查询数据库变得 更快。MongoDB 的索引几乎与传统的关系型数据库一模一样，这其中也包括一些基本的查 询优化技巧。</p>
</blockquote>
<p><strong>下面是创建索引的 命令</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.user.ensureIndex( &#123;&quot;username&quot;:1&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>获取当前集合的索 引</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.user.getIndexes()</span><br></pre></td></tr></table></figure>

<p><strong>删除索引的命令是</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.user.dropIndex( &#123;&quot;username&quot;:1&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>在 MongoDB 中，我们同样可以创建复合索引，如:</li>
<li>数字 <code>1</code> 表示 <code>username</code> 键的索引按升序存储，<code>-1</code> 表示 <code>age</code> 键的索引按照降序方式存储</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.user.ensureIndex(&#123;&quot;username&quot;:1, &quot;age&quot;:-1&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>该索引被创建后，基于 username 和 age 的查询将会用到该索引，或者是基于 username 的查询也会用到该索引，但是只是基于 age 的查询将不会用到该复合索引。因此可以说，如果想用到复合索引，必须在查询条件中包含复合索引中的前 N个索引列。然而如果查询条件中的键值顺序和复合索引中的创建顺序不一致的话，MongoDB 可以智能的帮助我们调整该顺序，以便使复合索引可以为查询所用。如:</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.user.find(&#123;&quot;age&quot;: 30, &quot;username&quot;: &quot;stephen&quot;&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>对于上面示例中的查询条件，MongoDB 在检索之前将会动态的调整查询条件文档的顺 序，以使该查询可以用到刚刚创建的复合索引。</p>
</blockquote>
<blockquote>
<p>对于上面创建的索引，MongoDB 都会根据索引的 keyname 和索引方向为新创建的索引自动分配一个索引名，下面的命令可以在创建索引时为其指定索引名，如:</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.user.ensureIndex( &#123;&quot;username&quot;:1&#125;,&#123;&quot;name&quot;:&quot;userindex&quot;&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>随着集合的增长，需要针对查询中大量的排序做索引。如果没有对索引的键调用 <code>sort</code>， <code>MongoDB</code> 需要将所有数据提取到内存并排序。因此在做无索引排序时，如果数据量过大以 致无法在内存中进行排序，此时 <code>MongoDB</code> 将会报错</p>
</blockquote>
<h2 id="11-2-唯一索引"><a href="#11-2-唯一索引" class="headerlink" title="11.2 唯一索引"></a>11.2 唯一索引</h2><blockquote>
<p>在缺省情况下创建的索引均不是唯一索引。下面的示例将创建唯一索引，如</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.user.ensureIndex( &#123;&quot;useri d&quot;:1&#125;,&#123;&quot;uniq ue&quot;:true&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果再次插入 userid 重复的文档时，MongoDB 将报错，以提示插入重复键，如:</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.user.insert(&#123;&quot;userid&quot;:5&#125;) </span><br><span class="line">db.user.insert(&#123;&quot;userid&quot;:5&#125;)</span><br><span class="line"></span><br><span class="line">// E11000 duplicate key error index: user.user.$userid_1 dup key: &#123; : 5.0 &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果插入的文档中不包含 userid 键，那么该文档中该键的值为 null，如果多次插入类似 的文档，MongoDB 将会报出同样的错误，如:</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.user.insert(&#123;&quot;userid1&quot;:5&#125;) </span><br><span class="line">db.user.insert(&#123;&quot;userid1&quot;:5&#125;)</span><br><span class="line"></span><br><span class="line">// E11000 duplicate key error index: user.user.$userid_1 dup key: &#123; : null &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果在创建唯一索引时已经存在了重复项，我们可以通过下面的命令帮助我们在创建唯 一索引时消除重复文档，仅保留发现的第一个文档，如:</p>
</blockquote>
<p><strong>先删除刚刚创建的唯一索引</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.user.dropIndex( &#123;&quot; userid&quot; :1&#125; )</span><br></pre></td></tr></table></figure>

<p><strong>插入测试数据，以保证集合中有重复键存在。</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.user.remove() </span><br><span class="line">db.user.insert(&#123;&quot;userid&quot;:5&#125;)</span><br><span class="line">db.user.insert(&#123;&quot;userid&quot;:5&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>重新创建唯一索引</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.user.ensureIndex(&#123;&quot;userid&quot;:1&#125;,&#123;&quot;unique&quot;:true &#125;)</span><br></pre></td></tr></table></figure>

<p><strong>我们同样可以创建 复合唯一索引，即保证复合键值唯一 即可。如:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.user.ensureIndex( &#123;&quot;useri d&quot;:1,&quot;age&quot;:1&#125;,&#123;&quot;unique&quot;:true&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="11-3-索引的一些参数"><a href="#11-3-索引的一些参数" class="headerlink" title="11.3 索引的一些参数"></a>11.3 索引的一些参数</h2><p><img src="https://upload-images.jianshu.io/upload_images/1480597-450216a694af3946.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<blockquote>
<p>如果在为已有数据的文档创建索引时，可以执行下面的命令，以使 MongoDB 在后台创 建索引，这样的创建时就不会阻塞其他操作。但是相比而言，以阻 塞方式创建索引，会使整 个创建过程效率更高，但是在创建时 MongoDB 将无法接收其他的操作</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.user.ensureIndex( &#123;&quot;username&quot;:1&#125;,&#123;&quot;backgroun d&quot;:true&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="11-4-使用-explain"><a href="#11-4-使用-explain" class="headerlink" title="11.4 使用 explain"></a>11.4 使用 explain</h2><blockquote>
<p>explain 是非常有用的工具，会帮助你获得查询方面诸多有用的信息。只要对游标调用 该方法，就可以得到查询细节。explain 会返回一个文档，而不是游标本身。如</p>
</blockquote>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/376.png" alt="img"></p>
<blockquote>
<p><code>explain</code> 会返回查询使用的索引情况，耗时和扫描文档数的统计信息</p>
</blockquote>
<h2 id="11-5-explain-executionStats-查询具体的执行-时间"><a href="#11-5-explain-executionStats-查询具体的执行-时间" class="headerlink" title="11.5 explain executionStats 查询具体的执行 时间"></a>11.5 explain executionStats 查询具体的执行 时间</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.tablename.find().explain( &quot;executionStats&quot; )</span><br></pre></td></tr></table></figure>

<blockquote>
<p>关注输出的如下数值:<code>explain.executionStats.executionTimeMillis</code></p>
</blockquote>
<h1 id="十二、nodejs操作mongodb3-x数据库的方法"><a href="#十二、nodejs操作mongodb3-x数据库的方法" class="headerlink" title="十二、nodejs操作mongodb3.x数据库的方法"></a>十二、nodejs操作mongodb3.x数据库的方法</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">//http://mongodb.github.io/node-mongodb-native/3.0/quick-start/quick-start/</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">nodejs操作mongodb数据库</span><br><span class="line"></span><br><span class="line"> 1.安装mongodb、</span><br><span class="line"></span><br><span class="line">    cnpm install mongodb --save</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> 2.引入mongodb下面的MongoClient</span><br><span class="line">    var MongoClient = require(&#x27;mongodb&#x27;).MongoClient;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> 3.定义数据库连接的地址 以及配置数据库</span><br><span class="line">    qianfeng数据库的名称</span><br><span class="line"></span><br><span class="line">    var url = &#x27;mongodb://localhost:27017/&#x27;;</span><br><span class="line"></span><br><span class="line">    var dbName = &#x27;shop&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> 4.nodejs连接数据库</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> MongoClient.connect(url,function(err,client)&#123;</span><br><span class="line"></span><br><span class="line">        const db = client.db(dbName);  数据库db对象</span><br><span class="line"></span><br><span class="line"> &#125;)</span><br><span class="line"></span><br><span class="line">5.操作数据库</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	 MongoClient.connect(url,function(err,client)&#123;</span><br><span class="line"></span><br><span class="line">			const db = client.db(dbName);  数据库db对象</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">			MongoClient.connect(url,function(err,db)&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">				db.collection(&#x27;user&#x27;).insertOne(&#123;&quot;name&quot;:&quot;张三&quot;&#125;,function(err,result)&#123;</span><br><span class="line"></span><br><span class="line">					db.close() //关闭连接</span><br><span class="line">				&#125;)</span><br><span class="line"></span><br><span class="line">		     &#125;)</span><br><span class="line"></span><br><span class="line">	 &#125;)</span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">*/</span><br><span class="line">var MongoClient = require(&#x27;mongodb&#x27;).MongoClient;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//定义连接数据库的地址</span><br><span class="line"></span><br><span class="line">const  url = &#x27;mongodb://localhost:27017/&#x27;;</span><br><span class="line">var dbName = &#x27;shop&#x27;</span><br><span class="line"></span><br><span class="line">//连接数据库</span><br><span class="line">MongoClient.connect(url,(err,client)=&gt;&#123;</span><br><span class="line"></span><br><span class="line">    if(err)&#123;</span><br><span class="line">        console.log(&#x27;数据连接失败&#x27;);</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    let db=client.db(dbName);   /*获取db对象*/</span><br><span class="line"></span><br><span class="line">    db.collection(&quot;admin&quot;).insertOne(&#123;&quot;name&quot;:&quot;mongodb3.0&quot;,&quot;age&quot;:10&#125;,function(err)&#123;</span><br><span class="line"></span><br><span class="line">        if(err)&#123;</span><br><span class="line">            console.log(&#x27;增加失败&#x27;);</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        console.log(&#x27;增加成功&#x27;);</span><br><span class="line">        client.close();  /*关闭数据库*/</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="十三、NodeJs操作MongoDb数据库-数据的增加-修改-删除"><a href="#十三、NodeJs操作MongoDb数据库-数据的增加-修改-删除" class="headerlink" title="十三、NodeJs操作MongoDb数据库 数据的增加 修改 删除"></a>十三、NodeJs操作MongoDb数据库 数据的增加 修改 删除</h1><h2 id="13-1-在-Nodejs-中使用-Mongodb"><a href="#13-1-在-Nodejs-中使用-Mongodb" class="headerlink" title="13.1 在 Nodejs 中使用 Mongodb"></a>13.1 在 Nodejs 中使用 Mongodb</h2><blockquote>
<p>前面的课程我们讲了用命令操作 <code>MongoDB</code>，这里我们看下如何用 <code>nodejs</code> 来操作数据库</p>
</blockquote>
<p><strong>需要引包</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install mongodb --save-dev / cnpm install mongodb --save-dev</span><br></pre></td></tr></table></figure>

<h2 id="13-2-Nodejs-连接-MongoDb-数据库"><a href="#13-2-Nodejs-连接-MongoDb-数据库" class="headerlink" title="13.2 Nodejs 连接 MongoDb 数据库"></a>13.2 Nodejs 连接 MongoDb 数据库</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">var express = require(&quot;express&quot;); //数据库引用</span><br><span class="line"></span><br><span class="line">var MongoClient = require(&#x27;mongodb&#x27;).MongoClient;</span><br><span class="line">var app = express();</span><br><span class="line">//数据库连接的地址，最后的斜杠表示数据库名字</span><br><span class="line">var shujukuURL = &#x27;mongodb://localhost:27017/news&#x27;;</span><br><span class="line">app.get(&quot;/&quot;, fu nction(req, res) &#123; //连接数据库，这是一个异步的操作</span><br><span class="line">    MongoClient.connect(shujukuURL,</span><br><span class="line">    function(err, db) &#123;</span><br><span class="line">        res.writeHe ad(200, &#123;</span><br><span class="line">            &quot;Content-Type&quot;: &quot; text/html;charset =UTF8&quot;</span><br><span class="line">        &#125;);</span><br><span class="line">        if (err) &#123;</span><br><span class="line">            res.send(&quot;数据库连接失 败&quot;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        res.write(&quot;恭喜，数据库已经成功连接 \n&quot;);</span><br><span class="line">        db.collection(&quot;user&quot;).insertOne(&#123;</span><br><span class="line">            &quot;name&quot;: &quot;哈哈&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        functio n(err, result) &#123;</span><br><span class="line">            if (err) &#123;</span><br><span class="line">                res.send(&quot;数据库写入 失败&quot;);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            res.write(&quot;恭喜，数据 已经成功插入&quot;);</span><br><span class="line">            res.end();</span><br><span class="line">            //关闭数据库</span><br><span class="line">            db.close();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(8020);</span><br></pre></td></tr></table></figure>

<h2 id="13-3-Nodejs-查找-MongoDb-数据库集合"><a href="#13-3-Nodejs-查找-MongoDb-数据库集合" class="headerlink" title="13.3 Nodejs 查找 MongoDb 数据库集合"></a>13.3 Nodejs 查找 MongoDb 数据库集合</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">MongoClient.connect(dbUrl,</span><br><span class="line">function(err, db) &#123;</span><br><span class="line">    if (err) &#123;</span><br><span class="line">        /*数据库连接失败*/</span><br><span class="line">        console.log(&#x27;数据库连接失败&#x27;);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    var result = [];</span><br><span class="line">    var userRel = db.collection(&#x27;user&#x27;).find();</span><br><span class="line">    //res.send(userRel);</span><br><span class="line">    userRel.each(function(err, doc) &#123;</span><br><span class="line">        if (err) &#123;</span><br><span class="line">            res.write(&quot;游标遍历错 误&quot;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if (doc != null) &#123;</span><br><span class="line">            result.push(doc);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            console.log(result); //遍历完毕</span><br><span class="line">            db.close();</span><br><span class="line">            res.render(&quot;index&quot;, &#123;</span><br><span class="line">                &quot;result&quot;: result</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="13-4-Nodejs-给-MongoDb-增加数据"><a href="#13-4-Nodejs-给-MongoDb-增加数据" class="headerlink" title="13.4 Nodejs 给 MongoDb 增加数据"></a>13.4 Nodejs 给 MongoDb 增加数据</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">MongoClient.connect(dbUrl,</span><br><span class="line">function(err, db) &#123;</span><br><span class="line">    if (err) &#123;</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line">    db.collection(&#x27;user&#x27;).insertOne(&#123;</span><br><span class="line">        &quot;name&quot;: name,</span><br><span class="line">        &quot;age&quot;: age,</span><br><span class="line">        &quot;score&quot;: &#123;</span><br><span class="line">            &quot;shuxue&quot;: shuxuechengji,</span><br><span class="line">            &quot;yuwen&quot;: yuwenchengji</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    function(err, result) &#123;</span><br><span class="line">        if (err) &#123;</span><br><span class="line">            console.log(&#x27;写入数据失败&#x27;);</span><br><span class="line">        &#125;</span><br><span class="line">        //关闭数据库</span><br><span class="line">        db.close();</span><br><span class="line">        //res.redirect(&#x27;/add&#x27;); res.redirect(&#x27;/&#x27; ); /*路由跳转*/ res.end(); ////res.location(&#x27;/add&#x27;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="13-5-Nodejs-修改-MongoDb-数据"><a href="#13-5-Nodejs-修改-MongoDb-数据" class="headerlink" title="13.5 Nodejs 修改 MongoDb 数据"></a>13.5 Nodejs 修改 MongoDb 数据</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">MongoClient.connect(dbUrl,</span><br><span class="line">function(err, db) &#123;</span><br><span class="line">    if (err) &#123;</span><br><span class="line">        console.log(&#x27;数据库连接错误&#x27;);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    db.collection(&#x27;user&#x27;).updateOne(&#123;</span><br><span class="line">        &quot;_id&quot;: ObjectID(id)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;name&quot;: name,</span><br><span class="line">        &quot;age&quot;: age,</span><br><span class="line">        &quot;score&quot;: &#123;</span><br><span class="line">            &quot;shuxue&quot;: shuxue,</span><br><span class="line">            &quot;yuwen&quot;: yuwen</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    function(err, results) &#123;</span><br><span class="line">        console.log(results);</span><br><span class="line">        db.close();</span><br><span class="line">        res.redirect(&#x27;/&#x27;);</span><br><span class="line">        /*路由跳转*/</span><br><span class="line">        res.end(&#x27;end&#x27;);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="13-6-Nodejs-删除-MongoDb-数据"><a href="#13-6-Nodejs-删除-MongoDb-数据" class="headerlink" title="13.6 Nodejs 删除 MongoDb 数据"></a>13.6 Nodejs 删除 MongoDb 数据</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MongoClient.connect(dbUrl,</span><br><span class="line">function(err, db) &#123;</span><br><span class="line">    if (err) &#123;</span><br><span class="line">        throw new Error(&quot;数据库连接失败&quot;);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    db.collection(&#x27;user&#x27;).deleteOne(&#123;</span><br><span class="line">        &quot;_id&quot;: ObjectID(id)</span><br><span class="line">    &#125;,</span><br><span class="line">    func tion(error, result) &#123;</span><br><span class="line">        if (error) &#123;</span><br><span class="line">            throw new Error(&#x27;删除数据失败&#x27;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        db.close();</span><br><span class="line">        res.redirect(&#x27;/&#x27;);</span><br><span class="line">        /*路由跳转*/</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="十四、Express-安装和使用"><a href="#十四、Express-安装和使用" class="headerlink" title="十四、Express 安装和使用"></a>十四、Express 安装和使用</h1><h2 id="14-1-Express-简单介绍"><a href="#14-1-Express-简单介绍" class="headerlink" title="14.1 Express 简单介绍"></a>14.1 Express 简单介绍</h2><ul>
<li>Express 是一个基于 Node.js 平台，快速、开放、极简的 web 开发框架</li>
<li>Express 框架是后台的 Node 框架，所以和 jQuery、zepto、yui、bootstrap 都不一个东西。 Express 在后台的受欢迎的程度类似前端的 jQuery，就是企业的事实上的标准。</li>
</ul>
<p><strong>Express 特点</strong></p>
<ul>
<li><code>Express</code> 是一个基于 <code>Node.js</code> 平台的极简、灵活的 web 应用开发框架，它提供一<br>系列强大的特性，帮助你创建各种 <code>Web</code> 和移动设备应用</li>
<li>丰富的 HTTP 快捷方法和任意排列组合的 <code>Connect</code> 中间件，让你创建健壮、友好的 API 变得既快速又简单</li>
<li><code>Express</code> 不对 <code>Node.js</code> 已有的特性进行二次抽象，我们只是在它之上扩展了 Web应用所需的基本功能</li>
</ul>
<h2 id="14-2-Express-安装使用"><a href="#14-2-Express-安装使用" class="headerlink" title="14.2 Express 安装使用"></a>14.2 Express 安装使用</h2><p><strong>安装:</strong></p>
<blockquote>
<p>安装 Express 框架，就是使用 npm 的命令</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install express --save</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>--save</code> 参数，表示自动修改 <code>package.json</code> 文件，自动添加依赖项</p>
</blockquote>
<p><strong>简单使用</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">npm install express–save //1.引入</span><br><span class="line">var express = require(&#x27;express&#x27;);</span><br><span class="line">var app = express();</span><br><span class="line">//2.配置路由</span><br><span class="line">app.get(&#x27;/&#x27;,</span><br><span class="line">function(req, res) &#123;</span><br><span class="line">    res.send(&#x27;Hello World!&#x27;);</span><br><span class="line">&#125;); //3.监听端口</span><br><span class="line"></span><br><span class="line">app.listen(3000,&#x27;127.0.0.1&#x27;);</span><br></pre></td></tr></table></figure>

<p><strong>完整 Demo</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">var express = require(&#x27;express&#x27;);</span><br><span class="line">/*引入 express*/</span><br><span class="line">var app = newexpress();</span><br><span class="line">/*实例化express 赋值给app*/</span><br><span class="line">//配置路由 匹配 URl 地址实现不同的功能</span><br><span class="line">app.get(&#x27;/&#x27;,</span><br><span class="line">function(req, res) &#123;</span><br><span class="line">    res.send(&#x27;首页&#x27;);</span><br><span class="line">&#125;) </span><br><span class="line"></span><br><span class="line">app.get(&#x27;/search&#x27;,</span><br><span class="line">function(req, res) &#123;</span><br><span class="line">    res.send(&#x27;搜索&#x27;); //?keyword=华为手机&amp;enc=utf-8&amp;suggest=1.his.0.0&amp;wq</span><br><span class="line">&#125;) </span><br><span class="line"></span><br><span class="line">app.get(&#x27;/login&#x27;,</span><br><span class="line">function(req, res) &#123;</span><br><span class="line">    res.send(&#x27;登录&#x27;);</span><br><span class="line">&#125;) </span><br><span class="line"></span><br><span class="line">app.get(&#x27;/register&#x27;,</span><br><span class="line">function(req, res) &#123;</span><br><span class="line">    res.send(&#x27;注册&#x27;);</span><br><span class="line">&#125;) </span><br><span class="line"></span><br><span class="line">app.listen(3000, &quot;127.0.0.1&quot;);</span><br></pre></td></tr></table></figure>

<h2 id="14-3-Express-框架中的路由"><a href="#14-3-Express-框架中的路由" class="headerlink" title="14.3 Express 框架中的路由"></a>14.3 Express 框架中的路由</h2><blockquote>
<p>路由(Routing)是由一个 URI(或者叫路径)和一个特定的 HTTP 方法(GET、POST 等) 组成的，涉及到应用如何响应客户端对某个网站节点的访问</p>
</blockquote>
<p><strong>简单的路由配置</strong></p>
<blockquote>
<p>当用 get 请求访问一个网址的时候，做什么事情</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.get(&quot;网址&quot;,function(req,res)&#123;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>当用 post 访问一个网址的时候，做什么事情:</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">app.post(&quot;网址&quot;,function(req,res)&#123;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line">// user 节点接受 PUT 请求</span><br><span class="line"></span><br><span class="line">app.put(&#x27;/user&#x27;, function (req, res) &#123;</span><br><span class="line">    res.send(&#x27;Got a PUT request at /user&#x27;); </span><br><span class="line">&#125;);</span><br><span class="line">// user 节点接受 DELETE 请求</span><br><span class="line"></span><br><span class="line">app.delete(&#x27;/user&#x27;, function (req, res) &#123;</span><br><span class="line">    res.send(&#x27;Got a DELETE request at /user&#x27;); </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>动态路由配置:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.get( ,function(req,res)&#123; </span><br><span class="line">    var id = req.params[&quot;id&quot;];</span><br><span class="line">    res.send(id); </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>路由的正则匹配:(了解)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.get(&#x27;/ab*cd&#x27;, function(req, res) &#123; </span><br><span class="line">    res.send(&#x27;ab*cd&#x27;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>路由里面获取 Get 传值</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// /news?id=2&amp;sex=nan</span><br><span class="line"></span><br><span class="line">app.get(&#x27;/news, function(req, res) &#123; </span><br><span class="line">    console.log(req.query);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="14-4-Express-框架中-ejs-的安装使用"><a href="#14-4-Express-框架中-ejs-的安装使用" class="headerlink" title="14.4 Express 框架中 ejs 的安装使用"></a>14.4 Express 框架中 ejs 的安装使用</h2><p><strong>Express 中 ejs 的安装:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">npm install ejs --save </span><br><span class="line"></span><br><span class="line">// 或者:</span><br><span class="line">npm install ejs --save-dev</span><br></pre></td></tr></table></figure>

<p><strong>Express 中 ejs 的使用</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">var express = require(&quot;express&quot;);</span><br><span class="line">var app = express();</span><br><span class="line">app.set(&quot;view engine&quot;, &quot;ejs&quot;);</span><br><span class="line"></span><br><span class="line">app.get(&quot;/&quot;,</span><br><span class="line">    function(req, res) &#123;&#125;);</span><br><span class="line">        res.render(&quot;news&quot;, &#123;</span><br><span class="line">            &quot;news&quot;: [&quot;我是小新闻啊&quot;, &quot;我也是啊&quot;, &quot;哈哈哈哈&quot;]</span><br><span class="line">&#125;);</span><br><span class="line">app.listen(3000);</span><br></pre></td></tr></table></figure>

<p><strong>指定模板位置 ，默认模板位置在 views</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.set(&#x27;views&#x27;, __dirname + &#x27;/views&#x27;);</span><br></pre></td></tr></table></figure>

<p><strong>Ejs 引入模板</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%- include header.ejs %&gt;</span><br></pre></td></tr></table></figure>

<p><strong>Ejs 绑定数据</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%=h%&gt;</span><br></pre></td></tr></table></figure>

<p><strong>Ejs 绑定 html 数据</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%-h%&gt;</span><br></pre></td></tr></table></figure>

<p><strong>Ejs 模板判断语句</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;% if(true)&#123; %&gt; </span><br><span class="line">    &lt;div&gt;true&lt;/div&gt;</span><br><span class="line">    &lt;%&#125; </span><br><span class="line">  else&#123; %&gt; </span><br><span class="line">    &lt;div&gt;false&lt; /di v&gt;</span><br><span class="line">&lt;%&#125; %&gt;</span><br></pre></td></tr></table></figure>

<p><strong>Ejs 模板中循环数据</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;%for(var i=0;i&lt;list.length;i++) &#123; %&gt;</span><br><span class="line">    &lt;li&gt;&lt;%=list[i] %&gt;&lt;/li&gt;</span><br><span class="line">&lt;%&#125;%&gt;</span><br></pre></td></tr></table></figure>

<p><strong>Ejs 后缀修改为 Html</strong></p>
<blockquote>
<p>这是一个小技巧，看着<code>.ejs</code> 的后缀总觉得不爽，使用如下方法，可以将模板文件的后缀换成我们习惯的<code>.html</code></p>
</blockquote>
<ol>
<li>在 <code>app.js</code> 的头上定义 <code>ejs</code>:,代码如下:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var ejs = require(&#x27;ejs&#x27;);</span><br></pre></td></tr></table></figure>

<ol>
<li>注册 html 模板引擎代码如下:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.engine(&#x27;html&#x27;,ejs.__express);</span><br></pre></td></tr></table></figure>

<ol>
<li>将模板引擎换成 html代码如下:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.set(&#x27;view engine&#x27;, &#x27;html&#x27;);</span><br></pre></td></tr></table></figure>

<ol>
<li>修改模板文件的后缀为 <code>.html</code></li>
</ol>
<h2 id="14-5-利用-Express-static-托管静态文件"><a href="#14-5-利用-Express-static-托管静态文件" class="headerlink" title="14.5 利用 Express.static 托管静态文件"></a>14.5 利用 Express.static 托管静态文件</h2><ol>
<li>如果你的静态资源存放在多个目录下面，你可以多次调用 <code>express.static</code> 中间件:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.use(express.static(&#x27;public&#x27;));</span><br></pre></td></tr></table></figure>

<blockquote>
<p>现在，public 目录下面的文件就可以访问了</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:3000/images/kitten.jpg</span><br><span class="line">http://localhost:3000/css/style.css </span><br><span class="line">http://localhost:3000/js/app.js</span><br><span class="line">http://localhost:3000/images/bg.png h</span><br><span class="line">ttp://localhost:3000/hello.html</span><br></pre></td></tr></table></figure>

<ol>
<li>如果你希望所有通过 <code>express.static</code> 访问的文件都存放在一个“虚拟(virtual)”目 录(即目录根本不存在)下面，可以通过为静态资源目录指定一个挂载路径的方式来实现，如下所示</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.use(&#x27;/static&#x27;, express.static(&#x27;public&#x27;));</span><br></pre></td></tr></table></figure>

<blockquote>
<p>现在，你就爱可以通过带有 “&#x2F;static” 前缀的地址来访问 public 目录下 面的文件了</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:3000/static/images/kitten.jpg</span><br><span class="line">http://localhost:3000/static/css/style.css http://localhost:3000/static/js/app.js http://localhost:3000/static/images/bg.png</span><br><span class="line">http://localhost:3000/static/hello.html</span><br></pre></td></tr></table></figure>

<h2 id="14-6-Express-中间件"><a href="#14-6-Express-中间件" class="headerlink" title="14.6 Express 中间件"></a>14.6 Express 中间件</h2><ul>
<li><code>Express</code> 是一个自身功能极简，完全是由路由和中间件构成一个的 web 开发框架:从<br>本质上来说，一个 <code>Express</code> 应用就是在调用各种中间件</li>
<li>中间件(<code>Middleware</code>) 是一个函数，它可以访问请求对象(request object (req)), 响 应对象(response object (res)), 和 web 应用中处理请求-响应循环流程中的中间件，一般 被命名为 next 的变量</li>
</ul>
<p><strong>中间件的功能包括</strong></p>
<ul>
<li>执行任何代码</li>
<li>修改请求和响应对象</li>
<li>终结请求-响应循环</li>
<li>调用堆栈中的下一个中间件</li>
</ul>
<blockquote>
<p>如果我的 <code>get</code>、<code>post</code> 回调函数中，没有 <code>next</code> 参数，那么就匹配上第一个路由，就不会往下匹 配了。如果想往下匹配的话，那么需要写 <code>next()</code></p>
</blockquote>
<p><strong>Express 应用可使用如下几种中间件</strong></p>
<ul>
<li>应用级中间件</li>
<li>路由级中间件</li>
<li>错误处理中间件</li>
<li>内置中间件</li>
<li>第三方中间件</li>
</ul>
<ol>
<li>应用级中间件</li>
</ol>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/377.png" alt="img"></p>
<ol>
<li>路由中间件</li>
</ol>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/378.png" alt="img"></p>
<ol>
<li>错误处理中间件</li>
</ol>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/379.png" alt="img"></p>
<ol>
<li>内置中间件</li>
</ol>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/380.png" alt="img"></p>
<ol>
<li>第三方中间件</li>
</ol>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/381.png" alt="img"><br><img src="https://poetries1.gitee.io/img-repo/2019/10/382.png" alt="img"></p>
<h2 id="14-7-获取-Get-Post-请求的参数"><a href="#14-7-获取-Get-Post-请求的参数" class="headerlink" title="14.7 获取 Get Post 请求的参数"></a>14.7 获取 Get Post 请求的参数</h2><ul>
<li><code>GET</code> 请求的参数在 <code>URL</code> 中，在原生 <code>Node</code> 中，需要使用 <code>url</code> 模块来识别参数字符串。在<code>Express</code> 中，不需要使用 <code>url</code> 模块了。可以直接使用 <code>req.query</code> 对象</li>
<li><code>POST</code> 请求在 <code>express</code> 中不能直接获得，可以使用 <code>body-parser</code> 模块。使用后，将可以用<code>req.body</code>得到参数。但是如果表单中含有文件上传，那么还是需要使用 <code>formidable</code> 模块</li>
</ul>
<p><strong>1. 安装</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install body-parser</span><br></pre></td></tr></table></figure>

<p><strong>2. 使用 req.body 获取 post 过来的参数</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">var express = require(&#x27;express&#x27;) </span><br><span class="line">var bodyParser = require(&#x27;body-parser&#x27;) </span><br><span class="line">var app = express()</span><br><span class="line"></span><br><span class="line">// parse application/x-www-form-urlencoded</span><br><span class="line">app.use(bodyParser.urlencoded(&#123;</span><br><span class="line">    extended: false</span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line">// parse application/json</span><br><span class="line">app.use(bodyParser.json()) </span><br><span class="line"></span><br><span class="line">app.use(function(req, res) &#123;</span><br><span class="line">    res.setHeader(&#x27;Content-Type&#x27;, &#x27;text/plain&#x27;) res.write(&#x27;you posted:\n&#x27;) res.end(JSON.stringify(req.body, null, 2))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="十五、express中间件cookie的基本使用"><a href="#十五、express中间件cookie的基本使用" class="headerlink" title="十五、express中间件cookie的基本使用"></a>十五、express中间件cookie的基本使用</h1><h2 id="15-1-Cookie-简介"><a href="#15-1-Cookie-简介" class="headerlink" title="15.1 Cookie 简介"></a>15.1 Cookie 简介</h2><p><img src="https://poetries1.gitee.io/img-repo/2019/10/383.png" alt="img"></p>
<h2 id="15-2-Cookie-特点"><a href="#15-2-Cookie-特点" class="headerlink" title="15.2 Cookie 特点"></a>15.2 Cookie 特点</h2><ul>
<li><code>cookie</code> 保存在浏览器本地</li>
<li>正常设置的 <code>cookie</code> 是不加密的，用户可以自由看到;</li>
<li>用户可以删除 <code>cookie</code>，或者禁用它</li>
<li><code>cookie</code> 可以被篡改</li>
<li><code>cookie</code> 可以用于攻击</li>
<li><code>cookie</code> 存储量很小。未来实际上要被 <code>localStorage</code> 替代，但是后者 <code>IE9</code> 兼容</li>
</ul>
<h2 id="15-3-Cookie-的使用"><a href="#15-3-Cookie-的使用" class="headerlink" title="15.3 Cookie 的使用"></a>15.3 Cookie 的使用</h2><p><img src="https://poetries1.gitee.io/img-repo/2019/10/384.png" alt="img"><br><img src="https://poetries1.gitee.io/img-repo/2019/10/385.png" alt="img"><br><img src="https://poetries1.gitee.io/img-repo/2019/10/386.png" alt="img"></p>
<p><strong>设置 cookie</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">res.cookie(&#x27;rememberme&#x27;, &#x27;1&#x27;, &#123; maxAge: 900000, httpOnly: true &#125;)</span><br><span class="line"></span><br><span class="line">res.cookie(&#x27;name&#x27;, &#x27;tobi&#x27;, &#123; domain: &#x27;.example.com&#x27;, path: &#x27;/admin&#x27;, secure: true &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">res.cookie(&#x27;rememberme&#x27;, &#x27;1&#x27;, &#123; expires: new Date(Date.now() + 900000), httpOnly: true &#125;);</span><br></pre></td></tr></table></figure>

<p><strong>获取 cookie</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">req.cookies.name</span><br></pre></td></tr></table></figure>

<p><strong>删除 cookie</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">res.cookie(&#x27;rememberme&#x27;, &#x27;&#x27;, &#123; expires: new Date(0)&#125;);</span><br><span class="line"></span><br><span class="line">res.cookie(&#x27;username&#x27;,&#x27;zhangsan&#x27;,&#123;domain:&#x27;.ccc.com&#x27;,maxAge:0,httpOnly:true&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="15-4-加密-Cookie"><a href="#15-4-加密-Cookie" class="headerlink" title="15.4 加密 Cookie"></a>15.4 加密 Cookie</h2><p><strong>1. 配置中间件的时候需要传参</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var cookieParser = require(&#x27;cookie-parser&#x27;);</span><br><span class="line"></span><br><span class="line">app.use(cookieParser(&#x27;123456&#x27;));</span><br></pre></td></tr></table></figure>

<p><strong>2. 设置 cookie 的时候配置 signed 属性</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res.c ookie(&#x27;userinfo&#x27;,&#x27;hahaha&#x27;,&#123;domain:&#x27;.c cc.c om&#x27;,maxAge :900000,httpOnly :true,signed :true&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>3. signedCookies 调用设置的 cookie</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">console.log(req.signedCookies);</span><br></pre></td></tr></table></figure>

<h1 id="十六、express中间件express-session常见参数配置使用"><a href="#十六、express中间件express-session常见参数配置使用" class="headerlink" title="十六、express中间件express-session常见参数配置使用"></a>十六、express中间件express-session常见参数配置使用</h1><h2 id="16-1-Session-简单介绍"><a href="#16-1-Session-简单介绍" class="headerlink" title="16.1 Session 简单介绍"></a>16.1 Session 简单介绍</h2><blockquote>
<p><code>session</code> 是另一种记录客户状态的机制，不同的是 <code>Cookie</code>保存在客户端浏览器中，而 <code>session</code> 保存在服<br>务器上</p>
</blockquote>
<p><strong>Session 的用途</strong></p>
<ul>
<li><code>session</code> 运行在服务器端，当客户端第一次访问服务器时，可以将客户的登录信息保存</li>
<li>当客户访问其他页面时，可以判断客户的登录状态，做出提示，相当于登录拦截</li>
<li><code>session</code> 可以和 <code>Redis</code>或者数据库等结合做持久化操作，当服务器挂掉时也不会导致某些客户信息(购物车)<br>丢失。</li>
</ul>
<h2 id="16-2-Session-的工作流程"><a href="#16-2-Session-的工作流程" class="headerlink" title="16.2 Session 的工作流程"></a>16.2 Session 的工作流程</h2><blockquote>
<p>当浏览器访问服务器并发送第一次请求时，服务器端会创建一个 session 对象，生成一个类似于 key,value 的键值对，然后将 key(cookie)返回到浏览器(客户)端，浏览器下次再访问时，携带 key(cookie)， 找到对应的 session(value)。 客户的信息都保存在 session 中</p>
</blockquote>
<h2 id="16-3-express-session-的使用"><a href="#16-3-express-session-的使用" class="headerlink" title="16.3 express-session 的使用"></a>16.3 express-session 的使用</h2><p><strong>1. 安装 express-session</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm install express-session --save</span><br></pre></td></tr></table></figure>

<p><strong>2. 引入 express-session</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var session = require(&quot;express-session&quot;);</span><br></pre></td></tr></table></figure>

<p><strong>3. 设置官方文档提供的中间件</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.use(session(&#123;</span><br><span class="line">    secret: &#x27;keyboard cat&#x27;,</span><br><span class="line">    resave: true,</span><br><span class="line">    saveUninitialized: true</span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure>

<p><strong>4. 使用</strong></p>
<ul>
<li>设置值 <code>req.session.username = &quot;张三&quot;;</code></li>
<li>获取值 <code>req.session.username</code></li>
</ul>
<h2 id="16-4-express-session-的常用参数"><a href="#16-4-express-session-的常用参数" class="headerlink" title="16.4 express-session 的常用参数"></a>16.4 express-session 的常用参数</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">app.use(session(&#123;</span><br><span class="line">    secret: &#x27;12345&#x27;,</span><br><span class="line">    name: &#x27;name&#x27;,</span><br><span class="line">    cookie: &#123;</span><br><span class="line">        maxAge: 60000</span><br><span class="line">    &#125;,</span><br><span class="line">    resave: false,</span><br><span class="line">    saveUninitialized: true</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>

<p><strong>行加密的字符串.这个</strong></p>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/387.png" alt="img"><br><img src="https://poetries1.gitee.io/img-repo/2019/10/388.png" alt="img"></p>
<h2 id="16-5-express-session-的常用方法"><a href="#16-5-express-session-的常用方法" class="headerlink" title="16.5 express-session 的常用方法"></a>16.5 express-session 的常用方法</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">req.session.destroy(function(err) &#123;</span><br><span class="line">    /*销毁 session*/</span><br><span class="line">&#125;) </span><br><span class="line">req.session.username = &#x27;张三&#x27;; //设置 session req.session.username //获取 </span><br><span class="line"></span><br><span class="line">session req.session.cookie.maxAge=0; //重新设置 cookie 的过期时间</span><br></pre></td></tr></table></figure>

<h2 id="16-6-负载均衡配置-Session，把-Session-保存到数据库-里面"><a href="#16-6-负载均衡配置-Session，把-Session-保存到数据库-里面" class="headerlink" title="16.6 负载均衡配置 Session，把 Session 保存到数据库 里面"></a>16.6 负载均衡配置 Session，把 Session 保存到数据库 里面</h2><ol>
<li>需要安装<code>express-session</code> 和 <code>connect-mongo</code>模块</li>
<li>引入模块</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var session = require(&quot;express-session&quot;);</span><br><span class="line"></span><br><span class="line">const MongoStore = require(&#x27;connect-mongo&#x27;)(session);</span><br></pre></td></tr></table></figure>

<ol>
<li>配置中间件</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">app.use(session(&#123;</span><br><span class="line">    secret: &#x27;keyboard cat&#x27;,</span><br><span class="line">    resave: false,</span><br><span class="line">    saveUninitialized: true,</span><br><span class="line">    rolling:true,</span><br><span class="line">    cookie:&#123;</span><br><span class="line">        maxAge:100000</span><br><span class="line">    &#125;,</span><br><span class="line">    store: new MongoStore(&#123;</span><br><span class="line">        url: &#x27;mongodb://127.0.0.1:27017/student&#x27;,</span><br><span class="line">        touchAfter: 24 * 3600 // time period in seconds</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure>

<h2 id="16-7-Cookie-和-Session-区别"><a href="#16-7-Cookie-和-Session-区别" class="headerlink" title="16.7 Cookie 和 Session 区别"></a>16.7 Cookie 和 Session 区别</h2><ol>
<li><code>cookie</code> 数据存放在客户的浏览器上，<code>session</code> 数据放在服务器上</li>
<li><code>cookie</code> 不是很安全，别人可以分析存放在本地的 <code>COOKIE</code> 并进行 <code>COOKIE</code> 欺骗 考虑到安全应当使用 <code>session</code></li>
<li><code>session</code> 会在一定时间内保存在服务器上。当访问增多，会比较占用你服务器的性能 考虑到减轻服务器性能方面，应当使用 <code>COOKIE</code></li>
<li>单个 <code>cookie</code> 保存的数据不能超过 <code>4K</code>，很多浏览器都限制一个站点最多保存 <code>20</code> 个 <code>cookie</code></li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nodejs/" rel="tag">nodejs</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-nodejs/node-入门" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/05/05/nodejs/node-%E5%85%A5%E9%97%A8/" class="article-date">
  	<time datetime="2019-05-05T10:22:19.000Z" itemprop="datePublished">2019-05-05</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/05/nodejs/node-%E5%85%A5%E9%97%A8/">
        node-入门
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>nodejs是事件驱动、非阻塞I&#x2F;O模型</p>
</blockquote>
<ul>
<li>阻塞：i&#x2F;o时进程休眠等待完成后进行下一步</li>
<li>非阻塞：i&#x2F;o时函数立即返回，进程不等待i&#x2F;o返回</li>
</ul>
<blockquote>
<p>i&#x2F;o完成后通知主程序，如何告诉呢？通过事件驱动</p>
</blockquote>
<p><strong>事件驱动</strong></p>
<ul>
<li>i&#x2F;o等异步操作结束后通知</li>
<li>内部实现是观察者模式</li>
</ul>
<p><strong>CPU密集和I&#x2F;O密集</strong></p>
<ul>
<li><code>CPU</code>密集：压缩、解压、加密、解密</li>
<li><code>I/O</code>密集：文件操作、网络操作、数据库</li>
</ul>
<p><strong>web常见场景(web是一个I&#x2F;O密集)</strong></p>
<ul>
<li>静态资源读取</li>
<li>数据库操作</li>
<li>渲染页面</li>
</ul>
<p><strong>高并发应用之道</strong></p>
<ul>
<li>增加机器数</li>
<li>增加每台机器CPU数-多核</li>
</ul>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/347.png" alt="img"></p>
<p><strong>进程、线程</strong></p>
<ul>
<li>进程：一个运行的程序（进程包括线程，如何水分子里面还有分子原子）</li>
<li>线程：进程内一个独立的，可调度的执行单元</li>
<li>多线程：启动一个进程，在一个进程内启动多个线程，这样多个线程可以执行多个任务</li>
</ul>
<p><strong>Nodejs的单线程</strong></p>
<ul>
<li>单线程只是针对主进程，I&#x2F;O操作系统底层多线程调度</li>
<li>单线程并不是单进程</li>
</ul>
<p><strong>Nodejs原理</strong></p>
<ul>
<li>Node是单线程的，只开一个进程，一个进程也只开一个线程。一个CPU上只开一个进程，一个进程里面只有一个线程</li>
</ul>
<p><strong>nodejs高性能的前提</strong></p>
<ul>
<li>高并发</li>
<li><code>I/O</code>密集</li>
</ul>
<p><strong>常用场景</strong></p>
<ul>
<li><code>web Server</code></li>
<li>本地代码构建 (<code>webpack/grunt/gulp</code>)</li>
<li>使用工具的开发</li>
</ul>
<h2 id="二、nodejs与JavaScrip异同"><a href="#二、nodejs与JavaScrip异同" class="headerlink" title="二、nodejs与JavaScrip异同"></a>二、nodejs与JavaScrip异同</h2><ul>
<li><code>ECMAScript</code></li>
<li>语法</li>
<li>内置对象、方法</li>
</ul>
<p><strong>顶层对象</strong></p>
<ul>
<li><code>JavaScript</code>：<code>window</code></li>
<li><code>nodejs</code>: <code>global</code></li>
<li>在ECMA部分node和JavaScript是一样的，比如数据类型的定义，语法结构、内置对象</li>
</ul>
<h2 id="三、模块"><a href="#三、模块" class="headerlink" title="三、模块"></a>三、模块</h2><ul>
<li>在<code>node</code>中文件和模块是一一对应的，也就是一个文件一个模块。**file是每个模块下必有的一个属性，输出文件的绝对路径。<code>**dirname</code> 是文件夹名称绝对路径</li>
<li>每个模块都有自己的作用域</li>
<li>我们通过var声明的变量并非全局，而是该模块作用域下的</li>
</ul>
<p><strong>模块加载机制</strong></p>
<ul>
<li><code>require</code>加载模块</li>
<li>1、首先按照加载模块的文件名称进行查找</li>
<li>2、如果没有找到就会在文件模块文件名称后加载<code>.js</code>进行查找</li>
<li>3、如果还没有找到，就在文件名称后加载<code>.json</code>后缀，进行查找</li>
<li>4、如果还没找到，就会在文件名称后加上<code>.node</code>进行查找</li>
<li>查找流程：<strong>文件名称-&gt;.js -&gt; .json-&gt;.node</strong></li>
</ul>
<p><strong>exports、module</strong></p>
<ul>
<li>保存当前模块有关的一些信息</li>
<li><code>module.exports</code> 一般使用这个,把一个模块中的变量对外提供访问</li>
<li>在模块作用域，还有一个内置的模块对象，<code>exports</code>其实就是<code>module.exports</code>,他们两个都是指向同一个对象</li>
</ul>
<h2 id="四、node目录的配置"><a href="#四、node目录的配置" class="headerlink" title="四、node目录的配置"></a>四、node目录的配置</h2><ul>
<li><p>配置文件 :</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">package.json</span><br></pre></td></tr></table></figure>

<ul>
<li>dependencies : 当前项目所使用到的依赖模块</li>
<li>安装方式: <code>npm install</code> 自动读取<code>package.json</code>自动安装</li>
</ul>
</li>
<li><p><code>router</code>目录 用来存放路由文件</p>
</li>
<li><p><code>views</code>目录 用来存放<code>html</code>模板文件</p>
</li>
<li><p><code>module</code>目录 自己写的一些模块</p>
</li>
</ul>
<h2 id="五、第一个node服务器"><a href="#五、第一个node服务器" class="headerlink" title="五、第一个node服务器"></a>五、第一个node服务器</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//   安装好node就有的一个模块</span><br><span class="line">//  用来创建http服务器的</span><br><span class="line">const http = require(`http`);</span><br><span class="line"></span><br><span class="line">http.createServer((request,response) =&gt; &#123;</span><br><span class="line">    //request 请求对象     浏览器 请求 服务器所有的内容保存在这个对象里</span><br><span class="line">    //response 响应对象     服务器响应浏览器 所有的方法</span><br><span class="line">    response.writeHead(200 , &#123; &#x27;Content-Type&#x27;:&#x27;text/html&#x27; &#125; );</span><br><span class="line">    //  .end() 结束响应 同时发送一个 Hello Word</span><br><span class="line">    response.end(&#x27;Hello Word&#x27;)</span><br><span class="line">&#125;).listen(233);</span><br><span class="line">//.listen(); 监听端口 233  自定义的端口号</span><br><span class="line">// 如果开启了node服务器  修改完之后的代码必须 重启才能生效</span><br></pre></td></tr></table></figure>


      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nodejs/" rel="tag">nodejs</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-数据库/MongoDB" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/04/07/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/" class="article-date">
  	<time datetime="2019-04-07T12:31:27.000Z" itemprop="datePublished">2019-04-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/07/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/">
        mongodb
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="一、环境搭建"><a href="#一、环境搭建" class="headerlink" title="一、环境搭建"></a>一、环境搭建</h1><h2 id="1-1-mongodb简介"><a href="#1-1-mongodb简介" class="headerlink" title="1.1 mongodb简介"></a>1.1 mongodb简介</h2><ul>
<li><code>MongoDB</code>旨在为WEB应用提供可扩展的高性能数据存储解决方案</li>
<li><code>MongoDB</code> 将数据存储为一个文档，数据结构由键值(<code>key=&gt;value</code>)对组成。<code>MongoDB</code> 文档类似于 <code>JSON</code>对象。字段值可以包含其他文档，数组及文档数组</li>
</ul>
<p><img src="http://www.runoob.com/wp-content/uploads/2013/10/crud-annotated-document.png" alt="img"></p>
<p><strong>主要特点</strong></p>
<ul>
<li>高可扩展性</li>
<li>分布式存储</li>
<li>低成本</li>
<li>结构灵活</li>
</ul>
<h2 id="1-2-window下mongodb环境搭建"><a href="#1-2-window下mongodb环境搭建" class="headerlink" title="1.2 window下mongodb环境搭建"></a>1.2 window下mongodb环境搭建</h2><ul>
<li>下载安装包或压缩包</li>
<li>添加<code>db</code>存储和日志存储文件夹</li>
<li>添加服务、配置环境变量、启动<code>Mongo</code></li>
</ul>
<blockquote>
<p>配置演示</p>
</blockquote>
<ul>
<li>在任意目录创建几个文件夹</li>
</ul>
<p><img src="https://poetries1.gitee.io/img-repo/2019/12/182.png" alt="img"><br><img src="https://poetries1.gitee.io/img-repo/2019/12/183.png" alt="img"></p>
<p><strong>通过命令行启动服务</strong></p>
<blockquote>
<p>配置环境变量</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#  --dbpath指定数据存储位置</span><br><span class="line">C:\Program Files\MongoDB\Server\3.4\bin\mongod --dbpath d:\mongodb\data</span><br></pre></td></tr></table></figure>

<p><img src="https://poetries1.gitee.io/img-repo/2019/12/184.png" alt="img"></p>
<p><strong>通配置启动服务</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># 配置d:\mongodb\etc\mongodb.conf</span><br><span class="line"></span><br><span class="line">#数据库路径</span><br><span class="line">dbpath=d:\mongodb\data\</span><br><span class="line"></span><br><span class="line">#日志输出文件路径</span><br><span class="line">logpath=d:\mongodb\logs\mongodb.log</span><br><span class="line"></span><br><span class="line">#错误日志采用追加模式，配置这个选项后mongodb的日志会追加到现有的日志文件，而不是从新创建一个新文件</span><br><span class="line">logappend=true</span><br><span class="line"></span><br><span class="line">#启用日志文件，默认启用</span><br><span class="line">journal=true</span><br><span class="line"></span><br><span class="line">#这个选项可以过滤掉一些无用的日志信息，若需要调试使用请设置为false</span><br><span class="line">quiet=true</span><br><span class="line"></span><br><span class="line">#端口号 默认为27017</span><br><span class="line">port=27017</span><br><span class="line"></span><br><span class="line">#指定存储引擎（默认先不加此引擎，如果报错了，大家在加进去）</span><br><span class="line">storageEngine=mmapv1</span><br><span class="line"></span><br><span class="line">#http配置 开启这个服务才可以在网页中访问 端口28017</span><br><span class="line">httpinterface=true</span><br></pre></td></tr></table></figure>

<ul>
<li>启动方式</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Program Files\MongoDB\Server\3.4\bin\mongod --config d:\mongodb\data</span><br></pre></td></tr></table></figure>

<p><img src="https://poetries1.gitee.io/img-repo/2019/10/349.png" alt="img"></p>
<p><strong>更加简洁的启动方式</strong></p>
<blockquote>
<p>安装到<code>window</code>的服务里面，打开Windows看一下</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Program Files\MongoDB\Server\3.4\bin\mongod --config d:\mongodb\data --install --serviceName &quot;MongoDB&quot;</span><br></pre></td></tr></table></figure>

<p><img src="https://poetries1.gitee.io/img-repo/2019/10/350.png" alt="img"></p>
<p><strong>使用MongoVue连接数据库</strong></p>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/351.png" alt="img"><br><img src="https://poetries1.gitee.io/img-repo/2019/10/352.png" alt="img"></p>
<h2 id="1-3-linux下mongodb环境搭建"><a href="#1-3-linux下mongodb环境搭建" class="headerlink" title="1.3 linux下mongodb环境搭建"></a>1.3 linux下mongodb环境搭建</h2><ul>
<li>下载安装包或压缩包</li>
<li>添加<code>db</code>存储和日志存储文件夹</li>
<li>添加服务、配置环境变量、启动<code>Mongo</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 远程登录服务器</span><br><span class="line">ssh root@123.142.25.365</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上传本地的安装包</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># 上传文件夹，传文件不需要r</span><br><span class="line">scp /mongodb/... -r root@123.142.25.365:/home</span><br><span class="line"></span><br><span class="line"># 传到服务器的/home/</span><br><span class="line"># 在指定的目录创建启动需要的文件</span><br><span class="line"></span><br><span class="line">$ cd /home/</span><br><span class="line">$ mkdir etc logs data</span><br><span class="line">$ touch logs/mongodb.log etc/mongo.conf</span><br><span class="line"># /home/etc/mongo.conf配置</span><br><span class="line"></span><br><span class="line">dbpath=/home/mongodb/data</span><br><span class="line">logpath=/mongodb/logs/mongodb.log</span><br><span class="line">logappend=true</span><br><span class="line">journal=true</span><br><span class="line">quiet=true</span><br><span class="line">port=2701</span><br><span class="line"># 启动服务</span><br><span class="line">mongod -f /home/mongodb/etc/mongo.conf</span><br><span class="line"># 创建软连接</span><br><span class="line"></span><br><span class="line">ln -s /home/mongodb/bin/mongo /usr/local/bin/mongo</span><br><span class="line"></span><br><span class="line">ln -s /home/mongodb/bin/mongod /usr/local/bin/mongod</span><br></pre></td></tr></table></figure>

<h1 id="二、基本概念"><a href="#二、基本概念" class="headerlink" title="二、基本概念"></a>二、基本概念</h1><h2 id="2-1-数据库对比"><a href="#2-1-数据库对比" class="headerlink" title="2.1 数据库对比"></a>2.1 数据库对比</h2><table>
<thead>
<tr>
<th align="left">SQL术语&#x2F;概念</th>
<th align="left">MongoDB术语&#x2F;概念</th>
<th align="left">解析&#x2F;说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>database</code></td>
<td align="left"><code>database</code></td>
<td align="left">数据库</td>
</tr>
<tr>
<td align="left"><code>table</code></td>
<td align="left"><code>collection</code></td>
<td align="left">数据表&#x2F;集合</td>
</tr>
<tr>
<td align="left"><code>row</code></td>
<td align="left"><code>document</code></td>
<td align="left">数据记录&#x2F;文档</td>
</tr>
<tr>
<td align="left"><code>column</code></td>
<td align="left"><code>field</code></td>
<td align="left">数据记录行&#x2F;文档</td>
</tr>
<tr>
<td align="left"><code>index</code></td>
<td align="left"><code>index</code></td>
<td align="left">索引</td>
</tr>
<tr>
<td align="left"><code>table</code></td>
<td align="left"><code>joins</code></td>
<td align="left">表连接，<code>MongoDB</code>不支持</td>
</tr>
<tr>
<td align="left"><code>primary key</code></td>
<td align="left"><code>primary key</code></td>
<td align="left">主键,<code>MongoDB</code>自动将<code>_id</code>字段设置为主键</td>
</tr>
</tbody></table>
<p><img src="http://www.runoob.com/wp-content/uploads/2013/10/Figure-1-Mapping-Table-to-Collection-1.png" alt="img"></p>
<h2 id="2-2-数据库"><a href="#2-2-数据库" class="headerlink" title="2.2 数据库"></a>2.2 数据库</h2><ul>
<li>一个<code>mongodb</code>中可以建立多个数据库</li>
<li><code>MongoDB</code>的默认数据库为”<code>db</code>“，该数据库存储在<code>data</code>目录中</li>
<li><code>&quot;show dbs&quot;</code> 命令可以显示所有数据的列表</li>
<li>执行 <code>&quot;db&quot;</code> 命令可以显示当前数据库对象或集合</li>
<li><code>&quot;use&quot;</code>命令，可以连接到一个指定的数据库</li>
</ul>
<h2 id="2-3-文档"><a href="#2-3-文档" class="headerlink" title="2.3 文档"></a>2.3 文档</h2><ul>
<li>文档是一组键值(<code>key-value</code>)对(即<code>BSON</code>)</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;site&quot;:&quot;www.runoob.com&quot;, &quot;name&quot;:&quot;菜鸟教程&quot;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-4-插入文档"><a href="#2-4-插入文档" class="headerlink" title="2.4 插入文档"></a>2.4 插入文档</h2><ul>
<li><p>切换数据库</p>
<ul>
<li><code>use</code> 数据库名(没有就创建)</li>
</ul>
</li>
<li><p>&#96;&#96;&#96;<br>db.createCollection(“user”)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  - 创建集合相当于创建表名</span><br><span class="line">  - 或者这样创建</span><br><span class="line">    - `db.user.inert(&#123;id:123&#125;)`</span><br><span class="line"></span><br><span class="line">## 2.5 插入数据表</span><br><span class="line"></span><br><span class="line">**1. 手动插入**</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="切换创建数据库"><a href="#切换创建数据库" class="headerlink" title="切换创建数据库"></a>切换创建数据库</h1><p>use demo </p>
<h1 id="goods相当于数据表"><a href="#goods相当于数据表" class="headerlink" title="goods相当于数据表"></a>goods相当于数据表</h1><p>db.goods.insert({“prodictId”:”10001”,”productName”:”aaa”,”slaePrice”:246,”productImage”:”1.jpg”})</p>
<h1 id="创建数据表，暂时不需插入数据"><a href="#创建数据表，暂时不需插入数据" class="headerlink" title="创建数据表，暂时不需插入数据"></a>创建数据表，暂时不需插入数据</h1><p>db.createCollection(“goods”)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**2. 客户端插入**</span><br><span class="line"></span><br><span class="line">&gt; 利用`mongodbVue`导入</span><br><span class="line"></span><br><span class="line"># 三、常用操作</span><br><span class="line"></span><br><span class="line">## 3.1 创建用户</span><br><span class="line"></span><br><span class="line">**1. 创建管理员**</span><br><span class="line"></span><br><span class="line">- 开启服务</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="–auth进行授权，需要认证才可以"><a href="#–auth进行授权，需要认证才可以" class="headerlink" title="–auth进行授权，需要认证才可以"></a>–auth进行授权，需要认证才可以</h1><p>mongod -f d:&#x2F;mongodb&#x2F;etc&#x2F;mongodb.conf –auth</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**2. 通过非授权的方式启动服务**</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="创建admin数据库"><a href="#创建admin数据库" class="headerlink" title="创建admin数据库"></a>创建admin数据库</h1><p>use admin </p>
<h1 id="给admin数据库创建账号"><a href="#给admin数据库创建账号" class="headerlink" title="给admin数据库创建账号"></a>给admin数据库创建账号</h1><p>db.createUser({user:”admin”,pwd:”admin”,roles:[“root”]}) # 3.4<br>db.addUser # 2.x</p>
<h1 id="创建成功需要认证"><a href="#创建成功需要认证" class="headerlink" title="创建成功需要认证"></a>创建成功需要认证</h1><p>db.auth(“admin”,”admin”) # 账号、密码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](https://poetries1.gitee.io/img-repo/2019/10/353.png)</span><br><span class="line"></span><br><span class="line">**3. 给使用的数据库添加用户**</span><br><span class="line"></span><br><span class="line">1. 创建用户</span><br><span class="line"></span><br><span class="line">![img](https://poetries1.gitee.io/img-repo/2019/10/354.png)</span><br><span class="line"></span><br><span class="line">1. 然后在授权登录试一下</span><br><span class="line"></span><br><span class="line">## 3.2 MongoDB 创建数据库</span><br><span class="line"></span><br><span class="line">- `MongoDB` 创建数据库的语法格式如下</span><br><span class="line">- 如果数据库不存在，则创建数据库，否则切换到指定数据库</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>use DATABASE_NAME</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 查看所有数据库</span><br><span class="line">  - `show dbs`</span><br><span class="line">- 我们刚创建的数据库 runoob 并不在数据库的列表中， 要显示它，我们需要向 runoob 数据库插入一些数据</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>db.runoob.insert({“name”:”poetries”})<br>WriteResult({ “nInserted” : 1 })<br>show dbs</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 3.3 MongoDB 删除数据库</span><br><span class="line"></span><br><span class="line">- `MongoDB`删除数据库的语法格式如下</span><br><span class="line">- 删除当前数据库，默认为 `test`，你可以使用 `db` 命令查看当前数据库名</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>db.dropDatabase()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 3.4 删除集合</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>db.collection.drop()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 3.5 MongoDB 插入文档</span><br><span class="line"></span><br><span class="line">&gt; 文档的数据结构和`JSON`基本一样</span><br><span class="line"></span><br><span class="line">## 3.6 插入文档</span><br><span class="line"></span><br><span class="line">- `MongoDB` 使用 `insert()`或 `save()` 方法向集合中插入文档，语法如下</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>db.COLLECTION_NAME.insert(document)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 以下文档可以存储在 `MongoDB` 的 `runoob`数据库 的 `col` 集合中</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>db.col.insert({title: ‘MongoDB 学习’,<br>    description: ‘MongoDB 是一个 Nosql 数据库’,<br>    by: ‘poetries’,<br>    url: ‘<a target="_blank" rel="noopener" href="http://blog.poetries.top&/#39;">http://blog.poetries.top&#39;</a>,<br>    tags: [‘mongodb’, ‘database’, ‘NoSQL’],<br>    likes: 100<br>})</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 以上实例中 `col` 是我们的集合名，如果该集合不在该数据库中， `MongoDB` 会自动创建该集合并插入文档。</span><br><span class="line">- 查看已插入文档</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>db.col.find()<br>db.col.find().pretty() #格式化方式查看</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 3.7 MongoDB 更新文档</span><br><span class="line"></span><br><span class="line">- `MongoDB` 使用 `update()` 和 `save()` 方法来更新集合中的文档</span><br><span class="line"></span><br><span class="line">## 3.7 update() 方法</span><br><span class="line"></span><br><span class="line">&gt; `update()` 方法用于更新已存在的文档。语法格式如下</span><br><span class="line"></span><br><span class="line">- 通过 `update()`方法来更新标题(`title`):</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>db.col.update({‘title’:’MongoDB 学习’},{$set:{‘title’:’MongoDB’}})</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 四、常用查询语句</span><br><span class="line"></span><br><span class="line">| mongo                                                       | sql                                                          | 说明                                 |</span><br><span class="line">| :---------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------- |</span><br><span class="line">| `db.users.find()`                                           | `select * from users`                                        | 从`user`表中查询所有数据             |</span><br><span class="line">| `db.users.find(&#123;“username” : “joe”, “age” : 27&#125;)`           | `select * from users where “username” = “joe” and age = 27`  | 查找`username = joe`且`age = 27`的人 |</span><br><span class="line">| `db.users.find(&#123;&#125;, &#123;“username” : 1, “email” : 1&#125;)`          | `select username, email from users`                          | 查找`username`,`email`这`2`个子项    |</span><br><span class="line">| `db.users.find(&#123;“age” : &#123;“$gt” : 18&#125;&#125;)`                     | `select * from users where age &gt;18`                          | 查找`age &gt; 18`的会员                 |</span><br><span class="line">| `db.users.find(&#123;“age” : &#123;“$gte” : 18&#125;&#125;)`                    | `select * from users where age &gt;=18`                         | 查找`age &gt;= 18`的人                  |</span><br><span class="line">| `db.users.find(&#123;“age” : &#123;“$lt” : 18&#125;&#125;)`                     | `select * from users where age &lt;18`                          | 查找`age &lt; 18`的人                   |</span><br><span class="line">| `db.users.find(&#123;“age” : &#123;“$lte” : 18&#125;&#125;)`                    | `select * from users where age &lt;=18`                         | 查找`age &lt;= 18`的人                  |</span><br><span class="line">| `db.users.find(&#123;“username” : &#123;“$ne” : “joe”&#125;&#125;)`             | `select * from users where username &lt;&gt; “joe”`                | 查找 `username != joe`的会员         |</span><br><span class="line">| `db.users.find(&#123;“ticket_no” : &#123;“$in” : [725, 542, 390]&#125;&#125;)`  | `select * from users where ticket_no in (725, 542, 390)`     | 符合`tickt_no`在此范围的结果         |</span><br><span class="line">| `db.users.find(&#123;“ticket_no” : &#123;“$nin” : [725, 542, 390]&#125;&#125;)` | `select * from users where ticket_no not in (725, 542, 390)` | 符合`tickt_no`不在此范围的结果       |</span><br><span class="line">| `db.users.find(&#123;“name” : /joey^/&#125;)`                         | `select * from users where name like “joey%”`                | 查找前`4`个字符为`joey`的人          |</span><br><span class="line"></span><br><span class="line"># 五、MongoDB链接</span><br><span class="line"></span><br><span class="line">## 5.1 MongoDB链接express</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>const express &#x3D; require(‘express’);<br>const mongoose &#x3D; require(‘mongoose’);<br>const app &#x3D; express();</p>
<p>&#x2F;&#x2F; 连接mongo 并且使用React这个集合，没有就会新建<br>const DB_URL &#x3D; ‘mongodb:&#x2F;&#x2F;127.0.0.1:27017&#x2F;react’;<br>mongoose.connect(DB_URL);<br>mongoose.connection.on(‘connected’,()&#x3D;&gt;{<br>    console.log(‘mongo connect success’);<br>})</p>
<p>&#x2F;&#x2F; 类似于MySQL的表 mongo里有文档、字段的概念</p>
<p>const User &#x3D; mongoose.model(‘user’,new mongoose.Schema({<br>    user:{type:String,require:true},<br>    age:{type:Number,require:true}<br>}))</p>
<p>&#x2F;&#x2F;新增数据<br>&#x2F;&#x2F; User.create({<br>&#x2F;&#x2F;     user:’小胡’,<br>&#x2F;&#x2F;     age:18<br>&#x2F;&#x2F; },(err,doc)&#x3D;&gt;{<br>&#x2F;&#x2F;     if(!err) {<br>&#x2F;&#x2F;         console.log(doc)<br>&#x2F;&#x2F;     } else {<br>&#x2F;&#x2F;         console.log(err)<br>&#x2F;&#x2F;     }<br>&#x2F;&#x2F; })</p>
<p>&#x2F;&#x2F; 删除数据 {}过滤对象<br>&#x2F;&#x2F; User.remove({age:22},(err,doc)&#x3D;&gt;{<br>&#x2F;&#x2F;     console.log(doc)<br>&#x2F;&#x2F; })<br>&#x2F;&#x2F; 更新<br>User.update({‘user’:’小明’},{‘$set’:{age:30}},(err,doc)&#x3D;&gt;{<br>    console.log(doc)<br>})<br>app.get(‘&#x2F;‘,(req,res)&#x3D;&gt;{<br>    res.send(‘<h1>Hello word!</h1>‘)<br>})<br>app.get(‘&#x2F;data’,(req,res)&#x3D;&gt;{<br>    &#x2F;&#x2F; findOne 只返回一条，返回对象直接使用，而不是返回数组<br>    User.findOne({‘user’:’小明’},(err,doc)&#x3D;&gt;{<br>        res.json(doc)<br>    })<br>})</p>
<p>app.listen(9000,()&#x3D;&gt;{<br>    console.log(‘Node app listen 9000’)<br>})<br>&#96;&#96;&#96;</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mongodb/" rel="tag">mongodb</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-数据库/mysql" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/03/15/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/" class="article-date">
  	<time datetime="2019-03-15T01:58:46.000Z" itemprop="datePublished">2019-03-15</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/15/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/">
        mysql
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>好久没用<code>sql</code>，都忘得干干净净，翻阅以前的学习笔记，觉得有些可记录的点，放在这里以便备用查阅</p>
</blockquote>
<h2 id="一、环境搭建"><a href="#一、环境搭建" class="headerlink" title="一、环境搭建"></a>一、环境搭建</h2><blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mac`安装`MySQL</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install mysql</span><br></pre></td></tr></table></figure>

<p><img src="https://poetries1.gitee.io/img-repo/2019/10/355.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 启动</span><br><span class="line"></span><br><span class="line">mysql.server start</span><br><span class="line">#登录</span><br><span class="line">mysql -uroot</span><br></pre></td></tr></table></figure>

<h2 id="二、基础知识"><a href="#二、基础知识" class="headerlink" title="二、基础知识"></a>二、基础知识</h2><h3 id="1、数据库的连接"><a href="#1、数据库的连接" class="headerlink" title="1、数据库的连接"></a>1、数据库的连接</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 例子</span><br><span class="line">mysql -u root -p 123456 -h 127.0.0.1</span><br></pre></td></tr></table></figure>

<ul>
<li><code>-u</code> 用户名</li>
<li><code>-p</code> 密码</li>
<li><code>-h</code> <code>host</code>主机</li>
</ul>
<h3 id="2、库级知识"><a href="#2、库级知识" class="headerlink" title="2、库级知识"></a>2、库级知识</h3><blockquote>
<p>命令后面加上分号</p>
</blockquote>
<ul>
<li>显示数据库: <code>show databases;</code></li>
<li>选择数据库: <code>use dbname;</code></li>
<li>创建数据库: <code>create database dbname charset utf8;</code></li>
<li>删除数据库: <code>drop database dbname;</code></li>
</ul>
<h3 id="3、表级操作"><a href="#3、表级操作" class="headerlink" title="3、表级操作"></a>3、表级操作</h3><h4 id="3-1-显示库下面的表"><a href="#3-1-显示库下面的表" class="headerlink" title="3.1 显示库下面的表"></a>3.1 显示库下面的表</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show tables;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-查看表的结构"><a href="#3-2-查看表的结构" class="headerlink" title="3.2 查看表的结构"></a>3.2 查看表的结构</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">desc tableName;</span><br></pre></td></tr></table></figure>

<h4 id="3-3-查看表的创建过程"><a href="#3-3-查看表的创建过程" class="headerlink" title="3.3 查看表的创建过程:"></a>3.3 查看表的创建过程:</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show create table  tableName;</span><br></pre></td></tr></table></figure>

<h4 id="3-4-创建表"><a href="#3-4-创建表" class="headerlink" title="3.4 创建表"></a>3.4 创建表</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">create table tbName (</span><br><span class="line">列名称1　列类型　[列参数]　[not null default ],</span><br><span class="line">列名称N　列类型　[列参数]　[not null default ]</span><br><span class="line">) engine myisam/innodb charset utf8/gbk</span><br></pre></td></tr></table></figure>

<p><strong>例子</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">create table user (</span><br><span class="line">    id    int         auto_increment,</span><br><span class="line">    name  varchar(20) not null default &#x27;&#x27;,</span><br><span class="line">    age   tinyint unsigned not null default 0,</span><br><span class="line">    index id (id)</span><br><span class="line">)engine=innodb charset=utf8;</span><br><span class="line"></span><br><span class="line"># 注:innodb是表引擎,也可以是myisam或其他,但最常用的是myisam和innodb,</span><br><span class="line"># charset 常用的有utf8,gbk;</span><br></pre></td></tr></table></figure>

<h4 id="3-5-修改表"><a href="#3-5-修改表" class="headerlink" title="3.5 修改表"></a>3.5 修改表</h4><p><strong>3.5.1 修改表之增加列</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">alter table tbName add 列名称１　列类型　[列参数]　[not null default ]　</span><br><span class="line"></span><br><span class="line">#(add之后的旧列名之后的语法和创建表时的列声明一样)</span><br></pre></td></tr></table></figure>

<p><strong>3.5.2 修改表之修改列</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">alter table tbName change 旧列名  新列名  列类型　[列参数]　[not null default ]</span><br><span class="line"></span><br><span class="line"># (注:旧列名之后的语法和创建表时的列声明一样)</span><br></pre></td></tr></table></figure>

<p><strong>3.5.3 修改表之减少列</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter table tbName drop 列名称;</span><br></pre></td></tr></table></figure>

<p><strong>3.5.4 修改表之增加主键</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter table tbName add primary key(主键所在列名);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>例:<code>alter table goods add primary key(id)</code> 该例是把主键建立在<code>id</code>列上</p>
</blockquote>
<p><strong>3.5.5 修改表之删除主键</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter table tbName　drop primary key;</span><br></pre></td></tr></table></figure>

<p><strong>3.5.6 修改表之增加索引</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter table tbName add [unique|fulltext] index 索引名(列名);</span><br></pre></td></tr></table></figure>

<p><strong>3.5.7 修改表之删除索引</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter table tbName drop index 索引名;</span><br></pre></td></tr></table></figure>

<p><strong>3.5.8 清空表的数据</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">truncate tableName;</span><br></pre></td></tr></table></figure>

<h3 id="4、列类型讲解"><a href="#4、列类型讲解" class="headerlink" title="4、列类型讲解"></a>4、列类型讲解</h3><h4 id="4-1-列类型"><a href="#4-1-列类型" class="headerlink" title="4.1 列类型"></a>4.1 列类型</h4><ul>
<li><code>tinyint (0~255/-128~127)</code></li>
<li><code>smallint (0~65535/-32768~32767)</code></li>
<li><code>mediumint</code></li>
<li><code>int</code></li>
<li><code>bigint</code></li>
</ul>
<p><strong>参数解释</strong></p>
<blockquote>
<p><code>unsigned</code> 无符号(不能为负) <code>zerofill 0</code>填充 <code>M</code> 填充后的宽度</p>
</blockquote>
<ul>
<li>举例:</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tinyint unsigned;</span><br><span class="line">tinyint(6) zerofill;</span><br></pre></td></tr></table></figure>

<h4 id="4-2-数值型"><a href="#4-2-数值型" class="headerlink" title="4.2 数值型"></a>4.2 数值型</h4><ul>
<li>浮点型:<code>float</code> <code>double</code></li>
<li>格式:<code>float(M,D)</code> <code>unsigned\zerofill;</code></li>
</ul>
<h4 id="4-3-字符型"><a href="#4-3-字符型" class="headerlink" title="4.3 字符型"></a>4.3 字符型</h4><ul>
<li><code>char(m)</code> 定长</li>
<li><code>varchar(m)</code>变长</li>
<li><code>text</code></li>
</ul>
<table>
<thead>
<tr>
<th align="left">列</th>
<th align="left">实存字符i</th>
<th align="left">实占空间</th>
<th align="left">利用率</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>char(M)</code></td>
<td align="left"><code>0&lt;=i&lt;=M</code></td>
<td align="left"><code>M</code></td>
<td align="left"><code>i/m&lt;=100%</code></td>
</tr>
<tr>
<td align="left"><code>varchar(M)</code></td>
<td align="left"><code>0&lt;=i&lt;=M</code></td>
<td align="left"><code>i+1,2</code></td>
<td align="left"><code>i/i+1/2&lt;100%</code></td>
</tr>
</tbody></table>
<h4 id="4-4-日期时间类型"><a href="#4-4-日期时间类型" class="headerlink" title="4.4 日期时间类型"></a>4.4 日期时间类型</h4><ul>
<li><code>year</code> <code>YYYY</code> 范围:<code>1901~2155</code>. 可输入值<code>2</code>位和<code>4</code>位(如<code>98</code>,<code>2012</code>)</li>
<li><code>date</code> <code>YYYY-MM-DD</code> 如:<code>2010-03-14</code></li>
<li><code>time</code> <code>HH:MM:SS</code> 如:<code>19:26:32</code></li>
<li><code>datetime</code> <code>YYYY-MM-DD</code> <code>HH:MM:SS</code> 如:<code>2010-03-14 19:26:32</code></li>
<li><code>timestamp</code> <code>YYYY-MM-DD</code> <code>HH:MM:SS</code></li>
</ul>
<blockquote>
<p>特性:不用赋值,该列会为自己赋当前的具体时间</p>
</blockquote>
<h3 id="5、增删改查基本操作"><a href="#5、增删改查基本操作" class="headerlink" title="5、增删改查基本操作"></a>5、增删改查基本操作</h3><h4 id="5-1-插入数据"><a href="#5-1-插入数据" class="headerlink" title="5.1 插入数据"></a>5.1 插入数据</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">insert into 表名(col1,col2,……) values(val1,val2……); # -- 插入指定列</span><br><span class="line"></span><br><span class="line">insert into 表名 values (,,,,); # -- 插入所有列</span><br><span class="line"></span><br><span class="line">insert into 表名 values	# -- 一次插入多行 </span><br><span class="line">(val1,val2……),</span><br><span class="line">(val1,val2……),</span><br><span class="line">(val1,val2……);</span><br></pre></td></tr></table></figure>

<h4 id="5-2-修改数据"><a href="#5-2-修改数据" class="headerlink" title="5.2 修改数据"></a>5.2 修改数据</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">update tablename </span><br><span class="line"></span><br><span class="line">set </span><br><span class="line"></span><br><span class="line">col1=newval1,  </span><br><span class="line">col2=newval2,</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">colN=newvalN</span><br><span class="line">where 条件;</span><br></pre></td></tr></table></figure>

<h4 id="5-3-删除数据"><a href="#5-3-删除数据" class="headerlink" title="5.3 删除数据"></a>5.3 删除数据</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete from tablenaeme where 条件;</span><br></pre></td></tr></table></figure>

<h4 id="5-4-select-查询"><a href="#5-4-select-查询" class="headerlink" title="5.4 select 查询"></a>5.4 select 查询</h4><ol>
<li>条件查询 <code>where</code></li>
</ol>
<ul>
<li>条件表达式的意义，表达式为真，则该行取出</li>
<li>比较运算符 <code>=</code> ，<code>!=</code>，<code>&lt; &gt;</code> <code>&lt;=</code> <code>&gt;=</code></li>
<li><code>like</code> , <code>not like</code> (‘<code>%</code>‘匹配任意多个字符,’<code>_</code>‘匹配任意单个字符) <code>in</code>, <code>not in</code> , <code>between and</code></li>
<li><code>is null</code> , <code>is not null</code></li>
</ul>
<ol>
<li>分组 <code>group by</code> 一般要配合<code>5</code>个聚合函数使用 <code>max</code>, <code>min</code>, <code>sum</code>, <code>avg</code>, <code>count</code></li>
<li>筛选<code>having</code></li>
<li>排序<code>order by</code></li>
<li>限制<code>limit</code></li>
</ol>
<h3 id="6、连接查询"><a href="#6、连接查询" class="headerlink" title="6、连接查询"></a>6、连接查询</h3><h4 id="6-1-左连接"><a href="#6-1-左连接" class="headerlink" title="6.1 左连接"></a>6.1 左连接</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.. left join .. on</span><br><span class="line">table A left join table B on tableA.col1 = tableB.col2 ;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>例句:</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select 列名 from table A left join table B on tableA.col1 = tableB.col2</span><br></pre></td></tr></table></figure>

<h4 id="6-2-右链接"><a href="#6-2-右链接" class="headerlink" title="6.2 右链接"></a>6.2 右链接</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">right join</span><br></pre></td></tr></table></figure>

<h4 id="6-3-内连接"><a href="#6-3-内连接" class="headerlink" title="6.3 内连接"></a>6.3 内连接</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inner join</span><br></pre></td></tr></table></figure>

<ul>
<li>左右连接都是以在左边的表的数据为准,沿着左表查右表.</li>
<li>内连接是以两张表都有的共同部分数据为准,也就是左右连接的数据之交集</li>
</ul>
<h3 id="7、子查询"><a href="#7、子查询" class="headerlink" title="7、子查询"></a>7、子查询</h3><blockquote>
<p><code>where</code> 型子查询:内层<code>sql</code>的返回值在<code>where</code>后作为条件表达式的一部分</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># 例句: select * from tableA where colA = (select colB from tableB where ...);</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>from</code> 型子查询:内层<code>sql</code>查询结果,作为一张表,供外层的<code>sql</code>语句再次查询</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">例句:select * from (select * from ...) as tableName where ....</span><br></pre></td></tr></table></figure>

<h3 id="8、字符集"><a href="#8、字符集" class="headerlink" title="8、字符集"></a>8、字符集</h3><ul>
<li>客户端<code>sql</code>编码 <code>character_set_client</code></li>
<li>服务器转化后的<code>sql</code>编码 <code>character_set_connection</code></li>
<li>服务器返回给客户端的结果集编码<code>character_set_results</code></li>
<li>快速把以上<code>3</code>个变量设为相同值: <code>set names</code> 字符集</li>
</ul>
<p><strong>存储引擎 engine&#x3D;1\2</strong></p>
<ul>
<li><code>Myisam</code> 速度快 不支持事务 回滚</li>
<li><code>Innodb</code> 速度慢 支持事务,回滚</li>
</ul>
<p><strong>事务</strong></p>
<ul>
<li>开启事务 <code>start transaction</code></li>
<li>运行<code>sql;</code></li>
<li>提交,同时生效\回滚 <code>commit\rollback</code></li>
</ul>
<p><strong>触发器</strong></p>
<ul>
<li>触发器 <code>trigger</code></li>
<li>监视地点:表</li>
<li>监视行为:增 删 改</li>
<li>触发时间:<code>after\before</code></li>
<li>触发事件:增删改</li>
</ul>
<p><strong>创建触发器语法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create trigger tgName</span><br><span class="line">after/before insert/delete/update </span><br><span class="line">on tableName</span><br><span class="line">for each row</span><br><span class="line">sql; # -- 触发语句</span><br></pre></td></tr></table></figure>

<ul>
<li>删除触发器:</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drop trigger tgName;</span><br></pre></td></tr></table></figure>

<p><strong>索引</strong></p>
<ul>
<li>提高查询速度,但是降低了增删改的速度,所以使用索引时,要综合考虑.</li>
<li>索引不是越多越好,一般我们在常出现于条件表达式中的列加索引.</li>
<li>值越分散的列，索引的效果越好</li>
</ul>
<p><strong>索引类型</strong></p>
<ul>
<li><code>primary key</code>主键索引</li>
<li><code>index</code> 普通索引</li>
<li><code>unique index</code> 唯一性索引</li>
<li><code>fulltext index</code> 全文索引</li>
</ul>
<p><strong>综合练习:</strong></p>
<ul>
<li>连接上数据库服务器</li>
<li>创建一个<code>gbk</code>编码的数据库</li>
<li>建立商品表和栏目表,字段如下:</li>
</ul>
<p><strong>商品表:goods</strong></p>
<ul>
<li><code>goods_id</code>　–主键,</li>
<li><code>goods_name</code> – 商品名称</li>
<li><code>cat_id</code> – 栏目<code>id</code></li>
<li><code>brand_id</code> – 品牌<code>id</code></li>
<li><code>goods_sn</code> – 货号</li>
<li><code>goods_number</code> – 库存量</li>
<li><code>shop_price</code> – 价格</li>
<li><code>goods_desc</code>　–商品详细描述</li>
</ul>
<p><strong>栏目表:category</strong></p>
<ul>
<li>cat_id –主键</li>
<li>cat_name – 栏目名称</li>
<li>parent_id – 栏目的父id</li>
</ul>
<blockquote>
<p>建表完成后,作以下操作:</p>
</blockquote>
<ul>
<li>删除goods表的goods_desc 字段,及货号字段</li>
<li>并增加字段:click_count – 点击量</li>
<li>在goods_name列上加唯一性索引</li>
<li>在shop_price列上加普通索引</li>
<li>在clcik_count列上加普通索引</li>
<li>删除click_count列上的索引</li>
</ul>
<p><strong>对goods表插入以下数据:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">+----------+------------------------------+--------+----------+-----------+--------------+------------+-------------+</span><br><span class="line">| goods_id | goods_name                   | cat_id | brand_id | goods_sn  | goods_number | shop_price | click_count |</span><br><span class="line">+----------+------------------------------+--------+----------+-----------+--------------+------------+-------------+</span><br><span class="line">|        1 | KD876                        |      4 |        8 | ECS000000 |           10 |    1388.00 |           7 |</span><br><span class="line">|        4 | 诺基亚N85原装充电器          |      8 |        1 | ECS000004 |           17 |      58.00 |           0 |</span><br><span class="line">|        3 | 诺基亚原装5800耳机           |      8 |        1 | ECS000002 |           24 |      68.00 |           3 |</span><br><span class="line">|        5 | 索爱原装M2卡读卡器           |     11 |        7 | ECS000005 |            8 |      20.00 |           3 |</span><br><span class="line">|        6 | 胜创KINGMAX内存卡            |     11 |        0 | ECS000006 |           15 |      42.00 |           0 |</span><br><span class="line">|        7 | 诺基亚N85原装立体声耳机HS-82 |      8 |        1 | ECS000007 |           20 |     100.00 |           0 |</span><br><span class="line">|        8 | 飞利浦9@9v                   |      3 |        4 | ECS000008 |           17 |     399.00 |           9 |</span><br><span class="line">|        9 | 诺基亚E66                    |      3 |        1 | ECS000009 |           13 |    2298.00 |          20 |</span><br><span class="line">|       10 | 索爱C702c                    |      3 |        7 | ECS000010 |            7 |    1328.00 |          11 |</span><br><span class="line">|       11 | 索爱C702c                    |      3 |        7 | ECS000011 |            1 |    1300.00 |           0 |</span><br><span class="line">|       12 | 摩托罗拉A810                 |      3 |        2 | ECS000012 |            8 |     983.00 |          14 |</span><br><span class="line">|       13 | 诺基亚5320 XpressMusic       |      3 |        1 | ECS000013 |            8 |    1311.00 |          13 |</span><br><span class="line">|       14 | 诺基亚5800XM                 |      4 |        1 | ECS000014 |            4 |    2625.00 |           6 |</span><br><span class="line">|       15 | 摩托罗拉A810                 |      3 |        2 | ECS000015 |            3 |     788.00 |           8 |</span><br><span class="line">|       16 | 恒基伟业G101                 |      2 |       11 | ECS000016 |            0 |     823.33 |           3 |</span><br><span class="line">|       17 | 夏新N7                       |      3 |        5 | ECS000017 |            1 |    2300.00 |           2 |</span><br><span class="line">|       18 | 夏新T5                       |      4 |        5 | ECS000018 |            1 |    2878.00 |           0 |</span><br><span class="line">|       19 | 三星SGH-F258                 |      3 |        6 | ECS000019 |            0 |     858.00 |           7 |</span><br><span class="line">|       20 | 三星BC01                     |      3 |        6 | ECS000020 |           13 |     280.00 |          14 |</span><br><span class="line">|       21 | 金立 A30                     |      3 |       10 | ECS000021 |           40 |    2000.00 |           4 |</span><br><span class="line">|       22 | 多普达Touch HD               |      3 |        3 | ECS000022 |            0 |    5999.00 |          15 |</span><br><span class="line">|       23 | 诺基亚N96                    |      5 |        1 | ECS000023 |            8 |    3700.00 |          17 |</span><br><span class="line">|       24 | P806                         |      3 |        9 | ECS000024 |          148 |    2000.00 |          36 |</span><br><span class="line">|       25 | 小灵通/固话50元充值卡        |     13 |        0 | ECS000025 |            2 |      48.00 |           0 |</span><br><span class="line">|       26 | 小灵通/固话20元充值卡        |     13 |        0 | ECS000026 |            2 |      19.00 |           0 |</span><br><span class="line">|       27 | 联通100元充值卡              |     15 |        0 | ECS000027 |            2 |      95.00 |           0 |</span><br><span class="line">|       28 | 联通50元充值卡               |     15 |        0 | ECS000028 |            0 |      45.00 |           0 |</span><br><span class="line">|       29 | 移动100元充值卡              |     14 |        0 | ECS000029 |            0 |      90.00 |           0 |</span><br><span class="line">|       30 | 移动20元充值卡               |     14 |        0 | ECS000030 |            9 |      18.00 |           1 |</span><br><span class="line">|       31 | 摩托罗拉E8                   |      3 |        2 | ECS000031 |            1 |    1337.00 |           5 |</span><br><span class="line">|       32 | 诺基亚N85                    |      3 |        1 | ECS000032 |            1 |    3010.00 |           9 |</span><br><span class="line">+----------+------------------------------+--------+----------+-----------+--------------+------------+-------------+</span><br></pre></td></tr></table></figure>

<h2 id="三、查询知识"><a href="#三、查询知识" class="headerlink" title="三、查询知识"></a>三、查询知识</h2><blockquote>
<p>注:以下查询基于<code>ecshop</code>网站的商品表(<code>ecs_goods</code>)</p>
</blockquote>
<blockquote>
<p>在练习时可以只取部分列,方便查看.</p>
</blockquote>
<h3 id="3-1-基础查询-where的练习"><a href="#3-1-基础查询-where的练习" class="headerlink" title="3.1 基础查询 where的练习"></a>3.1 基础查询 where的练习</h3><blockquote>
<p>查出满足以下条件的商品</p>
</blockquote>
<h4 id="3-1-1-主键为32的商品"><a href="#3-1-1-主键为32的商品" class="headerlink" title="3.1.1 主键为32的商品"></a>3.1.1 主键为32的商品</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select goods_id,goods_name,shop_price </span><br><span class="line">     from ecs_goods</span><br><span class="line">     where goods_id=32;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-2-不属第3栏目的所有商品"><a href="#3-1-2-不属第3栏目的所有商品" class="headerlink" title="3.1.2 不属第3栏目的所有商品"></a>3.1.2 不属第3栏目的所有商品</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select goods_id,cat_id,goods_name,shop_price  from ecs_goods</span><br><span class="line">     where cat_id!=3;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-3-本店价格高于3000元的商品"><a href="#3-1-3-本店价格高于3000元的商品" class="headerlink" title="3.1.3 本店价格高于3000元的商品"></a>3.1.3 本店价格高于3000元的商品</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select goods_id,cat_id,goods_name,shop_price  from ecs_goods</span><br><span class="line">     where shop_price &gt;3000;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-4-本店价格低于或等于100元的商品"><a href="#3-1-4-本店价格低于或等于100元的商品" class="headerlink" title="3.1.4 本店价格低于或等于100元的商品"></a>3.1.4 本店价格低于或等于100元的商品</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select goods_id,cat_id,goods_name,shop_price  from ecs_goods where shop_price &lt;=100;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-5-取出第4栏目或第11栏目的商品-不许用or"><a href="#3-1-5-取出第4栏目或第11栏目的商品-不许用or" class="headerlink" title="3.1.5 取出第4栏目或第11栏目的商品(不许用or)"></a>3.1.5 取出第4栏目或第11栏目的商品(不许用or)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select goods_id,cat_id,goods_name,shop_price  from ecs_goods</span><br><span class="line">     where cat_id in (4,11);</span><br></pre></td></tr></table></figure>

<h4 id="3-1-6-取出100-lt-x3D-价格-lt-x3D-500的商品-不许用and"><a href="#3-1-6-取出100-lt-x3D-价格-lt-x3D-500的商品-不许用and" class="headerlink" title="3.1.6 取出100&lt;&#x3D;价格&lt;&#x3D;500的商品(不许用and)"></a>3.1.6 取出100&lt;&#x3D;价格&lt;&#x3D;500的商品(不许用and)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select goods_id,cat_id,goods_name,shop_price  from ecs_goods</span><br><span class="line">     where shop_price between 100 and 500;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-7-取出不属于第3栏目且不属于第11栏目的商品-and-或not-in分别实现"><a href="#3-1-7-取出不属于第3栏目且不属于第11栏目的商品-and-或not-in分别实现" class="headerlink" title="3.1.7 取出不属于第3栏目且不属于第11栏目的商品(and,或not in分别实现)"></a>3.1.7 取出不属于第3栏目且不属于第11栏目的商品(and,或not in分别实现)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select goods_id,cat_id,goods_name,shop_price from ecs_goods where cat_id!=3 and cat_id!=11;</span><br><span class="line"></span><br><span class="line">select goods_id,cat_id,goods_name,shop_price from ecs_goods where cat_id not in (3,11);</span><br></pre></td></tr></table></figure>

<h4 id="3-1-8-取出价格大于100且小于300-或者大于4000且小于5000的商品"><a href="#3-1-8-取出价格大于100且小于300-或者大于4000且小于5000的商品" class="headerlink" title="3.1.8 取出价格大于100且小于300,或者大于4000且小于5000的商品"></a>3.1.8 取出价格大于100且小于300,或者大于4000且小于5000的商品</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select goods_id,cat_id,goods_name,shop_price from ecs_goods where shop_price&gt;100 and shop_price &lt;300 or shop_price &gt;4000 and shop_price &lt;5000;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-9-取出第3个栏目下面价格-lt-1000或-gt-3000-并且点击量-gt-5的系列商品"><a href="#3-1-9-取出第3个栏目下面价格-lt-1000或-gt-3000-并且点击量-gt-5的系列商品" class="headerlink" title="3.1.9 取出第3个栏目下面价格&lt;1000或&gt;3000,并且点击量&gt;5的系列商品"></a>3.1.9 取出第3个栏目下面价格&lt;1000或&gt;3000,并且点击量&gt;5的系列商品</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select goods_id,cat_id,goods_name,shop_price,click_count from ecs_goods where</span><br><span class="line">cat_id=3 and (shop_price &lt;1000 or shop_price&gt;3000) and click_count&gt;5;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-10-取出第1个栏目下面的商品-注意-1栏目下面没商品-但其子栏目下有"><a href="#3-1-10-取出第1个栏目下面的商品-注意-1栏目下面没商品-但其子栏目下有" class="headerlink" title="3.1.10 取出第1个栏目下面的商品(注意:1栏目下面没商品,但其子栏目下有)"></a>3.1.10 取出第1个栏目下面的商品(注意:1栏目下面没商品,但其子栏目下有)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select goods_id,cat_id,goods_name,shop_price,click_count from ecs_goods</span><br><span class="line">     where cat_id in (2,3,4,5);</span><br></pre></td></tr></table></figure>

<h4 id="3-1-11-取出名字以”诺基亚”开头的商品"><a href="#3-1-11-取出名字以”诺基亚”开头的商品" class="headerlink" title="3.1.11 取出名字以”诺基亚”开头的商品"></a>3.1.11 取出名字以”诺基亚”开头的商品</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select goods_id,cat_id,goods_name,shop_price  from ecs_goods     where goods_name like &#x27;诺基亚%&#x27;;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-12-取出名字为”诺基亚Nxx”的手机"><a href="#3-1-12-取出名字为”诺基亚Nxx”的手机" class="headerlink" title="3.1.12 取出名字为”诺基亚Nxx”的手机"></a>3.1.12 取出名字为”诺基亚Nxx”的手机</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select goods_id,cat_id,goods_name,shop_price  from ecs_goods  </span><br><span class="line">   where goods_name like &#x27;诺基亚N__&#x27;;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-13-取出名字不以”诺基亚”开头的商品"><a href="#3-1-13-取出名字不以”诺基亚”开头的商品" class="headerlink" title="3.1.13 取出名字不以”诺基亚”开头的商品"></a>3.1.13 取出名字不以”诺基亚”开头的商品</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select goods_id,cat_id,goods_name,shop_price from ecs_goos</span><br><span class="line">     where goods_name not like &#x27;诺基亚%&#x27;;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-14-取出第3个栏目下面价格在1000到3000之间-并且点击量-gt-5-“诺基亚”开头的系列商品"><a href="#3-1-14-取出第3个栏目下面价格在1000到3000之间-并且点击量-gt-5-“诺基亚”开头的系列商品" class="headerlink" title="3.1.14 取出第3个栏目下面价格在1000到3000之间,并且点击量&gt;5 “诺基亚”开头的系列商品"></a>3.1.14 取出第3个栏目下面价格在1000到3000之间,并且点击量&gt;5 “诺基亚”开头的系列商品</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select goods_id,cat_id,goods_name,shop_price from ecs_goods where </span><br><span class="line">cat_id=3 and shop_price&gt;1000 and shop_price &lt;3000 and click_count&gt;5 and goods_name like &#x27;诺基亚%&#x27;;</span><br><span class="line">select goods_id,cat_id,goods_name,shop_price  from ecs_goods where </span><br><span class="line">shop_price between 1000 and 3000 and cat_id=3  and click_count&gt;5 and goods_name like &#x27;诺基亚%&#x27;;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-15-一道面试题"><a href="#3-1-15-一道面试题" class="headerlink" title="3.1.15 一道面试题"></a>3.1.15 一道面试题</h4><blockquote>
<p>有如下表和数组</p>
</blockquote>
<ul>
<li>把<code>num</code>值处于<code>[20,29]</code>之间,改为<code>20</code></li>
<li><code>num</code>值处于<code>[30,39]</code>之间的,改为<code>30</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">+------+</span><br><span class="line">| num  |</span><br><span class="line">+------+</span><br><span class="line">|    3 |</span><br><span class="line">|   12 |</span><br><span class="line">|   15 |</span><br><span class="line">|   25 |</span><br><span class="line">|   23 |</span><br><span class="line">|   29 |</span><br><span class="line">|   34 |</span><br><span class="line">|   37 |</span><br><span class="line">|   32 |</span><br><span class="line">|   45 |</span><br><span class="line">|   48 |</span><br><span class="line">|   52 |</span><br><span class="line">+------+</span><br></pre></td></tr></table></figure>

<h4 id="3-1-16-练习题"><a href="#3-1-16-练习题" class="headerlink" title="3.1.16 练习题:"></a>3.1.16 练习题:</h4><blockquote>
<p>把<code>good</code>表中商品名为’诺基亚xxxx’的商品,改为’HTCxxxx’,</p>
</blockquote>
<ul>
<li>提示:大胆的把列看成变量,参与运算,甚至调用函数来处理 。<code>ubstring()</code>, <code>concat()</code></li>
</ul>
<h3 id="3-2-分组查询group"><a href="#3-2-分组查询group" class="headerlink" title="3.2 分组查询group"></a>3.2 分组查询group</h3><h4 id="3-2-1-查出最贵的商品的价格"><a href="#3-2-1-查出最贵的商品的价格" class="headerlink" title="3.2.1 查出最贵的商品的价格"></a>3.2.1 查出最贵的商品的价格</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select max(shop_price) from ecs_goods;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-2-查出最大-最新-的商品编号"><a href="#3-2-2-查出最大-最新-的商品编号" class="headerlink" title="3.2.2 查出最大(最新)的商品编号"></a>3.2.2 查出最大(最新)的商品编号</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select max(goods_id) from ecs_goods;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-3-查出最便宜的商品的价格"><a href="#3-2-3-查出最便宜的商品的价格" class="headerlink" title="3.2.3 查出最便宜的商品的价格"></a>3.2.3 查出最便宜的商品的价格</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select min(shop_price) from ecs_goods;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-4-查出最旧-最小-的商品编号"><a href="#3-2-4-查出最旧-最小-的商品编号" class="headerlink" title="3.2.4 查出最旧(最小)的商品编号"></a>3.2.4 查出最旧(最小)的商品编号</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select min(goods_id) from ecs_goods;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-5-查询该店所有商品的库存总量"><a href="#3-2-5-查询该店所有商品的库存总量" class="headerlink" title="3.2.5 查询该店所有商品的库存总量"></a>3.2.5 查询该店所有商品的库存总量</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select sum(goods_number) from ecs_goods;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-6-查询所有商品的平均价"><a href="#3-2-6-查询所有商品的平均价" class="headerlink" title="3.2.6 查询所有商品的平均价"></a>3.2.6 查询所有商品的平均价</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select avg(shop_price) from ecs_goods;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-7-查询该店一共有多少种商品"><a href="#3-2-7-查询该店一共有多少种商品" class="headerlink" title="3.2.7 查询该店一共有多少种商品"></a>3.2.7 查询该店一共有多少种商品</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select count(*) from ecs_goods;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-8-查询每个栏目下面"><a href="#3-2-8-查询每个栏目下面" class="headerlink" title="3.2.8 查询每个栏目下面"></a>3.2.8 查询每个栏目下面</h4><ul>
<li>最贵商品价格</li>
<li>最低商品价格</li>
<li>商品平均价格</li>
<li>商品库存量</li>
<li>商品种类</li>
</ul>
<blockquote>
<p>提示:(<code>5</code>个聚合函数,<code>sum</code>, <code>avg</code>, <code>max</code>, <code>min</code>, <code>count</code>与<code>group</code>综合运用)<br><code>select cat_id,max(shop_price) from ecs_goods group by cat_id;</code></p>
</blockquote>
<h3 id="3-3-having与group综合运用查询"><a href="#3-3-having与group综合运用查询" class="headerlink" title="3.3 having与group综合运用查询"></a>3.3 having与group综合运用查询</h3><h4 id="3-3-1-查询该店的商品比市场价所节省的价格"><a href="#3-3-1-查询该店的商品比市场价所节省的价格" class="headerlink" title="3.3.1 查询该店的商品比市场价所节省的价格"></a>3.3.1 查询该店的商品比市场价所节省的价格</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select goods_id,goods_name,market_price-shop_price as j </span><br><span class="line">     from ecs_goods ;</span><br></pre></td></tr></table></figure>

<h4 id="3-3-2-查询每个商品所积压的货款-提示-库存-单价"><a href="#3-3-2-查询每个商品所积压的货款-提示-库存-单价" class="headerlink" title="3.3.2 查询每个商品所积压的货款(提示:库存*单价)"></a>3.3.2 查询每个商品所积压的货款(提示:库存*单价)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select goods_id,goods_name,goods_number*shop_price  from ecs_goods</span><br></pre></td></tr></table></figure>

<h4 id="3-3-3-查询该店积压的总货款"><a href="#3-3-3-查询该店积压的总货款" class="headerlink" title="3.3.3 查询该店积压的总货款"></a>3.3.3 查询该店积压的总货款</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select sum(goods_number*shop_price) from ecs_goods;</span><br></pre></td></tr></table></figure>

<h4 id="3-3-4-查询该店每个栏目下面积压的货款"><a href="#3-3-4-查询该店每个栏目下面积压的货款" class="headerlink" title="3.3.4 查询该店每个栏目下面积压的货款."></a>3.3.4 查询该店每个栏目下面积压的货款.</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select cat_id,sum(goods_number*shop_price) as k from ecs_goods group by cat_id;</span><br></pre></td></tr></table></figure>

<h4 id="3-3-5-查询比市场价省钱200元以上的商品及该商品所省的钱-where和having分别实现"><a href="#3-3-5-查询比市场价省钱200元以上的商品及该商品所省的钱-where和having分别实现" class="headerlink" title="3.3.5 查询比市场价省钱200元以上的商品及该商品所省的钱(where和having分别实现)"></a>3.3.5 查询比市场价省钱200元以上的商品及该商品所省的钱(where和having分别实现)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select goods_id,goods_name,market_price-shop_price  as k from ecs_goods</span><br><span class="line">where market_price-shop_price &gt;200;</span><br><span class="line">select goods_id,goods_name,market_price-shop_price  as k from ecs_goods</span><br><span class="line">having k &gt;200;</span><br></pre></td></tr></table></figure>

<h4 id="3-3-6-查询积压货款超过2W元的栏目-以及该栏目积压的货款"><a href="#3-3-6-查询积压货款超过2W元的栏目-以及该栏目积压的货款" class="headerlink" title="3.3.6 查询积压货款超过2W元的栏目,以及该栏目积压的货款"></a>3.3.6 查询积压货款超过2W元的栏目,以及该栏目积压的货款</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select cat_id,sum(goods_number*shop_price) as k from ecs_goods group by cat_id</span><br><span class="line">having k&gt;20000</span><br></pre></td></tr></table></figure>

<h4 id="3-3-7-where-having-group综合练习题"><a href="#3-3-7-where-having-group综合练习题" class="headerlink" title="3. 3.7 where-having-group综合练习题"></a>3. 3.7 where-having-group综合练习题</h4><blockquote>
<p>有如下表及数据</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+------+---------+-------+</span><br><span class="line">| name | subject | score |</span><br><span class="line">+------+---------+-------+</span><br><span class="line">| 张三 | 数学    |    90 |</span><br><span class="line">| 张三 | 语文    |    50 |</span><br><span class="line">| 张三 | 地理    |    40 |</span><br><span class="line">| 李四 | 语文    |    55 |</span><br><span class="line">| 李四 | 政治    |    45 |</span><br><span class="line">| 王五 | 政治    |    30 |</span><br><span class="line">+------+---------+-------+</span><br></pre></td></tr></table></figure>

<blockquote>
<p>要求:查询出2门及2门以上不及格者的平均成绩</p>
</blockquote>
<p>先查看每个人的平均成绩</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select name,avg(score) from stu group by name;</span><br><span class="line">+------+------------+</span><br><span class="line">| name | avg(score) |</span><br><span class="line">+------+------------+</span><br><span class="line">| 张三 |    60.0000 |</span><br><span class="line">| 李四 |    50.0000 |</span><br><span class="line">| 王五 |    30.0000 |</span><br><span class="line">| 赵六 |    99.0000 |</span><br><span class="line">+------+------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>看每个人挂科情况</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select name,score &lt; 60 from stu;</span><br><span class="line">+------+------------+</span><br><span class="line">| name | score &lt; 60 |</span><br><span class="line">+------+------------+</span><br><span class="line">| 张三 |          0 |</span><br><span class="line">| 张三 |          1 |</span><br><span class="line">| 张三 |          1 |</span><br><span class="line">| 李四 |          1 |</span><br><span class="line">| 李四 |          1 |</span><br><span class="line">| 王五 |          1 |</span><br><span class="line">| 赵六 |          0 |</span><br><span class="line">| 赵六 |          0 |</span><br><span class="line">| 赵六 |          0 |</span><br><span class="line">+------+------------+</span><br><span class="line">9 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>计算每个人的挂科科目</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select name,sum(score &lt; 60) from stu group by name;</span><br><span class="line">+------+-----------------+</span><br><span class="line">| name | sum(score &lt; 60) |</span><br><span class="line">+------+-----------------+</span><br><span class="line">| 张三 |               2 |</span><br><span class="line">| 李四 |               2 |</span><br><span class="line">| 王五 |               1 |</span><br><span class="line">| 赵六 |               0 |</span><br><span class="line">+------+-----------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>同时计算每人的平均分</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select name,sum(score &lt; 60),avg(score) as pj from stu group by name;</span><br><span class="line">+------+-----------------+---------+</span><br><span class="line">| name | sum(score &lt; 60) | pj      |</span><br><span class="line">+------+-----------------+---------+</span><br><span class="line">| 张三 |               2 | 60.0000 |</span><br><span class="line">| 李四 |               2 | 50.0000 |</span><br><span class="line">| 王五 |               1 | 30.0000 |</span><br><span class="line">| 赵六 |               0 | 99.0000 |</span><br><span class="line">+------+-----------------+---------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>利用<code>having</code>筛选挂科<code>2</code>门以上的.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select name,sum(score &lt; 60) as gk ,avg(score) as pj from stu group by name having gk &gt;=2;</span><br><span class="line">+------+------+---------+</span><br><span class="line">| name | gk   | pj      |</span><br><span class="line">+------+------+---------+</span><br><span class="line">| 张三 |    2 | 60.0000 |</span><br><span class="line">| 李四 |    2 | 50.0000 |</span><br><span class="line">+------+------+---------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="3-4、order-by-与-limit查询"><a href="#3-4、order-by-与-limit查询" class="headerlink" title="3.4、order by 与 limit查询"></a>3.4、order by 与 limit查询</h3><h4 id="3-4-1-按价格由高到低排序"><a href="#3-4-1-按价格由高到低排序" class="headerlink" title="3.4.1 按价格由高到低排序"></a>3.4.1 按价格由高到低排序</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select goods_id,goods_name,shop_price from ecs_goods order by shop_price desc;</span><br></pre></td></tr></table></figure>

<h4 id="3-4-2-按发布时间由早到晚排序"><a href="#3-4-2-按发布时间由早到晚排序" class="headerlink" title="3.4.2 按发布时间由早到晚排序"></a>3.4.2 按发布时间由早到晚排序</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select goods_id,goods_name,add_time from ecs_goods order by add_time;</span><br></pre></td></tr></table></figure>

<h4 id="3-4-3-接栏目由低到高排序-栏目内部按价格由高到低排序"><a href="#3-4-3-接栏目由低到高排序-栏目内部按价格由高到低排序" class="headerlink" title="3.4.3 接栏目由低到高排序,栏目内部按价格由高到低排序"></a>3.4.3 接栏目由低到高排序,栏目内部按价格由高到低排序</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select goods_id,cat_id,goods_name,shop_price from ecs_goods</span><br><span class="line">     order by cat_id ,shop_price desc;</span><br></pre></td></tr></table></figure>

<h4 id="3-4-4-取出价格最高的前三名商品"><a href="#3-4-4-取出价格最高的前三名商品" class="headerlink" title="3.4.4 取出价格最高的前三名商品"></a>3.4.4 取出价格最高的前三名商品</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select goods_id,goods_name,shop_price from ecs_goods order by shop_price desc limit 3;</span><br></pre></td></tr></table></figure>

<h4 id="3-4-5-取出点击量前三名到前5名的商品"><a href="#3-4-5-取出点击量前三名到前5名的商品" class="headerlink" title="3.4.5 取出点击量前三名到前5名的商品"></a>3.4.5 取出点击量前三名到前5名的商品</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select goods_id,goods_name,click_count from ecs_goods order by click_count desc limit 2,3;</span><br></pre></td></tr></table></figure>

<h3 id="3-5-连接查询"><a href="#3-5-连接查询" class="headerlink" title="3.5 连接查询"></a>3.5 连接查询</h3><h4 id="3-5-1-取出所有商品的商品名-栏目名-价格"><a href="#3-5-1-取出所有商品的商品名-栏目名-价格" class="headerlink" title="3.5.1 取出所有商品的商品名,栏目名,价格"></a>3.5.1 取出所有商品的商品名,栏目名,价格</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select goods_name,cat_name,shop_price from </span><br><span class="line">ecs_goods left join ecs_category</span><br><span class="line">on ecs_goods.cat_id=ecs_category.cat_id;</span><br></pre></td></tr></table></figure>

<h4 id="3-5-2-取出第4个栏目下的商品的商品名-栏目名-价格"><a href="#3-5-2-取出第4个栏目下的商品的商品名-栏目名-价格" class="headerlink" title="3.5.2 取出第4个栏目下的商品的商品名,栏目名,价格"></a>3.5.2 取出第4个栏目下的商品的商品名,栏目名,价格</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select goods_name,cat_name,shop_price from </span><br><span class="line">ecs_goods left join ecs_category</span><br><span class="line">on ecs_goods.cat_id=ecs_category.cat_id</span><br><span class="line">where ecs_goods.cat_id = 4;</span><br></pre></td></tr></table></figure>

<h4 id="3-5-3-取出第4个栏目下的商品的商品名-栏目名-与品牌名"><a href="#3-5-3-取出第4个栏目下的商品的商品名-栏目名-与品牌名" class="headerlink" title="3.5.3 取出第4个栏目下的商品的商品名,栏目名,与品牌名"></a>3.5.3 取出第4个栏目下的商品的商品名,栏目名,与品牌名</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">select goods_name,cat_name,brand_name from </span><br><span class="line">ecs_goods left join ecs_category</span><br><span class="line">on ecs_goods.cat_id=ecs_category.cat_id</span><br><span class="line">left join ecs_brand </span><br><span class="line">on ecs_goods.brand_id=ecs_brand.brand_id</span><br><span class="line">where ecs_goods.cat_id = 4;</span><br></pre></td></tr></table></figure>

<h4 id="3-5-4-面试题"><a href="#3-5-4-面试题" class="headerlink" title="3.5.4 面试题"></a>3.5.4 面试题</h4><blockquote>
<p>根据给出的表结构按要求写出<code>SQL</code>语句。</p>
</blockquote>
<p><strong>Match 赛程表</strong></p>
<table>
<thead>
<tr>
<th align="left">字段名称</th>
<th align="left">字段类型</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>matchID</code></td>
<td align="left"><code>int</code></td>
<td align="left">主键</td>
</tr>
<tr>
<td align="left"><code>hostTeamID</code></td>
<td align="left"><code>int</code></td>
<td align="left">主队的<code>ID</code></td>
</tr>
<tr>
<td align="left"><code>guestTeamID</code></td>
<td align="left"><code>int</code></td>
<td align="left">客队的<code>ID</code></td>
</tr>
<tr>
<td align="left"><code>matchResult</code></td>
<td align="left"><code>varchar(20)</code></td>
<td align="left">比赛结果，如（<code>2:0</code>）</td>
</tr>
<tr>
<td align="left"><code>matchTime</code></td>
<td align="left"><code>date</code></td>
<td align="left">比赛开始时间</td>
</tr>
</tbody></table>
<p><strong>Team 参赛队伍表</strong></p>
<table>
<thead>
<tr>
<th align="left">字段名称</th>
<th align="left">字段类型</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>teamID</code></td>
<td align="left"><code>int</code></td>
<td align="left">主键</td>
</tr>
<tr>
<td align="left"><code>teamName</code></td>
<td align="left"><code>varchar(20)</code></td>
<td align="left">队伍名称</td>
</tr>
</tbody></table>
<ul>
<li><code>Match</code>的<code>hostTeamID</code>与<code>guestTeamID</code>都与<code>Team</code>中的<code>teamID</code>关联</li>
<li>查出 <code>2006-6-1</code> 到<code>2006-7-1</code>之间举行的所有比赛，并且用以下形式列出：</li>
<li>拜仁 <code>2：0</code> 不来梅 <code>2006-6-21</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from m;</span><br><span class="line">+-----+------+------+------+------------+</span><br><span class="line">| mid | hid  | gid  | mres | matime     |</span><br><span class="line">+-----+------+------+------+------------+</span><br><span class="line">|   1 |    1 |    2 | 2:0  | 2006-05-21 |</span><br><span class="line">|   2 |    2 |    3 | 1:2  | 2006-06-21 |</span><br><span class="line">|   3 |    3 |    1 | 2:5  | 2006-06-25 |</span><br><span class="line">|   4 |    2 |    1 | 3:2  | 2006-07-21 |</span><br><span class="line">+-----+------+------+------+------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line">mysql&gt; select * from t;</span><br><span class="line">+------+----------+</span><br><span class="line">| tid  | tname    |</span><br><span class="line">+------+----------+</span><br><span class="line">|    1 | 国安     |</span><br><span class="line">|    2 | 申花     |</span><br><span class="line">|    3 | 公益联队 |</span><br><span class="line">+------+----------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line">mysql&gt; select hid,t1.tname as hname ,mres,gid,t2.tname as gname,matime</span><br><span class="line">    -&gt; from </span><br><span class="line">    -&gt; m left join t as t1</span><br><span class="line">    -&gt; on m.hid = t1.tid</span><br><span class="line">    -&gt; left join t as t2</span><br><span class="line">    -&gt; on m.gid = t2.tid;</span><br><span class="line">+------+----------+------+------+----------+------------+</span><br><span class="line">| hid  | hname    | mres | gid  | gname    | matime     |</span><br><span class="line">+------+----------+------+------+----------+------------+</span><br><span class="line">|    1 | 国安     | 2:0  |    2 | 申花     | 2006-05-21 |</span><br><span class="line">|    2 | 申花     | 1:2  |    3 | 公益联队 | 2006-06-21 |</span><br><span class="line">|    3 | 公益联队 | 2:5  |    1 | 国安     | 2006-06-25 |</span><br><span class="line">|    2 | 申花     | 3:2  |    1 | 国安     | 2006-07-21 |</span><br><span class="line">+------+----------+------+------+----------+------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="3-6、union查询"><a href="#3-6、union查询" class="headerlink" title="3.6、union查询"></a>3.6、union查询</h3><ul>
<li>把<code>ecs_comment</code>,<code>ecs_feedback</code>两个表中的数据,各取出<code>4</code>列,并把结果集<code>union</code>成一个结果集</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">A表:</span><br><span class="line">+------+------+</span><br><span class="line">| id   | num  |</span><br><span class="line">+------+------+</span><br><span class="line">| a    |    5 |</span><br><span class="line">| b    |   10 |</span><br><span class="line">| c    |   15 |</span><br><span class="line">| d    |   10 |</span><br><span class="line">+------+------+</span><br><span class="line">B表:</span><br><span class="line">+------+------+</span><br><span class="line">| id   | num  |</span><br><span class="line">+------+------+</span><br><span class="line">| b    |    5 |</span><br><span class="line">| c    |   15 |</span><br><span class="line">| d    |   20 |</span><br><span class="line">| e    |   99 |</span><br><span class="line">+------+------+</span><br></pre></td></tr></table></figure>

<p>要求查询出以下效果:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">+------+----------+</span><br><span class="line">| id   |    num   |</span><br><span class="line">+------+----------+</span><br><span class="line">| a    |        5 |</span><br><span class="line">| b    |       15 |</span><br><span class="line">| c    |       30 |</span><br><span class="line">| d    |       30 |</span><br><span class="line">| e    |       99 |</span><br><span class="line">+------+----------+</span><br><span class="line">create table a (</span><br><span class="line">id char(1),</span><br><span class="line">num int</span><br><span class="line">) engine myisam charset utf8;</span><br><span class="line"></span><br><span class="line">insert into a values (&#x27;a&#x27;,5),(&#x27;b&#x27;,10),(&#x27;c&#x27;,15),(&#x27;d&#x27;,10);</span><br><span class="line"></span><br><span class="line">create table b (</span><br><span class="line">id char(1),</span><br><span class="line">num int</span><br><span class="line">) engine myisam charset utf8;</span><br><span class="line"></span><br><span class="line">insert into b values (&#x27;b&#x27;,5),(&#x27;c&#x27;,15),(&#x27;d&#x27;,20),(&#x27;e&#x27;,99);</span><br><span class="line">mysql&gt; # 合并 ,注意all的作用</span><br><span class="line">mysql&gt; select * from ta </span><br><span class="line">    -&gt; union all</span><br><span class="line">    -&gt; select * from tb;</span><br><span class="line">+------+------+</span><br><span class="line">| id   | num  |</span><br><span class="line">+------+------+</span><br><span class="line">| a    |    5 |</span><br><span class="line">| b    |   10 |</span><br><span class="line">| c    |   15 |</span><br><span class="line">| d    |   10 |</span><br><span class="line">| b    |    5 |</span><br><span class="line">| c    |   15 |</span><br><span class="line">| d    |   20 |</span><br><span class="line">| e    |   99 |</span><br><span class="line">+------+------+</span><br></pre></td></tr></table></figure>

<p><strong>参考答案:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; # sum,group求和</span><br><span class="line">mysql&gt; select id,sum(num) from (select * from ta union all select * from tb) as tmp group by id;</span><br><span class="line">+------+----------+</span><br><span class="line">| id   | sum(num) |</span><br><span class="line">+------+----------+</span><br><span class="line">| a    |        5 |</span><br><span class="line">| b    |       15 |</span><br><span class="line">| c    |       30 |</span><br><span class="line">| d    |       30 |</span><br><span class="line">| e    |       99 |</span><br><span class="line">+------+----------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="3-7、子查询"><a href="#3-7、子查询" class="headerlink" title="3.7、子查询:"></a>3.7、子查询:</h3><p><strong>查询出最新一行商品(以商品编号最大为最新,用子查询实现)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select goods_id,goods_name from </span><br><span class="line">     ecs_goods where goods_id =(select max(goods_id) from ecs_goods);</span><br></pre></td></tr></table></figure>

<ul>
<li>查询出编号为<code>19</code>的商品的栏目名称(用左连接查询和子查询分别)</li>
<li>用<code>where</code>型子查询把<code>ecs_goods</code>表中的每个栏目下面最新的商品取出来</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select goods_id,goods_name,cat_id from ecs_goods where goods_id in (select max(goods_id) from ecs_goods group by cat_id);</span><br></pre></td></tr></table></figure>

<p><strong>用from型子查询把ecs_goods表中的每个栏目下面最新的商品取出来</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from (select goods_id,cat_id,goods_name from ecs_goods order by goods_id desc) as t group by cat_id;</span><br></pre></td></tr></table></figure>

<p><strong>用exists型子查询,查出所有有商品的栏目</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select * from category</span><br><span class="line">where exists (select * from goods where goods.cat_id=category.cat_id);</span><br></pre></td></tr></table></figure>

<p><strong>创建触发器:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CREATE  trigger tg2</span><br><span class="line">after insert on ord</span><br><span class="line">for each row</span><br><span class="line">update goods set goods_number=goods_number-new.num where id=new.gid</span><br><span class="line"></span><br><span class="line">CREATE trigger tg3</span><br><span class="line">after delete on ord</span><br><span class="line">for each row</span><br><span class="line">update goods set goods_number=good_number+old.num where id=old.gid</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE  trigger tg4</span><br><span class="line">after update on ord</span><br><span class="line">for each row</span><br><span class="line">update goods set goods_number=goods_number+old.num-new.num where id=old.gid</span><br></pre></td></tr></table></figure>

<h2 id="四、常用表管理语句"><a href="#四、常用表管理语句" class="headerlink" title="四、常用表管理语句"></a>四、常用表管理语句</h2><ul>
<li>设置字符编码 <code>set names gbk;</code></li>
<li>查看所有数据库：<code>show databases;</code></li>
<li>查看所有表：<code>show tables</code></li>
<li>查看表结构：<code>desc 表名/视图名</code></li>
<li>选择表 <code>use 表名;</code></li>
<li>查看建表过程：<code>show create table 表名</code></li>
<li>查看建视图过程：<code>show create view 视图</code></li>
<li>查看所有详细表信息：<code>show table status\G(让结果显示好看一些)</code></li>
<li>查看某张表详细信息：<code>show table status where name=&#39;goods（表名）&#39;\G</code></li>
<li>删除表：<code>drop table 表名</code></li>
<li>删除视图：<code>drop view 视图名；</code></li>
<li>删除列：<code>alter table drop column 指定列</code></li>
<li>改表名：<code>rename table oldName to newName</code></li>
<li>更新表：<code>update 表名 set 字段</code></li>
<li>插入数据：<code>insert into 表名 value()</code></li>
<li>清空数据：<code>truncate 表名;(相当于删除表在重建)</code></li>
<li>写错语句退出:<code>\c</code></li>
<li>让结果显示好看一些:<code>\G</code></li>
</ul>
<h2 id="五、查询总结"><a href="#五、查询总结" class="headerlink" title="五、查询总结"></a>五、查询总结</h2><h3 id="5-1-insert"><a href="#5-1-insert" class="headerlink" title="5.1 insert"></a>5.1 insert</h3><ul>
<li><code>insert into 表名</code> 插入列与值要严格对应</li>
<li>数字不必加单引号 字符串必须加单引号</li>
<li>例子：<code>insert into test(age,name)values(10,&#39;小明&#39;);</code></li>
</ul>
<h3 id="5-2-update操作"><a href="#5-2-update操作" class="headerlink" title="5.2 update操作"></a>5.2 update操作</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// 例子：</span><br><span class="line">update user set age=8 where name=lianying;</span><br><span class="line">//（注意where条件不加会影响所有行，需要小心）</span><br></pre></td></tr></table></figure>

<h3 id="5-3-delete操作"><a href="#5-3-delete操作" class="headerlink" title="5.3 delete操作"></a>5.3 delete操作</h3><ul>
<li>不可能针对某一列删除 要删必须一行</li>
<li><code>delete from 表名 where 添加</code></li>
<li><code>delete from user where uid=1;</code>（必须加上添加，否则全部数据删除）</li>
</ul>
<h3 id="5-4-select查找"><a href="#5-4-select查找" class="headerlink" title="5.4 select查找"></a>5.4 select查找</h3><ul>
<li><code>select * from 表名</code>（全部查出）</li>
<li><code>select uid,name from user where uid&gt;10;</code></li>
<li><code>select * from user where uid=11;</code></li>
</ul>
<h3 id="5-5-select查询模型（重要）"><a href="#5-5-select查询模型（重要）" class="headerlink" title="5.5 select查询模型（重要）"></a>5.5 select查询模型（重要）</h3><ul>
<li><code>select * from 表名 where 1</code>（<code>where</code>是一个表达式 为真则取出来 为假不取）</li>
<li>把列看成变量，既然是变量就能参与运。这个过程称为广义投影（比如：取出两列参与运算）也可以带到函数里面计算</li>
</ul>
<blockquote>
<p>注意：<code>NULL</code>：查询方法： <code>select * from test where name is （not）null</code></p>
</blockquote>
<h3 id="5-6-limit用法（做分页类能用到）"><a href="#5-6-limit用法（做分页类能用到）" class="headerlink" title="5.6 limit用法（做分页类能用到）"></a>5.6 limit用法（做分页类能用到）</h3><blockquote>
<p>限制取出条目（limit有两个参数 ：偏移量 取出的条目）</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select goods_id,goods_name,shop_price</span><br><span class="line">	-&gt; from goods</span><br><span class="line">	-&gt; order by shop_price desc</span><br><span class="line">	-&gt; limit  0,3;</span><br></pre></td></tr></table></figure>

<h3 id="5-7-子句的查询陷阱"><a href="#5-7-子句的查询陷阱" class="headerlink" title="5.7 子句的查询陷阱"></a>5.7 子句的查询陷阱</h3><blockquote>
<p><code>5</code>种语句有严格的顺序，<code>where</code> ，<code>group by</code>,<code>having</code>,<code>order by</code>,<code>limit</code><br>不能颠倒顺序</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 例子:语句有严格的顺序</span><br><span class="line">mysql&gt; select id,sum(num) </span><br><span class="line">					-&gt; from</span><br><span class="line">					-&gt; (select * from a union select * from b) as temp</span><br><span class="line">					-&gt; group by id</span><br><span class="line">					-&gt; having sum(num)&gt;10</span><br><span class="line">					-&gt; order by sum(num) desc</span><br><span class="line">					-&gt; limit 0,1;</span><br></pre></td></tr></table></figure>

<h3 id="5-8-子查询"><a href="#5-8-子查询" class="headerlink" title="5.8 子查询"></a>5.8 子查询</h3><p><strong>where字查询：（内层的查询结果作为外层的比较条件）</strong></p>
<ul>
<li>静态的：select goods_id,goods_name from goods where goods_id&#x3D;32;</li>
<li>动态的：select goods_id,goods_name from goods where goods_id&#x3D;(select max(goods_id) from goods);</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#取出每个栏目下最新的商品：</span><br><span class="line">select goods_id,cat_id,goods_name from goods where goods_id in (select max(goods_id) from goods group by cat_id);</span><br></pre></td></tr></table></figure>

<h3 id="5-9-from子查询"><a href="#5-9-from子查询" class="headerlink" title="5.9 from子查询"></a>5.9 from子查询</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#每个栏目下最新的商品：</span><br><span class="line">		mysql&gt; select goods_id,goods_name from (select * from goods where 1 order by cat_id desc) as tmp</span><br><span class="line">			-&gt; group by cat_id;</span><br></pre></td></tr></table></figure>

<h3 id="5-10-exists子查询："><a href="#5-10-exists子查询：" class="headerlink" title="5.10 exists子查询："></a>5.10 exists子查询：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#查询栏目下是否有商品</span><br><span class="line">		mysql&gt; select * from category</span><br><span class="line">			-&gt; where exists(select * from goods where goods.cat_id=category.cat_id)</span><br></pre></td></tr></table></figure>

<h3 id="5-11-内连接查询（重要）"><a href="#5-11-内连接查询（重要）" class="headerlink" title="5.11 内连接查询（重要）"></a>5.11 内连接查询（重要）</h3><blockquote>
<p>内连接是左右连接结果的交集</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select xxx from</span><br><span class="line">			table1 inner jion table2 on table1.xx=table2.xx</span><br><span class="line">			</span><br><span class="line">		</span><br><span class="line">mysql&gt; select boy.hid,boy.bname,girl.hid,girl.gname</span><br><span class="line">			-&gt; from</span><br><span class="line">			-&gt; boy inner join girl on boy.hid=girl.hid;</span><br></pre></td></tr></table></figure>

<h3 id="5-12-左连接特点"><a href="#5-12-左连接特点" class="headerlink" title="5.12 左连接特点"></a>5.12 左连接特点</h3><blockquote>
<p>以左表的数据为标准，去找右表的数据，查不到的为<code>NULL</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#左连接</span><br><span class="line">mysql&gt; select boy.hid,boy.bname,girl.hid,girl.gname</span><br><span class="line">	-&gt; from</span><br><span class="line">	-&gt; boy left join girl on boy.hid=girl.hid;</span><br><span class="line"></span><br><span class="line">#右连接</span><br><span class="line">mysql&gt; select boy.hid,boy.bname,girl.hid,girl.gname</span><br><span class="line">-&gt; from</span><br><span class="line">-&gt; boy right join girl on boy.hid=girl.hid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; select goods_id,cat_name,goods_name,shop_price</span><br><span class="line">	-&gt; from</span><br><span class="line">	-&gt; goods left join category on goods.cat_id= category.cat_id</span><br><span class="line">	-&gt; where goods.cat_id=4;</span><br></pre></td></tr></table></figure>

<h3 id="5-13-union查询"><a href="#5-13-union查询" class="headerlink" title="5.13 union查询"></a>5.13 union查询</h3><blockquote>
<p>把<code>2</code>条或多条的额查询结果，合并成<code>1</code>个结果集</p>
</blockquote>
<ul>
<li><code>sql1 N行</code></li>
<li><code>sql2 M行</code></li>
<li><code>sql1 union sql2，N+M行</code></li>
</ul>
<blockquote>
<ul>
<li><code>union</code>语句必须满足一个条件：各语句取出的列数要相同</li>
<li><code>union</code>语句中不用写<code>order by</code> 因为<code>sql</code>合并后得到总的结果集可以<code>order by</code>字句<code>order by</code>失去意义</li>
<li>场景：<code>2</code>条语句，各自的<code>where</code>非常复杂，可以简化成简单的条件在<code>union</code></li>
<li>注意：使用<code>union</code>时，完全相等的行将会被合并。合并是比较耗时的操作，一般不让<code>union</code>合并，使用<code>union all</code>可以避免合并 对速度有提升</li>
</ul>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from a</span><br><span class="line">	-&gt; union all #union all 可以避免重复语句合并</span><br><span class="line">	-&gt; select * from b;</span><br><span class="line"></span><br><span class="line">mysql&gt; select goods_id,cat_id,goods_name,shop_price from goods where cat_id=2</span><br><span class="line">	-&gt; union</span><br><span class="line">	-&gt; select goods_id,cat_id,goods_name,shop_price from goods where cat_id=4;</span><br><span class="line">​```			</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 六、建表总结</span><br><span class="line"></span><br><span class="line">​```bash</span><br><span class="line">create table 表名 （</span><br><span class="line">	列1 列类型 [列属性 默认值]</span><br><span class="line">	列2 列类型 [列属性 默认值]</span><br><span class="line">	...</span><br><span class="line">	);</span><br><span class="line">	engine = 存储引擎</span><br><span class="line">	chartset = 字符集</span><br></pre></td></tr></table></figure>

<blockquote>
<p>建表过程：声明表头的过程，也就是声明列的过程</p>
</blockquote>
<ul>
<li>选择合理的列类型 合理的列宽度（即放下内容 又不浪费磁盘空间）</li>
<li>列选什么类型的列 列给什么样的属性</li>
<li>数值型–整形，浮点型，定点型</li>
<li>字符串型–<code>char</code> <code>varchar</code> <code>text</code></li>
<li>日期时间类型–<code>2012-12-13 14.25.36</code></li>
</ul>
<h3 id="6-1-整型列"><a href="#6-1-整型列" class="headerlink" title="6.1 整型列"></a>6.1 整型列</h3><table>
<thead>
<tr>
<th align="left">类型：</th>
<th align="left">字节：</th>
<th align="left">最小值：</th>
<th align="left">最大值：</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>bigint</code></td>
<td align="left"><code>8</code>字节</td>
<td align="left"><code>-9223372036854775808</code></td>
<td align="left">18446744073709551615</td>
</tr>
<tr>
<td align="left"><code>int</code></td>
<td align="left"><code>4</code>字节</td>
<td align="left"><code>-2147483648</code></td>
<td align="left"><code>4294967295</code></td>
</tr>
<tr>
<td align="left"><code>mediunint</code></td>
<td align="left"><code>3</code>字节</td>
<td align="left"><code>-8388608</code></td>
<td align="left"><code>8388607</code></td>
</tr>
<tr>
<td align="left"><code>smallint</code></td>
<td align="left">&#96;2字节</td>
<td align="left"><code>-32768</code></td>
<td align="left"><code>3276</code>7</td>
</tr>
<tr>
<td align="left"><code>tinyint</code></td>
<td align="left"><code>1</code>字节</td>
<td align="left"><code>-128</code></td>
<td align="left"><code>127</code></td>
</tr>
</tbody></table>
<blockquote>
<p>整型列的可选参数</p>
</blockquote>
<ul>
<li><code>unsigned</code> 无符号，列的值从<code>0</code>开始不为负</li>
<li><code>zerofill M</code>（宽度）适合用于 学号 编码等固定宽度的数字，可以用0填充至固定宽度</li>
<li>学号：<code>1--0001</code></li>
<li>注意：<code>zerofill</code>属性默认决定是<code>unsigned</code></li>
</ul>
<h3 id="6-2-浮点列与定点列"><a href="#6-2-浮点列与定点列" class="headerlink" title="6.2 浮点列与定点列"></a>6.2 浮点列与定点列</h3><ul>
<li><code>float（M，D）</code> <code>M</code>是精度总位数 <code>D</code>代表小数点后面的位数</li>
<li><code>float/double</code> 范围区别和<code>decimal</code>相比：浮点数存储有精度的损失</li>
<li><code>decimal</code> 定点型更精确</li>
</ul>
<h3 id="6-3-字符型列"><a href="#6-3-字符型列" class="headerlink" title="6.3 字符型列"></a>6.3 字符型列</h3><ul>
<li><p><code>char(M)</code>–<code>char(10)</code>只能存<code>10</code>个字符</p>
</li>
<li><pre><code>char
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">型:如果不够</span><br><span class="line"></span><br></pre></td></tr></table></figure>
M
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  个字符，内部会用空格补齐，取出时在把右侧空格删掉</span><br><span class="line"></span><br><span class="line">  - 注意：这意味着右侧本身有空格将会丢失</span><br><span class="line"></span><br><span class="line">- `varchar(M)`–用多少占多少–自动扩展</span><br><span class="line"></span><br><span class="line">- `varchar`不会丢失空格</span><br><span class="line"></span><br><span class="line">- 速度上：定长`char`快一些 在一定范围内用`char`定长寻址快 速度快</span><br><span class="line"></span><br><span class="line">- `M`比较短`20`个以内用`char`</span><br><span class="line"></span><br><span class="line">- `text` 存大段文本</span><br><span class="line"></span><br><span class="line">- ```</span><br><span class="line">  blob</span><br></pre></td></tr></table></figure>

 

是二进制类型 用来存图像信息 音频等二进制信息

- `blob`意义在于防止因为字符集的问题导致信息丢失
</code></pre>
</li>
<li><p>&#96;&#96;&#96;<br>enum</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  枚举类型：是定义好 值就在某几个枚举范围内</span><br><span class="line"></span><br><span class="line">  - `gender emum(&#x27;男&#x27;,&#x27;女&#x27;) insert` 只能选其中之一</span><br><span class="line"></span><br><span class="line">### 6.4 日期时间类型</span><br><span class="line"></span><br><span class="line">- `year`：存年份</span><br><span class="line">- `date`:存年份日期2016-18</span><br><span class="line">- `time`：存时分秒</span><br><span class="line">- `datetime`:年月日时分秒</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>mysql&gt; create table t8(<br>  -&gt; ya year,<br>  -&gt; dt date,<br>  -&gt; tm time,<br>  -&gt; dttm datetime);<br>  -&gt; insert into t8 (ya,dt,tm) values(2015,’2015-12-18’,’18:28:36’);</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### 6.5 列的默认值</span><br><span class="line"></span><br><span class="line">- `NULL`查询不方便</span><br><span class="line">- `NULL`索引效率不高</span><br><span class="line">- 实际中避免列的值为`NULL`</span><br><span class="line"></span><br><span class="line">&gt; 如何避免：声明列`NOT NULL default`默认值</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>mysql&gt; create table t10(<br>  -&gt; id int not null default 0,<br>  -&gt; name char(10) not null default ‘’<br>  -&gt; );</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### 6.6 主键与自增</span><br><span class="line"></span><br><span class="line">- 主键`primary key` 此列不重复，能区分每一行</span><br><span class="line">- `primary key,auto_increment(一般那两个一起出现)`</span><br><span class="line">- 注意：一张表列只能有一列为`auto_increment` 且此列必须加索引（`index` `key`）</span><br><span class="line">- 优化：</span><br><span class="line">  - 定长（`char`）与变长（`varchar`）分离</span><br><span class="line">  - 常用与不常用列分离</span><br><span class="line">  - 能提高表的查询效率</span><br><span class="line"></span><br><span class="line">### 6.7 列的删除与增加：（列的增删改）</span><br><span class="line"></span><br><span class="line">- `alter table 表名 add 列名 列类型 列属性` 默认在表的最后</span><br><span class="line">- `alter table 表名 drop column 指定列`–删除列</span><br><span class="line">- `alter table 表名 add 列名 列类型 列属性` [`after` 指定列的后面]</span><br><span class="line">- `alter table 表名 change height(要修改的) shengao（被修改后的） smallint`</span><br><span class="line">- `alter table 表名 modify 列名` 要改成的新的属性</span><br><span class="line"></span><br><span class="line">### 6.8 视图：（存储的都是语句）</span><br><span class="line"></span><br><span class="line">&gt; `view`被称为虚拟表，view是sql语句的查询结果（物理表的一个映射结果，物理表一改变，视图表也改变）</span><br><span class="line"></span><br><span class="line">**1. view好处**</span><br><span class="line"></span><br><span class="line">- 权限控制可用：</span><br><span class="line">  - 比如某几个列允许用户查询，其他不允许</span><br><span class="line">  - 可通过视图开放其中一列或几列，起到权限控制作用</span><br><span class="line">- 简化复杂的查询</span><br><span class="line">- 视图能更新？</span><br><span class="line">  - 如果视图的每一行是与物理表一一对应的可以</span><br><span class="line">  - view的行是由物理表多行经过计算得到的结果，view不可以更新</span><br><span class="line"></span><br><span class="line">**2. 视图的algorithm**</span><br><span class="line"></span><br><span class="line">- 对于检查查询形成的view，在对view查询时，如order by where</span><br><span class="line">- 可以把建视图语句+查视图的语句===合并成==&gt;查物理的语句</span><br><span class="line">- 这种视图的算法叫merger（合并）</span><br><span class="line"></span><br><span class="line">### 6.9 引擎的概念</span><br><span class="line"></span><br><span class="line">- `mysql 5.0`以上默认的引擎是`innoDB` 一般建表时指定引擎</span><br><span class="line">- `myisam`引擎存储的数据可以直接考出来拿去用</span><br><span class="line">- `innDB`要把数据导出来</span><br><span class="line"></span><br><span class="line">&gt; `myisam`和`innDB`引擎区别</span><br><span class="line"></span><br><span class="line">| mysiam           | innDB |        |</span><br><span class="line">| :--------------- | :---- | ------ |</span><br><span class="line">| 批量插入的速度： | 高    | 低     |</span><br><span class="line">| 存储限制：       | 没有  | `64TB` |</span><br><span class="line"></span><br><span class="line">### 6.10 字符集与乱码问题</span><br><span class="line"></span><br><span class="line">- 字符集、校对集(排序规则)、乱码</span><br><span class="line">- 文字本来的字符集与展示的字符集不一致导致</span><br><span class="line">- 客户端编码设置：`set names gbk/utf8;`</span><br><span class="line">- 表设置编码:`create table ()charset utf8;`</span><br><span class="line">- 服务器端`utf8/gbk` 都可</span><br><span class="line">- 网页的话：`mate:charset=utf8;`</span><br><span class="line"></span><br><span class="line">### 6.11 索引</span><br><span class="line"></span><br><span class="line">- 索引是数据的目录，能快速定位行数据的位置</span><br><span class="line">- 索引提高了查询的速度，降低了增删改的速度，并非越多越好</span><br><span class="line">- 一般在查询频率的列上加，而且在重复低列上加效果好</span><br><span class="line">- `key` 普通索引</span><br><span class="line">- `unique key` 唯一键</span><br><span class="line">- `primary key` 主键索引</span><br><span class="line">- 索引长度：建索引时，可以只索引列的前一部分的内容比如：前十个字符 `key email(email(10));`</span><br><span class="line">- 多列索引:就是把`2`列或者多列的值，看成一个整体，然后键索引</span><br><span class="line">- 冗余索引：在某个列上可能存在多个索引</span><br><span class="line"></span><br><span class="line">### 6.12 索引操作</span><br><span class="line"></span><br><span class="line">- 查看索引：`show index from goods\G`</span><br><span class="line"></span><br><span class="line">- 删除索引：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>alter table 表名 drop index 索引名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  - 或者：`drop index 索引名 on 表名`</span><br><span class="line"></span><br><span class="line">- 添加：`alter table 表名 add [index \unqiue]索引名(列名)`</span><br><span class="line"></span><br><span class="line">- 添加主键索引：`alter table 表名 add primary key 列名`</span><br><span class="line"></span><br><span class="line">- 删除主键索引：`alter table 表名 drop primary key`</span><br><span class="line"></span><br><span class="line">## 七、常用函数</span><br><span class="line"></span><br><span class="line">### 7.1 数学函数</span><br><span class="line"></span><br><span class="line">- `abs(x)` 返回x的绝对值</span><br><span class="line">- `bin(x)` 返回x的二进制（oct返回八进制，hex返回十六进制）</span><br><span class="line">- `ceiling(x)` 返回大于x的最小整数值</span><br><span class="line">- `exp(x)` 返回值`e`（自然对数的底）的`x`次方</span><br><span class="line">- `floor(x)` 返回小于`x`的最大整数值</span><br><span class="line">- `greatest(x1,x2,...,xn)`返回集合中最大的值</span><br><span class="line">- `least(x1,x2,...,xn)` 返回集合中最小的值</span><br><span class="line">- `ln(x)` 返回x的自然对数</span><br><span class="line">- `log(x,y)`返回`x`的以`y`为底的对数</span><br><span class="line">- `mod(x,y)` 返回x/y的模（余数）</span><br><span class="line">- `pi()`返回`pi`的值（圆周率）</span><br><span class="line">- `rand()`返回`０`到`1`内的随机值,可以通过提供一个参数(种子)使`rand()`随机数生成器生成一个指定的值。</span><br><span class="line">- `round(x,y)`返回参数`x`的四舍五入的有`y`位小数的值</span><br><span class="line">- `sign(x)`返回代表数字`x`的符号的值</span><br><span class="line">- `sqrt(x)`返回一个数的平方根</span><br><span class="line">- `truncate(x,y)` 返回数字`x`截短为`y`位小数的结果</span><br><span class="line"></span><br><span class="line">### 7.2 聚合函数(常用于group by从句的select查询中)</span><br><span class="line"></span><br><span class="line">- `avg(col)`返回指定列的平均值</span><br><span class="line">- `count(col)`返回指定列中非`null`值的个数</span><br><span class="line">- `min(col)`返回指定列的最小值</span><br><span class="line">- `max(col)`返回指定列的最大值</span><br><span class="line">- `sum(col)`返回指定列的所有值之和</span><br><span class="line">- `group_concat(col)`返回由属于一组的列值连接组合而成的结果</span><br><span class="line"></span><br><span class="line">### 7.3 字符串函数</span><br><span class="line"></span><br><span class="line">- `ascii(char)`返回字符的`ascii`码值</span><br><span class="line">- `bit_length(str)`返回字符串的比特长度</span><br><span class="line">- `concat(s1,s2...,sn)`将s`1,s2...,sn`连接成字符串</span><br><span class="line">- `concat_ws(sep,s1,s2...,sn)`将`s1,s2...,sn`连接成字符串，并用`sep`字符间隔</span><br><span class="line">- `insert(str,x,y,instr)`将字符串`str`从第`x`位置开始，`y`个字符长的子串替换为字符串`instr`，返回结果</span><br><span class="line">- `find_in_set(str,list)`分析逗号分隔的`list`列表，如果发现`str`，返回`str`在`list`中的位置</span><br><span class="line">- `lcase(str)`或`lower(str)` 返回将字符串`str`中所有字符改变为小写后的结果</span><br><span class="line">- `left(str,x)`返回字符串`str`中最左边的`x`个字符</span><br><span class="line">- `length(s)`返回字符串`str`中的字符数</span><br><span class="line">- `ltrim(str)` 从字符串`str`中切掉开头的空格</span><br><span class="line">- `position(substr,str)` 返回子串`substr`在字符串`str`中第一次出现的位置</span><br><span class="line">- `quote(str)` 用反斜杠转义`str`中的单引号</span><br><span class="line">- `repeat(str,srchstr,rplcstr)`返回字符串`str`重复`x`次的结果</span><br><span class="line">- `reverse(str) 返回颠倒字符串`str`的结果</span><br><span class="line">- `right(str,x) 返回字符串`str`中最右边的`x`个字符</span><br><span class="line">- `rtrim(str) 返回字符串`str`尾部的空格</span><br><span class="line">- `strcmp(s1,s2)`比较字符串`s1`和`s2`</span><br><span class="line">- `trim(str)`去除字符串首部和尾部的所有空格</span><br><span class="line">- `ucase(str)`或`upper(str)` 返回将字符串`str`中所有字符转变为大写后的结果</span><br><span class="line"></span><br><span class="line">### 7.4 日期和时间函数</span><br><span class="line"></span><br><span class="line">- `curdate()`或`current_date()` 返回当前的日期</span><br><span class="line">- `curtime()`或`current_time()` 返回当前的时间</span><br><span class="line">- `date_add(date,interval int - keyword)`返回日期`date`加上间隔时间`int`的结果(`int`必须按照关键字进行格式化),如：`selectdate_add(current_date,interval 6 month);`</span><br><span class="line">- `date_format(date,fmt)` 依照指定的`fmt`格式格式化日期`date`值</span><br><span class="line">- `date_sub(date,interval int - keyword)`返回日期`date`加上间隔时间`int`的结果(`int`必须按照关键字进行格式化),如：`selectdate_sub(current_date,interval 6 month);`</span><br><span class="line">- `dayofweek(date)` 返回date所代表的一星期中的第几天(`1~7`)</span><br><span class="line">- `dayofmonth(date)` 返回date是一个月的第几天(`1~31`)</span><br><span class="line">- `dayofyear(date)` 返回date是一年的第几天(`1~366`)</span><br><span class="line">- `dayname(date)` 返回date的星期名，如：`select dayname(current_date);`</span><br><span class="line">- `from_unixtime(ts,fmt)` 根据指定的`fmt`格式，格式化`unix`时间戳`ts`</span><br><span class="line">- `hour(time)` 返回time的小时值`(0~23)`</span><br><span class="line">- `minute(time)` 返回time的分钟值`(0~59)`</span><br><span class="line">- `month(date)` 返回`date`的月份值`(1~12)`</span><br><span class="line">- `monthname(date)` 返回`date`的月份名，如：`select monthname(current_date);`</span><br><span class="line">- `now()` 返回当前的日期和时间</span><br><span class="line">- `quarter(date)` 返回`date`在一年中的季度`(1~4)`，如`select quarter(current_date);``</span><br><span class="line">- `week(date)` 返回日期`date`为一年中第几周(`0~53`)</span><br><span class="line">- `year(date)` 返回日期`date`的年份(`1000~9999`)</span><br><span class="line"></span><br><span class="line">**一些示例**</span><br><span class="line"></span><br><span class="line">- 获取当前系统时间：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>select from_unixtime(unix_timestamp());</p>
</li>
</ul>
<p>select extract(year_month from current_date);</p>
<p>select extract(day_second from current_date);</p>
<p>select extract(hour_minute from current_date);</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 返回两个日期值之间的差值(月数)：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>select period_diff(200302,199802);</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 在`mysql`中计算年龄：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>select date_format(from_days(to_days(now())-to_days(birthday)),’%y’)+0 as age from employee;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&gt; 这样，如果`brithday`是未来的年月日的话，计算结果为`0`。</span><br><span class="line"></span><br><span class="line">下面的`sql`语句计算员工的绝对年龄，即当`birthday`是未来的日期时，将得到负值</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>select date_format(now(), ‘%y’) - date_format(birthday, ‘%y’) -(date_format(now(), ‘00-%m-%d’) &lt;date_format(birthday, ‘00-%m-%d’)) as age from employee</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### 7.5 加密函数</span><br><span class="line"></span><br><span class="line">- `aes_encrypt(str,key)` 返回用密钥`key`对字符串`str`利用高级加密标准算法加密后的结果，调用`aes_encrypt`的结果是一个二进制字符串，以`blob`类型存储</span><br><span class="line">- `aes_decrypt(str,key)` 返回用密钥`key`对字符串`str`利用高级加密标准算法解密后的结果</span><br><span class="line">- `decode(str,key)` 使用`key`作为密钥解密加密字符串`str`</span><br><span class="line">- `encrypt(str,salt)` 使用`unixcrypt()`函数，用关键词`salt`(一个可以惟一确定口令的字符串，就像钥匙一样)加密字符串`str`</span><br><span class="line">- `encode(str,key)` 使用key作为密钥加密字符串str，调用`encode()`的结果是一个二进制字符串，它以`blob`类型存储</span><br><span class="line">- `md5()` 计算字符串`str`的`md5`校验和</span><br><span class="line">- `password(str)` 返回字符串`str`的加密版本，这个加密过程是不可逆转的，和`unix`密码加密过程使用不同的算法。</span><br><span class="line">- `sha()` 计算字符串`str`的安全散列算法(`sha`)校验和</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h1><p>select encrypt(‘root’,’salt’);<br>select encode(‘xufeng’,’key’);<br>select decode(encode(‘xufeng’,’key’),’key’);#加解密放在一起<br>select aes_encrypt(‘root’,’key’);<br>select aes_decrypt(aes_encrypt(‘root’,’key’),’key’);<br>select md5(‘123456’);<br>select sha(‘123456’);</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### 7.6 格式化函数</span><br><span class="line"></span><br><span class="line">- `date_format(date,fmt)` 依照字符串`fmt`格式化日期`date`值</span><br><span class="line">- `format(x,y)` 把`x`格式化为以逗号隔开的数字序列，`y`是结果的小数位数</span><br><span class="line">- `inet_aton(ip)` 返回`ip`地址的数字表示</span><br><span class="line">- `inet_ntoa(num)` 返回数字所代表的`ip`地址</span><br><span class="line">- `time_format(time,fmt)` 依照字符串`fmt`格式化时间`time`值</span><br><span class="line">- 其中最简单的是`format()`函数，它可以把大的数值格式化为以逗号间隔的易读的序列。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="示例：-1"><a href="#示例：-1" class="headerlink" title="示例："></a>示例：</h1><p>select format(34234.34323432,3);</p>
<p>select date_format(now(),’%w,%d %m %y %r’);</p>
<p>select date_format(now(),’%y-%m-%d’);</p>
<p>select date_format(19990330,’%y-%m-%d’);</p>
<p>select date_format(now(),’%h:%i %p’);</p>
<p>select inet_aton(‘10.122.89.47’);</p>
<p>select inet_ntoa(175790383);</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### 7.7 类型转化函数</span><br><span class="line"></span><br><span class="line">&gt; 为了进行数据类型转化，`mysql`提供了`cast()`函数，它可以把一个值转化为指定的数据类型。类型有：`binary`,`char`,`date`,`time`,`datetime`,`igned`,`unsigned`</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="示例：-2"><a href="#示例：-2" class="headerlink" title="示例："></a>示例：</h1><p>select cast(now() as signed integer),curdate()+0;<br>select ‘f’&#x3D;binary ‘f’,’f’&#x3D;cast(‘f’ as binary);</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### 7.8 系统信息函数</span><br><span class="line"></span><br><span class="line">- `database()` 返回当前数据库名</span><br><span class="line">- `benchmark(count,expr)` 将表达式`expr`重复运行`count`次</span><br><span class="line">- `connection_id()` 返回当前客户的连接`id`</span><br><span class="line">- `found_rows()` 返回最后一个`select`查询进行检索的总行数</span><br><span class="line">- `user()`或`system_user()` 返回当前登陆用户名</span><br><span class="line">- `version()` 返回`mysql`服务器的版本</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="示例：-3"><a href="#示例：-3" class="headerlink" title="示例："></a>示例：</h1><p>select database(),version(),user();</p>
<p>#该例中,mysql计算log(rand()*pi())表达式9999999次。<br>selectbenchmark(9999999,log(rand()*pi()));</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 八、Mysql十条常用语句</span><br><span class="line"></span><br><span class="line">**1. 链接到数据库服务器**</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>mysql -h 地址 -u root -p 密码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**2. 查看所有库**</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>show databases;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**3. 选库**</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>use 库名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**4. 查看库下面的表**</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>show tables;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**5. 建表**</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>create table msg{<br>    id int auto_increment primary key，<br>    content varcha(200)，<br>    pubtime int<br>}charset utf8;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**6. 告诉服务器你的字符集：set names gbk/utg8;**</span><br><span class="line"></span><br><span class="line">**7. 添加数据**</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>insert into msg(id,content,pubtime) values(1,’哈哈哈哈’,13445);</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**8. 查询所有数据**</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>select * from msg;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**9. 按id查询**</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>select * from where id &#x3D; 2…</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**10. 快速清空表**</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>truncate 表名</p>
<p>&#96;&#96;&#96;</p>
<h2 id="九、可视化管理数据"><a href="#九、可视化管理数据" class="headerlink" title="九、可视化管理数据"></a>九、可视化管理数据</h2><blockquote>
<p>一般为了方便管理数据，我们都需要用到可视化工具</p>
</blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.navicat.com.cn/download/navicat-for-mysql">navicat-for-mysql</a></li>
</ul>
<blockquote>
<p>这里提供一份数据表，供学习使用，<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_33699659/article/details/79261661">导入sql数据到navicat</a></p>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://blog.poetries.top/sql/mysql-table.sql">http://blog.poetries.top/sql/mysql-table.sql</a></p>
</blockquote>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-设计模式/工厂模式" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/03/12/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/" class="article-date">
  	<time datetime="2019-03-12T08:38:26.000Z" itemprop="datePublished">2019-03-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/12/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/">
        工厂模式
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一、是什么"><a href="#一、是什么" class="headerlink" title="一、是什么"></a>一、是什么</h2><p>工厂模式是用来创建对象的一种最常用的设计模式，不暴露创建对象的具体逻辑，而是将将逻辑封装在一个函数中，那么这个函数就可以被视为一个工厂</p>
<p>其就像工厂一样重复的产生类似的产品，工厂模式只需要我们传入正确的参数，就能生产类似的产品</p>
<p>举个例子：</p>
<ul>
<li>编程中，在一个 A 类中通过 new 的方式实例化了类 B，那么 A 类和 B 类之间就存在关联（耦合）</li>
<li>后期因为需要修改了 B 类的代码和使用方式，比如构造函数中传入参数，那么 A 类也要跟着修改，一个类的依赖可能影响不大，但若有多个类依赖了 B 类，那么这个工作量将会相当的大，容易出现修改错误，也会产生很多的重复代码，这无疑是件非常痛苦的事；</li>
<li>这种情况下，就需要将创建实例的工作从调用方（A类）中分离，与调用方<strong>解耦</strong>，也就是使用工厂方法创建实例的工作封装起来（<strong>减少代码重复</strong>），由工厂管理对象的创建逻辑，调用方不需要知道具体的创建过程，只管使用，<strong>而降低调用者因为创建逻辑导致的错误</strong>；</li>
</ul>
<h2 id="二、实现"><a href="#二、实现" class="headerlink" title="二、实现"></a>二、实现</h2><p>工厂模式根据抽象程度的不同可以分为：</p>
<ul>
<li>简单工厂模式（Simple Factory）</li>
<li>工厂方法模式（Factory Method）</li>
<li>抽象工厂模式（Abstract Factory）</li>
</ul>
<h3 id="简单工厂模式"><a href="#简单工厂模式" class="headerlink" title="简单工厂模式"></a>简单工厂模式</h3><p>简单工厂模式也叫静态工厂模式，用一个工厂对象创建同一类对象类的实例</p>
<p>假设我们要开发一个公司岗位及其工作内容的录入信息，不同岗位的工作内容不一致</p>
<p>代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Factory</span>(<span class="params">career</span>) &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">User</span>(<span class="params">career, work</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">career</span> = career </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">work</span> = work</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> work</span><br><span class="line">    <span class="keyword">switch</span>(career) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;coder&#x27;</span>:</span><br><span class="line">            work =  [<span class="string">&#x27;写代码&#x27;</span>, <span class="string">&#x27;修Bug&#x27;</span>] </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(career, work)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;hr&#x27;</span>:</span><br><span class="line">            work = [<span class="string">&#x27;招聘&#x27;</span>, <span class="string">&#x27;员工信息管理&#x27;</span>]</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(career, work)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;driver&#x27;</span>:</span><br><span class="line">            work = [<span class="string">&#x27;开车&#x27;</span>]</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(career, work)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;boss&#x27;</span>:</span><br><span class="line">            work = [<span class="string">&#x27;喝茶&#x27;</span>, <span class="string">&#x27;开会&#x27;</span>, <span class="string">&#x27;审批文件&#x27;</span>]</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(career, work)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> coder = <span class="keyword">new</span> <span class="title class_">Factory</span>(<span class="string">&#x27;coder&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(coder)</span><br><span class="line"><span class="keyword">let</span> boss = <span class="keyword">new</span> <span class="title class_">Factory</span>(<span class="string">&#x27;boss&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(boss)</span><br></pre></td></tr></table></figure>

<p><code>Factory</code>就是一个简单工厂。当我们调用工厂函数时，只需要传递name、age、career就可以获取到包含用户工作内容的实例对象</p>
<h3 id="工厂方法模式"><a href="#工厂方法模式" class="headerlink" title="工厂方法模式"></a>工厂方法模式</h3><p>工厂方法模式跟简单工厂模式差不多，但是把具体的产品放到了工厂函数的<code>prototype</code>中</p>
<p>这样一来，扩展产品种类就不必修改工厂函数了，和心累就变成抽象类，也可以随时重写某种具体的产品</p>
<p>也就是相当于工厂总部不生产产品了，交给下辖分工厂进行生产；但是进入工厂之前，需要有个判断来验证你要生产的东西是否是属于我们工厂所生产范围，如果是，就丢给下辖工厂来进行生产</p>
<p>如下代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 工厂方法</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Factory</span>(<span class="params">career</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable language_">this</span> <span class="keyword">instanceof</span> <span class="title class_">Factory</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> a = <span class="keyword">new</span> <span class="variable language_">this</span>[career]();</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Factory</span>(career);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 工厂方法函数的原型中设置所有对象的构造函数</span></span><br><span class="line"><span class="title class_">Factory</span>.<span class="property"><span class="keyword">prototype</span></span>=&#123;</span><br><span class="line">    <span class="string">&#x27;coder&#x27;</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">careerName</span> = <span class="string">&#x27;程序员&#x27;</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">work</span> = [<span class="string">&#x27;写代码&#x27;</span>, <span class="string">&#x27;修Bug&#x27;</span>] </span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;hr&#x27;</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">careerName</span> = <span class="string">&#x27;HR&#x27;</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">work</span> = [<span class="string">&#x27;招聘&#x27;</span>, <span class="string">&#x27;员工信息管理&#x27;</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;driver&#x27;</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">careerName</span> = <span class="string">&#x27;司机&#x27;</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">work</span> = [<span class="string">&#x27;开车&#x27;</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;boss&#x27;</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">careerName</span> = <span class="string">&#x27;老板&#x27;</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">work</span> = [<span class="string">&#x27;喝茶&#x27;</span>, <span class="string">&#x27;开会&#x27;</span>, <span class="string">&#x27;审批文件&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> coder = <span class="keyword">new</span> <span class="title class_">Factory</span>(<span class="string">&#x27;coder&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(coder)</span><br><span class="line"><span class="keyword">let</span> hr = <span class="keyword">new</span> <span class="title class_">Factory</span>(<span class="string">&#x27;hr&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(hr)</span><br></pre></td></tr></table></figure>

<p>工厂方法关键核心代码是工厂里面的判断this是否属于工厂，也就是做了分支判断，这个工厂只做我能做的产品</p>
<h3 id="抽象工厂模式"><a href="#抽象工厂模式" class="headerlink" title="抽象工厂模式"></a>抽象工厂模式</h3><p>上述简单工厂模式和工厂方法模式都是直接生成实例，但是抽象工厂模式不同，抽象工厂模式并不直接生成实例， 而是用于对产品类簇的创建</p>
<p>通俗点来讲就是：简单工厂和工厂方法模式的工作是生产产品，那么抽象工厂模式的工作就是生产工厂的</p>
<p>由于<code>JavaScript</code>中并没有抽象类的概念，只能模拟，可以分成四部分：</p>
<ul>
<li>用于创建抽象类的函数</li>
<li>抽象类</li>
<li>具体类</li>
<li>实例化具体类</li>
</ul>
<p>上面的例子中有<code>coder</code>、<code>hr</code>、<code>boss</code>、<code>driver</code>四种岗位，其中<code>coder</code>可能使用不同的开发语言进行开发，比如<code>JavaScript</code>、<code>Java</code>等等。那么这两种语言就是对应的类簇</p>
<p>示例代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="title class_">CareerAbstractFactory</span> = <span class="keyword">function</span>(<span class="params">subType, superType</span>) &#123;</span><br><span class="line">  <span class="comment">// 判断抽象工厂中是否有该抽象类</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="title class_">CareerAbstractFactory</span>[superType] === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// 缓存类</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">F</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">    <span class="comment">// 继承父类属性和方法</span></span><br><span class="line">    F.<span class="property"><span class="keyword">prototype</span></span> = <span class="keyword">new</span> <span class="title class_">CareerAbstractFactory</span>[superType]()</span><br><span class="line">    <span class="comment">// 将子类的constructor指向父类</span></span><br><span class="line">    subType.<span class="property">constructor</span> = subType;</span><br><span class="line">    <span class="comment">// 子类原型继承父类</span></span><br><span class="line">    subType.<span class="property"><span class="keyword">prototype</span></span> = <span class="keyword">new</span> <span class="title function_">F</span>()</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;抽象类不存在&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面代码中<code>CareerAbstractFactory</code>就是一个抽象工厂方法，该方法在参数中传递子类和父类，在方法体内部实现了子类对父类的继承</p>
<h2 id="三、应用场景"><a href="#三、应用场景" class="headerlink" title="三、应用场景"></a>三、应用场景</h2><p>从上面可看到，简单简单工厂的优点就是我们只要传递正确的参数，就能获得所需的对象，而不需要关心其创建的具体细节</p>
<p>应用场景也容易识别，有构造函数的地方，就应该考虑简单工厂，但是如果函数构建函数太多与复杂，会导致工厂函数变得复杂，所以不适合复杂的情况</p>
<p>抽象工厂模式一般用于严格要求以面向对象思想进行开发的超大型项目中，我们一般常规的开发的话一般就是简单工厂和工厂方法模式会用的比较多一些</p>
<p>综上，工厂模式适用场景如下：</p>
<ul>
<li>如果你不想让某个子系统与较大的那个对象之间形成强耦合，而是想运行时从许多子系统中进行挑选的话，那么工厂模式是一个理想的选择</li>
<li>将new操作简单封装，遇到new的时候就应该考虑是否用工厂模式；</li>
<li>需要依赖具体环境创建不同实例，这些实例都有相同的行为,这时候我们可以使用工厂模式，简化实现的过程，同时也可以减少每种对象所需的代码量，有利于消除对象间的耦合，提供更大的灵活性</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-设计模式/发布订阅、观察者模式" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/03/08/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E3%80%81%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/" class="article-date">
  	<time datetime="2019-03-08T07:23:19.000Z" itemprop="datePublished">2019-03-08</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/08/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E3%80%81%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/">
        发布订阅、观察者模式（观察者模式）
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一、观察者模式"><a href="#一、观察者模式" class="headerlink" title="一、观察者模式"></a>一、观察者模式</h2><p>观察者模式定义了对象间的一种一对多的依赖关系，当一个对象的状态发生改变时，所有依赖于它的对象都将得到通知，并自动更新</p>
<p>观察者模式属于行为型模式，行为型模式关注的是对象之间的通讯，观察者模式就是观察者和被观察者之间的通讯</p>
<p><img src="https://static.vue-js.com/d3a80020-3f7c-11ec-a752-75723a64e8f5.png" alt="img"></p>
<p>例如生活中，我们可以用报纸期刊的订阅来形象的说明，当你订阅了一份报纸，每天都会有一份最新的报纸送到你手上，有多少人订阅报纸，报社就会发多少份报纸</p>
<p>报社和订报纸的客户就形成了一对多的依赖关系</p>
<p>实现代码如下：</p>
<p>被观察者模式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Subject</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">observerList</span> = [];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">addObserver</span>(<span class="params">observer</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">observerList</span>.<span class="title function_">push</span>(observer);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">removeObserver</span>(<span class="params">observer</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> index = <span class="variable language_">this</span>.<span class="property">observerList</span>.<span class="title function_">findIndex</span>(<span class="function"><span class="params">o</span> =&gt;</span> o.<span class="property">name</span> === observer.<span class="property">name</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">observerList</span>.<span class="title function_">splice</span>(index, <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">notifyObservers</span>(<span class="params">message</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> observers = <span class="variable language_">this</span>.<span class="property">observeList</span>;</span><br><span class="line">    observers.<span class="title function_">forEach</span>(<span class="function"><span class="params">observer</span> =&gt;</span> observer.<span class="title function_">notified</span>(message));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>观察者：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">class Observer &#123;</span><br><span class="line"></span><br><span class="line">  constructor(name, subject) &#123;</span><br><span class="line">    this.name = name;</span><br><span class="line">    if (subject) &#123;</span><br><span class="line">      subject.addObserver(this);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  notified(message) &#123;</span><br><span class="line">    console.log(this.name, &#x27;got message&#x27;, message);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> subject = <span class="keyword">new</span> <span class="title class_">Subject</span>();</span><br><span class="line"><span class="keyword">const</span> observerA = <span class="keyword">new</span> <span class="title class_">Observer</span>(<span class="string">&#x27;observerA&#x27;</span>, subject);</span><br><span class="line"><span class="keyword">const</span> observerB = <span class="keyword">new</span> <span class="title class_">Observer</span>(<span class="string">&#x27;observerB&#x27;</span>);</span><br><span class="line">subject.<span class="title function_">addObserver</span>(observerB);</span><br><span class="line">subject.<span class="title function_">notifyObservers</span>(<span class="string">&#x27;Hello from subject&#x27;</span>);</span><br><span class="line">subject.<span class="title function_">removeObserver</span>(observerA);</span><br><span class="line">subject.<span class="title function_">notifyObservers</span>(<span class="string">&#x27;Hello again&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>上述代码中，观察者主动申请加入被观察者的列表，被观察者主动将观察者加入列表</p>
<h2 id="二、发布订阅模式"><a href="#二、发布订阅模式" class="headerlink" title="二、发布订阅模式"></a>二、发布订阅模式</h2><p>发布-订阅是一种消息范式，消息的发送者（称为发布者）不会将消息直接发送给特定的接收者（称为订阅者）。而是将发布的消息分为不同的类别，无需了解哪些订阅者（如果有的话）可能存在</p>
<p>同样的，订阅者可以表达对一个或多个类别的兴趣，只接收感兴趣的消息，无需了解哪些发布者存在</p>
<p><img src="https://static.vue-js.com/e24d3cd0-3f7c-11ec-8e64-91fdec0f05a1.png" alt="img"></p>
<p>实现代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PubSub</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">messages</span> = &#123;&#125;;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">listeners</span> = &#123;&#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 添加发布者</span></span><br><span class="line">  <span class="title function_">publish</span>(<span class="params">type, content</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> existContent = <span class="variable language_">this</span>.<span class="property">messages</span>[type];</span><br><span class="line">    <span class="keyword">if</span> (!existContent) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">messages</span>[type] = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">messages</span>[type].<span class="title function_">push</span>(content);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 添加订阅者</span></span><br><span class="line">  <span class="title function_">subscribe</span>(<span class="params">type, cb</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> existListener = <span class="variable language_">this</span>.<span class="property">listeners</span>[type];</span><br><span class="line">    <span class="keyword">if</span> (!existListener) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">listeners</span>[type] = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">listeners</span>[type].<span class="title function_">push</span>(cb);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 通知</span></span><br><span class="line">  <span class="title function_">notify</span>(<span class="params">type</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> messages = <span class="variable language_">this</span>.<span class="property">messages</span>[type];</span><br><span class="line">    <span class="keyword">const</span> subscribers = <span class="variable language_">this</span>.<span class="property">listeners</span>[type] || [];</span><br><span class="line">    subscribers.<span class="title function_">forEach</span>(<span class="function">(<span class="params">cb, index</span>) =&gt;</span> <span class="title function_">cb</span>(messages[index]));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发布者代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Publisher</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name, context</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">context</span> = context;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">publish</span>(<span class="params">type, content</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">context</span>.<span class="title function_">publish</span>(type, content);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>订阅者代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Subscriber</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name, context</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">context</span> = context;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">subscribe</span>(<span class="params">type, cb</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">context</span>.<span class="title function_">subscribe</span>(type, cb);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">TYPE_A</span> = <span class="string">&#x27;music&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">TYPE_B</span> = <span class="string">&#x27;movie&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">TYPE_C</span> = <span class="string">&#x27;novel&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pubsub = <span class="keyword">new</span> <span class="title class_">PubSub</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> publisherA = <span class="keyword">new</span> <span class="title class_">Publisher</span>(<span class="string">&#x27;publisherA&#x27;</span>, pubsub);</span><br><span class="line">publisherA.<span class="title function_">publish</span>(<span class="variable constant_">TYPE_A</span>, <span class="string">&#x27;we are young&#x27;</span>);</span><br><span class="line">publisherA.<span class="title function_">publish</span>(<span class="variable constant_">TYPE_B</span>, <span class="string">&#x27;the silicon valley&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> publisherB = <span class="keyword">new</span> <span class="title class_">Publisher</span>(<span class="string">&#x27;publisherB&#x27;</span>, pubsub);</span><br><span class="line">publisherB.<span class="title function_">publish</span>(<span class="variable constant_">TYPE_A</span>, <span class="string">&#x27;stronger&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> publisherC = <span class="keyword">new</span> <span class="title class_">Publisher</span>(<span class="string">&#x27;publisherC&#x27;</span>, pubsub);</span><br><span class="line">publisherC.<span class="title function_">publish</span>(<span class="variable constant_">TYPE_C</span>, <span class="string">&#x27;a brief history of time&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> subscriberA = <span class="keyword">new</span> <span class="title class_">Subscriber</span>(<span class="string">&#x27;subscriberA&#x27;</span>, pubsub);</span><br><span class="line">subscriberA.<span class="title function_">subscribe</span>(<span class="variable constant_">TYPE_A</span>, <span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;subscriberA received&#x27;</span>, res)</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> subscriberB = <span class="keyword">new</span> <span class="title class_">Subscriber</span>(<span class="string">&#x27;subscriberB&#x27;</span>, pubsub);</span><br><span class="line">subscriberB.<span class="title function_">subscribe</span>(<span class="variable constant_">TYPE_C</span>, <span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;subscriberB received&#x27;</span>, res)</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> subscriberC = <span class="keyword">new</span> <span class="title class_">Subscriber</span>(<span class="string">&#x27;subscriberC&#x27;</span>, pubsub);</span><br><span class="line">subscriberC.<span class="title function_">subscribe</span>(<span class="variable constant_">TYPE_B</span>, <span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;subscriberC received&#x27;</span>, res)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">pubsub.<span class="title function_">notify</span>(<span class="variable constant_">TYPE_A</span>);</span><br><span class="line">pubsub.<span class="title function_">notify</span>(<span class="variable constant_">TYPE_B</span>);</span><br><span class="line">pubsub.<span class="title function_">notify</span>(<span class="variable constant_">TYPE_C</span>);</span><br></pre></td></tr></table></figure>

<p>上述代码，发布者和订阅者需要通过发布订阅中心进行关联，发布者的发布动作和订阅者的订阅动作相互独立，无需关注对方，消息派发由发布订阅中心负责</p>
<h2 id="三、区别"><a href="#三、区别" class="headerlink" title="三、区别"></a>三、区别</h2><p>两种设计模式思路是一样的，举个生活例子：</p>
<ul>
<li>观察者模式：某公司给自己员工发月饼发粽子，是由公司的行政部门发送的，这件事不适合交给第三方，原因是“公司”和“员工”是一个整体</li>
<li>发布-订阅模式：某公司要给其他人发各种快递，因为“公司”和“其他人”是独立的，其唯一的桥梁是“快递”，所以这件事适合交给第三方快递公司解决</li>
</ul>
<p>上述过程中，如果公司自己去管理快递的配送，那公司就会变成一个快递公司，业务繁杂难以管理，影响公司自身的主营业务，因此使用何种模式需要考虑什么情况两者是需要耦合的</p>
<p>两者区别如下图：</p>
<p><img src="https://files.mdnice.com/user/155/9141682c-7386-4f12-8412-fb17a1cd4bf6.png" alt="img"></p>
<ul>
<li>在观察者模式中，观察者是知道Subject的，Subject一直保持对观察者进行记录。然而，在发布订阅模式中，发布者和订阅者不知道对方的存在。它们只有通过消息代理进行通信。</li>
<li>在发布订阅模式中，组件是松散耦合的，正好和观察者模式相反。</li>
<li>观察者模式大多数时候是同步的，比如当事件触发，Subject就会去调用观察者的方法。而发布-订阅模式大多数时候是异步的（使用消息队列）</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-设计模式/单例模式" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/03/03/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/" class="article-date">
  	<time datetime="2019-03-03T02:27:17.000Z" itemprop="datePublished">2019-03-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/03/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/">
        单例模式
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一、是什么"><a href="#一、是什么" class="headerlink" title="一、是什么"></a>一、是什么</h2><p>单例模式（Singleton Pattern）：创建型模式，提供了一种创建对象的最佳方式，这种模式涉及到一个单一的类，该类负责创建自己的对象，同时确保只有单个对象被创建</p>
<p>在应用程序运行期间，单例模式只会在全局作用域下创建一次实例对象，让所有需要调用的地方都共享这一单例对象，如下图所示：</p>
<p><img src="https://static.vue-js.com/fa7898d0-3b2c-11ec-8e64-91fdec0f05a1.png" alt="img"></p>
<p>从定义上来看，全局变量好像就是单例模式，但是一般情况我们不认为全局变量是一个单例模式，原因是：</p>
<ul>
<li>全局命名污染</li>
<li>不易维护，容易被重写覆盖</li>
</ul>
<h2 id="二、实现"><a href="#二、实现" class="headerlink" title="二、实现"></a>二、实现</h2><p>在<code>javascript</code>中，实现一个单例模式可以用一个变量来标志当前的类已经创建过对象，如果下次获取当前类的实例时，直接返回之前创建的对象即可，如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义一个类</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Singleton</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">instance</span> = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 原型扩展类的一个方法getName()</span></span><br><span class="line"><span class="title class_">Singleton</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">getName</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 获取类的实例</span></span><br><span class="line"><span class="title class_">Singleton</span>.<span class="property">getInstance</span> = <span class="keyword">function</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="variable language_">this</span>.<span class="property">instance</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">instance</span> = <span class="keyword">new</span> <span class="title class_">Singleton</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">instance</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取对象1</span></span><br><span class="line"><span class="keyword">const</span> a = <span class="title class_">Singleton</span>.<span class="title function_">getInstance</span>(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="comment">// 获取对象2</span></span><br><span class="line"><span class="keyword">const</span> b = <span class="title class_">Singleton</span>.<span class="title function_">getInstance</span>(<span class="string">&#x27;b&#x27;</span>);</span><br><span class="line"><span class="comment">// 进行比较</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a === b);</span><br></pre></td></tr></table></figure>

<p>使用闭包也能够实现，如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Singleton</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 原型扩展类的一个方法getName()</span></span><br><span class="line"><span class="title class_">Singleton</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">getName</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 获取类的实例</span></span><br><span class="line"><span class="title class_">Singleton</span>.<span class="property">getInstance</span> = (<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> instance = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">name</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable language_">this</span>.<span class="property">instance</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">instance</span> = <span class="keyword">new</span> <span class="title class_">Singleton</span>(name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">instance</span></span><br><span class="line">    &#125;        </span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取对象1</span></span><br><span class="line"><span class="keyword">const</span> a = <span class="title class_">Singleton</span>.<span class="title function_">getInstance</span>(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="comment">// 获取对象2</span></span><br><span class="line"><span class="keyword">const</span> b = <span class="title class_">Singleton</span>.<span class="title function_">getInstance</span>(<span class="string">&#x27;b&#x27;</span>);</span><br><span class="line"><span class="comment">// 进行比较</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a === b);</span><br></pre></td></tr></table></figure>

<p>也可以将上述的方法稍作修改，变成构造函数的形式，如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 单例构造函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">CreateSingleton</span> (name) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">getName</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取实例的名字</span></span><br><span class="line"><span class="title class_">CreateSingleton</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">getName</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 单例对象</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Singleton</span> = (<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> instance;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">name</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!instance) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> <span class="title class_">CreateSingleton</span>(name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建实例对象1</span></span><br><span class="line"><span class="keyword">const</span> a = <span class="keyword">new</span> <span class="title class_">Singleton</span>(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="comment">// 创建实例对象2</span></span><br><span class="line"><span class="keyword">const</span> b = <span class="keyword">new</span> <span class="title class_">Singleton</span>(<span class="string">&#x27;b&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a===b); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<h2 id="三、使用场景"><a href="#三、使用场景" class="headerlink" title="三、使用场景"></a>三、使用场景</h2><p>在前端中，很多情况都是用到单例模式，例如页面存在一个模态框的时候，只有用户点击的时候才会创建，而不是加载完成之后再创建弹窗和隐藏，并且保证弹窗全局只有一个</p>
<p>可以先创建一个通常的获取对象的方法，如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getSingle = <span class="keyword">function</span>(<span class="params"> fn </span>)&#123;</span><br><span class="line">  <span class="keyword">let</span> result;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> result || ( result = fn .<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span> ) );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>

<p>创建弹窗的代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> createLoginLayer = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">var</span> div = <span class="variable language_">document</span>.<span class="title function_">createElement</span>( <span class="string">&#x27;div&#x27;</span> );</span><br><span class="line">  div.<span class="property">innerHTML</span> = <span class="string">&#x27;我是浮窗&#x27;</span>;</span><br><span class="line">  div.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;none&#x27;</span>;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>( div );</span><br><span class="line">  <span class="keyword">return</span> div;</span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> createSingleLoginLayer = <span class="title function_">getSingle</span>( createLoginLayer ); </span><br><span class="line"></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>( <span class="string">&#x27;loginBtn&#x27;</span> ).<span class="property">onclick</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">var</span> loginLayer = <span class="title function_">createSingleLoginLayer</span>();</span><br><span class="line">  loginLayer.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;block&#x27;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>上述这种实现称为惰性单例，意图解决需要时才创建类实例对象</p>
<p>并且<code>Vuex</code>、<code>redux</code>全局态管理库也应用单例模式的思想，如下图：</p>
<p><img src="https://static.vue-js.com/8be50f80-3b2b-11ec-a752-75723a64e8f5.png" alt="img"></p>
<p>现在很多第三方库都是单例模式，多次引用只会使用同一个对象，如<code>jquery</code>、<code>lodash</code>、<code>moment</code>…</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-设计模式/代理模式" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/02/27/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/" class="article-date">
  	<time datetime="2019-02-27T13:18:43.000Z" itemprop="datePublished">2019-02-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/02/27/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/">
        代理模式
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一、是什么"><a href="#一、是什么" class="headerlink" title="一、是什么"></a>一、是什么</h2><p>代理模式（Proxy Pattern）是为一个对象提供一个代用品或占位符，以便控制对它的访问</p>
<p>代理模式的关键是，当客户不方便直接访问一个对象或者不满足需要时，提供一个替身对象来控制这个对象的访问，客户实际上访问的是替身对象</p>
<p><img src="https://static.vue-js.com/951c99b0-3d6a-11ec-a752-75723a64e8f5.png" alt="img"></p>
<p>在生活中，代理模式的场景是十分常见的，例如我们现在如果有租房、买房的需求，更多的是去找链家等房屋中介机构，而不是直接寻找想卖房或出租房的人谈。此时，链家起到的作用就是代理的作用</p>
<h2 id="二、使用"><a href="#二、使用" class="headerlink" title="二、使用"></a>二、使用</h2><p>在<code>ES6</code>中，存在<code>proxy</code>构建函数能够让我们轻松使用代理模式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="title class_">Proxy</span>(target, handler);</span><br></pre></td></tr></table></figure>

<p>1</p>
<p>关于<code>Proxy</code>的使用可以翻看以前的文章</p>
<p>而按照功能来划分，<code>javascript</code>代理模式常用的有：</p>
<ul>
<li>缓存代理</li>
<li>虚拟代理</li>
</ul>
<h3 id="缓存代理"><a href="#缓存代理" class="headerlink" title="缓存代理"></a>缓存代理</h3><p>缓存代理可以为一些开销大的运算结果提供暂时的存储，在下次运算时，如果传递进来的参数跟之前一致，则可以直接返回前面存储的运算结果</p>
<p>如实现一个求积乘的函数，如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> muti = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;开始计算乘积&quot;</span>);</span><br><span class="line">  <span class="keyword">var</span> a = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = <span class="variable language_">arguments</span>.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">    a = a * <span class="variable language_">arguments</span>[i];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> a;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>现在加入缓存代理，如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> proxyMult = (<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> cache = &#123;&#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> args = <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">join</span>.<span class="title function_">call</span>(<span class="variable language_">arguments</span>, <span class="string">&quot;,&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (args <span class="keyword">in</span> cache) &#123;</span><br><span class="line">      <span class="keyword">return</span> cache[args];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (cache[args] = mult.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>));</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="title function_">proxyMult</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>); <span class="comment">// 输出:24</span></span><br><span class="line"><span class="title function_">proxyMult</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>); <span class="comment">// 输出:24</span></span><br></pre></td></tr></table></figure>

<p>当第二次调用 <code>proxyMult(1, 2, 3, 4)</code> 时，本体 <code>mult</code> 函数并没有被计算，<code>proxyMult</code> 直接返回了之前缓存好的计算结果</p>
<h3 id="虚拟代理"><a href="#虚拟代理" class="headerlink" title="虚拟代理"></a>虚拟代理</h3><p>虚拟代理把一些开销很大的对象，延迟到真正需要它的时候才去创建</p>
<p>常见的就是图片预加载功能：</p>
<p>未使用代理模式如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="title class_">MyImage</span> = (<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> imgNode = <span class="variable language_">document</span>.<span class="title function_">createElement</span>( <span class="string">&#x27;img&#x27;</span> );</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>( imgNode );</span><br><span class="line">    <span class="comment">// 创建一个Image对象，用于加载需要设置的图片</span></span><br><span class="line">    <span class="keyword">let</span> img = <span class="keyword">new</span> <span class="title class_">Image</span>;</span><br><span class="line"></span><br><span class="line">    img.<span class="property">onload</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">// 监听到图片加载完成后，设置src为加载完成后的图片</span></span><br><span class="line">        imgNode.<span class="property">src</span> = img.<span class="property">src</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">setSrc</span>: <span class="keyword">function</span>(<span class="params"> src </span>)&#123;</span><br><span class="line">            <span class="comment">// 设置图片的时候，设置为默认的loading图</span></span><br><span class="line">            imgNode.<span class="property">src</span> = <span class="string">&#x27;https://img.zcool.cn/community/01deed576019060000018c1bd2352d.gif&#x27;</span>;</span><br><span class="line">            <span class="comment">// 把真正需要设置的图片传给Image对象的src属性</span></span><br><span class="line">            img.<span class="property">src</span> = src;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="title class_">MyImage</span>.<span class="title function_">setSrc</span>( <span class="string">&#x27;https://xxx.jpg&#x27;</span> );</span><br></pre></td></tr></table></figure>

<p><code>MyImage</code>对象除了负责给<code>img</code>节点设置<code>src</code>外，还要负责预加载图片，违反了面向对象设计的原则——单一职责原则</p>
<p>上述过程<code>loding</code>则是耦合进<code>MyImage</code>对象里的，如果以后某个时候，我们不需要预加载显示loading这个功能了，就只能在<code>MyImage</code>对象里面改动代码</p>
<p>使用代理模式，代码则如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 图片本地对象，负责往页面中创建一个img标签，并且提供一个对外的setSrc接口</span></span><br><span class="line"><span class="keyword">let</span> myImage = (<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> imgNode = <span class="variable language_">document</span>.<span class="title function_">createElement</span>( <span class="string">&#x27;img&#x27;</span> );</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>( imgNode );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="comment">//setSrc接口，外界调用这个接口，便可以给该img标签设置src属性</span></span><br><span class="line">        <span class="attr">setSrc</span>: <span class="keyword">function</span>(<span class="params"> src </span>)&#123;</span><br><span class="line">            imgNode.<span class="property">src</span> = src;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)();</span><br><span class="line"><span class="comment">// 代理对象，负责图片预加载功能</span></span><br><span class="line"><span class="keyword">let</span> proxyImage = (<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">// 创建一个Image对象，用于加载需要设置的图片</span></span><br><span class="line">    <span class="keyword">let</span> img = <span class="keyword">new</span> <span class="title class_">Image</span>;</span><br><span class="line">    img.<span class="property">onload</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">// 监听到图片加载完成后，给被代理的图片本地对象设置src为加载完成后的图片</span></span><br><span class="line">        myImage.<span class="title function_">setSrc</span>( <span class="variable language_">this</span>.<span class="property">src</span> );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">setSrc</span>: <span class="keyword">function</span>(<span class="params"> src </span>)&#123;</span><br><span class="line">            <span class="comment">// 设置图片时，在图片未被真正加载好时，以这张图作为loading，提示用户图片正在加载</span></span><br><span class="line">            myImage.<span class="title function_">setSrc</span>( <span class="string">&#x27;https://img.zcool.cn/community/01deed576019060000018c1bd2352d.gif&#x27;</span> );</span><br><span class="line">            img.<span class="property">src</span> = src;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line">proxyImage.<span class="title function_">setSrc</span>( <span class="string">&#x27;https://xxx.jpg&#x27;</span> );</span><br></pre></td></tr></table></figure>

<p>使用代理模式后，图片本地对象负责往页面中创建一个<code>img</code>标签，并且提供一个对外的<code>setSrc</code>接口；</p>
<p>代理对象负责在图片未加载完成之前，引入预加载的<code>loading</code>图，负责了图片预加载的功能</p>
<p>上述并没有改变或者增加<code>MyImage</code>的接口，但是通过代理对象，实际上给系统添加了新的行为</p>
<p>并且上述代理模式可以发现，代理和本体接口的一致性，如果有一天不需要预加载，那么就不需要代理对象，可以选择直接请求本体。其中关键是代理对象和本体都对外提供了 <code>setSrc</code> 方法</p>
<h2 id="三、应用场景"><a href="#三、应用场景" class="headerlink" title="三、应用场景"></a>三、应用场景</h2><p>现在的很多前端框架或者状态管理框架都使用代理模式，用与监听变量的变化</p>
<p>使用代理模式代理对象的访问的方式，一般又被称为拦截器，比如我们在项目中经常使用 <code>Axios</code> 的实例来进行 HTTP 的请求，使用拦截器 <code>interceptor</code> 可以提前对 请求前的数据 服务器返回的数据进行一些预处理</p>
<p>以及上述应用到的缓存代理和虚拟代理</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/10/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="page-number" href="/page/10/">10</a><span class="page-number current">11</span><a class="page-number" href="/page/12/">12</a><a class="page-number" href="/page/13/">13</a><span class="space">&hellip;</span><a class="page-number" href="/page/25/">25</a><a class="extend next" rel="next" href="/page/12/">Next &amp;raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2022 mr.杜
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/preccrep/hexo-theme-jelly" target="_blank">Jelly</a>
        </div>
    </div>
  </div>
</footer>
    </div>
    
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">



<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: false,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>

<script src="/js/main.js"></script>




  </div>
</body>
</html>